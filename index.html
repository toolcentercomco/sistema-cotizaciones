<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaciones - Tool Center</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2lzdGVtYSBkZSBDb3RpemFjaW9uZXMiLCJzaG9ydF9uYW1lIjoiQ290aXphY2lvbmVzIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXlOQ0F5TkNJK1BIQmhkR2dnWkQwaWJUTWdOQ0JqTXlBd0lEWXRNeUEwTFRNeUlEUklNVTVqTVMwd0lEWWdNeUEwV2cwM0lERXdZeTB3SURZdE15QTBJRE10TVNBd0xUWWdNeUEwV2cwMUlERTJZelF0TXlBd0xUWXRNM0EwYUhvdE5DQXhZaTB3SURZZ015QTBXaTV6ZUhvdE5IQjNiM0prUFhZdFh5NGlJR1pwYkd3OUlpTXlOVFl6WldJaUx6NDhMM04yWno0PSIsInNpemVzIjoiMjR4MjQiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- EmailJS para env√≠o de correos -->
    <script src="https://cdn.emailjs.com/sdk/2.6.4/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #2563eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .online {
            background: #dcfce7;
            color: #166534;
        }

        .offline {
            background: #fef2f2;
            color: #dc2626;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-item {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #2563eb;
        }

        .menu-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .menu-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .menu-description {
            color: #6b7280;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Search and filters */
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #059669;
        }

        .notification.error {
            background: #dc2626;
        }

        .notification.info {
            background: #2563eb;
        }

        .notification.warning {
            background: #d97706;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .menu-item {
                padding: 20px;
            }

            .menu-icon {
                font-size: 36px;
            }

            .modal-content {
                margin: 10px;
                max-height: 95vh;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-input {
                min-width: auto;
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        /* Product grid for quotations */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .product-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .product-card:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
        }

        .product-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            margin: 0 auto 10px;
            display: block;
            background: #f3f4f6;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .qty-btn:hover {
            background: #f3f4f6;
        }

        .qty-input {
            width: 60px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 5px;
        }

        /* Quotation summary */
        .quotation-summary {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .quotation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .quotation-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-details {
            font-size: 14px;
            color: #6b7280;
        }

        .item-total {
            font-weight: 600;
            color: #2563eb;
        }

        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
        }

        .delete-btn:hover {
            background: #b91c1c;
        }

        .total-row {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 2px solid #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo">TC</div>
            <h2>Sistema de Cotizaciones</h2>
            <p style="color: #6b7280; margin-bottom: 30px;">Tool Center - Ibagu√©</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" value="jhernandez" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="btn">Iniciar Sesi√≥n</button>
            </form>
            
            <div style="margin-top: 20px; font-size: 12px; color: #6b7280;">
                Versi√≥n 1.0 | <span id="connectionStatus">Verificando conexi√≥n...</span>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="logo" style="width: 50px; height: 50px; font-size: 16px;">TC</div>
                    <div>
                        <h2>Sistema de Cotizaciones</h2>
                        <p style="color: #6b7280;">Bienvenido, <span id="userName">Jorge Luis Hern√°ndez</span></p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="connectionStatusApp" class="connection-status online">üü¢ En l√≠nea</div>
                    <button class="btn btn-secondary" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="mainMenu" class="menu-grid">
                <div class="menu-item" onclick="openModule('clientes')">
                    <span class="menu-icon">üë•</span>
                    <div class="menu-title">Clientes</div>
                    <div class="menu-description">Gestionar informaci√≥n de clientes</div>
                </div>

                <div class="menu-item" onclick="openModule('productos')">
                    <span class="menu-icon">üì¶</span>
                    <div class="menu-title">Productos</div>
                    <div class="menu-description">Cat√°logo y control de inventario</div>
                </div>

                <div class="menu-item" onclick="openModule('entradas')">
                    <span class="menu-icon">üì•</span>
                    <div class="menu-title">Entradas</div>
                    <div class="menu-description">Registrar entradas y devoluciones</div>
                </div>

                <div class="menu-item" onclick="openModule('cotizaciones')">
                    <span class="menu-icon">üí∞</span>
                    <div class="menu-title">Cotizaciones</div>
                    <div class="menu-description">Crear y gestionar cotizaciones</div>
                </div>

                <div class="menu-item" onclick="openModule('parametros')">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <div class="menu-title">Par√°metros</div>
                    <div class="menu-description">Configuraci√≥n del sistema</div>
                </div>

                <div class="menu-item" onclick="openModule('informes')">
                    <span class="menu-icon">üìä</span>
                    <div class="menu-title">Informes</div>
                    <div class="menu-description">Reportes y estad√≠sticas</div>
                </div>
            </div>

            <!-- Notifications area -->
            <div id="notificationsArea"></div>
        </div>
    </div>

    <!-- Universal Modal -->
    <div id="universalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">T√≠tulo</h3>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <!-- Footer buttons will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ===========================================
        
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://nipwdvnhngdydpclvhco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pcHdkdm5obmdkeWRwY2x2aGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTcxNzcsImV4cCI6MjA3MDk3MzE3N30.nMkXseYCsdh_eCfWBXBYsvzObbXjq4Uj3_sBvq2pF0E';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variables globales
        let currentUser = null;
        let isOnline = navigator.onLine;
        let offlineData = {
            clientes: [],
            productos: [],
            cotizaciones: [],
            pendingSync: []
        };
        
        // Configuraci√≥n EmailJS (necesitar√°s configurar tu cuenta)
        const EMAILJS_SERVICE_ID = 'your_service_id';
        const EMAILJS_TEMPLATE_ID = 'your_template_id';
        const EMAILJS_USER_ID = 'your_user_id';
        
        // Inicializar EmailJS si est√° disponible
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_USER_ID);
        }
        
        // ===========================================
        // INICIALIZACI√ìN
        // ===========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkConnectionStatus();
        });
        
        function initializeApp() {
            // Verificar si hay sesi√≥n guardada
            const savedSession = localStorage.getItem('userSession');
            if (savedSession) {
                currentUser = JSON.parse(savedSession);
                showApp();
            } else {
                showLogin();
            }
            
            // Inicializar IndexedDB para almacenamiento offline
            initializeOfflineStorage();
        }
        
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Connection status
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
            });
            
            // Modal click outside to close
            document.getElementById('universalModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }
        
        // ===========================================
        // AUTENTICACI√ìN
        // ===========================================
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            showNotification('Iniciando sesi√≥n...', 'info');
            
            try {
                if (isOnline) {
                    // Verificar credenciales en la base de datos
                    const { data, error } = await supabase
                        .from('usuarios')
                        .select('*')
                        .eq('username', username)
                        .eq('activo', true)
                        .single();
                    
                    if (error || !data) {
                        showNotification('Usuario o contrase√±a incorrectos', 'error');
                        return;
                    }
                    
                    // En un entorno real, aqu√≠ verificar√≠as el hash de la contrase√±a
                    // Por ahora, usamos comparaci√≥n simple para pruebas
                    if (password !== 'temporal123' && password !== 'Admin2025*') {
                        showNotification('Usuario o contrase√±a incorrectos', 'error');
                        return;
                    }
                    
                    // Actualizar √∫ltimo acceso
                    await supabase
                        .from('usuarios')
                        .update({ ultimo_acceso: new Date().toISOString() })
                        .eq('id', data.id);
                    
                    currentUser = data;
                    localStorage.setItem('userSession', JSON.stringify(data));
                    
                } else {
                    // Modo offline - verificar credenciales b√°sicas
                    if (username === 'jhernandez' && (password === 'temporal123' || password === 'Admin2025*')) {
                        currentUser = { 
                            username: 'jhernandez', 
                            nombre: 'Jorge Luis Hern√°ndez',
                            perfil: 'admin'
                        };
                        localStorage.setItem('userSession', JSON.stringify(currentUser));
                    } else {
                        showNotification('Credenciales incorrectas (modo offline)', 'error');
                        return;
                    }
                }
                
                showNotification('¬°Bienvenido!', 'success');
                showApp();
                
            } catch (error) {
                console.error('Error en login:', error);
                showNotification('Error al iniciar sesi√≥n', 'error');
            }
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('userSession');
            showLogin();
            showNotification('Sesi√≥n cerrada', 'info');
        }
        
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nombre;
            loadInitialData();
        }
        
        // ===========================================
        // GESTI√ìN DE CONEXI√ìN Y SINCRONIZACI√ìN
        // ===========================================
        
        function checkConnectionStatus() {
            updateConnectionStatus();
            
            // Verificar conexi√≥n cada 30 segundos
            setInterval(() => {
                fetch(SUPABASE_URL + '/rest/v1/', { method: 'HEAD' })
                    .then(() => {
                        if (!isOnline) {
                            isOnline = true;
                            updateConnectionStatus();
                            syncOfflineData();
                        }
                    })
                    .catch(() => {
                        if (isOnline) {
                            isOnline = false;
                            updateConnectionStatus();
                        }
                    });
            }, 30000);
        }
        
        function updateConnectionStatus() {
            const statusElements = [
                document.getElementById('connectionStatus'),
                document.getElementById('connectionStatusApp')
            ];
            
            statusElements.forEach(element => {
                if (element) {
                    if (isOnline) {
                        element.textContent = 'üü¢ En l√≠nea';
                        element.className = 'connection-status online';
                    } else {
                        element.textContent = 'üî¥ Sin conexi√≥n';
                        element.className = 'connection-status offline';
                    }
                }
            });
        }
        
        async function syncOfflineData() {
            if (!isOnline) return;
            
            const pendingItems = getPendingSyncItems();
            if (pendingItems.length === 0) return;
            
            showNotification('Sincronizando datos...', 'info');
            
            let syncSuccessCount = 0;
            let syncErrorCount = 0;
            
            for (const item of pendingItems) {
                try {
                    await syncSingleItem(item);
                    syncSuccessCount++;
                    removePendingSyncItem(item.id);
                } catch (error) {
                    console.error('Error sincronizando item:', error);
                    syncErrorCount++;
                }
            }
            
            if (syncSuccessCount > 0) {
                showNotification(`${syncSuccessCount} registros sincronizados exitosamente`, 'success');
            }
            
            if (syncErrorCount > 0) {
                showNotification(`Error al sincronizar ${syncErrorCount} registros`, 'error');
            }
        }
        
        // ===========================================
        // ALMACENAMIENTO OFFLINE (IndexedDB)
        // ===========================================
        
        function initializeOfflineStorage() {
            // Inicializar IndexedDB para almacenamiento offline
            const request = indexedDB.open('CotizacionesDB', 1);
            
            request.onerror = function(event) {
                console.error('Error abriendo IndexedDB:', event);
            };
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                window.offlineDB = db;
                loadOfflineData();
            };
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                
                // Crear stores para cada tabla
                const tables = ['clientes', 'productos', 'cotizaciones', 'entradas', 'zonas', 'sync_queue'];
                
                tables.forEach(tableName => {
                    if (!db.objectStoreNames.contains(tableName)) {
                        const store = db.createObjectStore(tableName, { keyPath: 'id', autoIncrement: true });
                        if (tableName === 'clientes') store.createIndex('nit', 'nit', { unique: true });
                        if (tableName === 'productos') store.createIndex('codigo', 'codigo', { unique: true });
                    }
                });
            };
        }
        
        function saveToOfflineDB(tableName, data) {
            if (!window.offlineDB) return;
            
            const transaction = window.offlineDB.transaction([tableName], 'readwrite');
            const store = transaction.objectStore(tableName);
            
            if (Array.isArray(data)) {
                data.forEach(item => store.put(item));
            } else {
                store.put(data);
            }
        }
        
        function getFromOfflineDB(tableName) {
            return new Promise((resolve, reject) => {
                if (!window.offlineDB) {
                    resolve([]);
                    return;
                }
                
                const transaction = window.offlineDB.transaction([tableName], 'readonly');
                const store = transaction.objectStore(tableName);
                const request = store.getAll();
                
                request.onsuccess = function() {
                    resolve(request.result || []);
                };
                
                request.onerror = function() {
                    reject(request.error);
                };
            });
        }
        
        function addToSyncQueue(action, table, data) {
            const syncItem = {
                id: Date.now() + Math.random(),
                action: action, // 'create', 'update', 'delete'
                table: table,
                data: data,
                timestamp: new Date().toISOString()
            };
            
            saveToOfflineDB('sync_queue', syncItem);
        }
        
        function getPendingSyncItems() {
            return getFromOfflineDB('sync_queue');
        }
        
        function removePendingSyncItem(itemId) {
            if (!window.offlineDB) return;
            
            const transaction = window.offlineDB.transaction(['sync_queue'], 'readwrite');
            const store = transaction.objectStore('sync_queue');
            store.delete(itemId);
        }
        
        async function syncSingleItem(item) {
            const { action, table, data } = item;
            
            switch (action) {
                case 'create':
                    await supabase.from(table).insert(data);
                    break;
                case 'update':
                    await supabase.from(table).update(data).eq('id', data.id);
                    break;
                case 'delete':
                    await supabase.from(table).delete().eq('id', data.id);
                    break;
            }
        }
        
        // ===========================================
        // CARGA DE DATOS INICIALES
        // ===========================================
        
        async function loadInitialData() {
            try {
                if (isOnline) {
                    // Cargar datos desde Supabase
                    await loadOnlineData();
                } else {
                    // Cargar datos desde IndexedDB
                    await loadOfflineData();
                }
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showNotification('Error cargando datos', 'error');
            }
        }
        
        async function loadOnlineData() {
            try {
                // Cargar datos b√°sicos
                const [clientesData, productosData, zonasData] = await Promise.all([
                    supabase.from('clientes').select('*').eq('activo', true),
                    supabase.from('productos').select('*').eq('activo', true),
                    supabase.from('zonas').select('*').eq('activa', true)
                ]);
                
                offlineData.clientes = clientesData.data || [];
                offlineData.productos = productosData.data || [];
                offlineData.zonas = zonasData.data || [];
                
                // Guardar en IndexedDB para uso offline
                saveToOfflineDB('clientes', offlineData.clientes);
                saveToOfflineDB('productos', offlineData.productos);
                saveToOfflineDB('zonas', offlineData.zonas);
                
            } catch (error) {
                console.error('Error cargando datos online:', error);
                // Fallback a datos offline
                await loadOfflineData();
            }
        }
        
        async function loadOfflineData() {
            try {
                offlineData.clientes = await getFromOfflineDB('clientes');
                offlineData.productos = await getFromOfflineDB('productos');
                offlineData.zonas = await getFromOfflineDB('zonas');
                offlineData.cotizaciones = await getFromOfflineDB('cotizaciones');
            } catch (error) {
                console.error('Error cargando datos offline:', error);
            }
        }
        
        // ===========================================
        // GESTI√ìN DE M√ìDULOS
        // ===========================================
        
        function openModule(moduleName) {
            switch (moduleName) {
                case 'clientes':
                    openClientesModule();
                    break;
                case 'productos':
                    openProductosModule();
                    break;
                case 'entradas':
                    openEntradasModule();
                    break;
                case 'cotizaciones':
                    openCotizacionesModule();
                    break;
                case 'parametros':
                    openParametrosModule();
                    break;
                case 'informes':
                    openInformesModule();
                    break;
                default:
                    showNotification('M√≥dulo no implementado', 'warning');
            }
        }
        
        // ===========================================
        // M√ìDULO DE CLIENTES
        // ===========================================
        
        function openClientesModule() {
            const modalContent = `
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Buscar por nombre o NIT..." onkeyup="filterClientes(this.value)">
                    <button class="btn" onclick="showClienteForm()">+ Nuevo Cliente</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>NIT</th>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Tel√©fono</th>
                                <th>Zona</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientesTableBody">
                            ${renderClientesTable()}
                        </tbody>
                    </table>
                </div>
            `;
            
            showModal('Gesti√≥n de Clientes', modalContent, [
                '<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>'
            ]);
        }
        
        function renderClientesTable() {
            return offlineData.clientes.map(cliente => `
                <tr>
                    <td>${cliente.nit}</td>
                    <td>${cliente.nombre}</td>
                    <td>${cliente.correo || '-'}</td>
                    <td>${cliente.tel_celular || '-'}</td>
                    <td>${cliente.zona || '-'}</td>
                    <td>
                        <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="editCliente('${cliente.nit}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteCliente('${cliente.nit}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterClientes(searchTerm) {
            const filteredClientes = offlineData.clientes.filter(cliente => 
                cliente.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cliente.nit.includes(searchTerm)
            );
            
            document.getElementById('clientesTableBody').innerHTML = 
                filteredClientes.map(cliente => `
                    <tr>
                        <td>${cliente.nit}</td>
                        <td>${cliente.nombre}</td>
                        <td>${cliente.correo || '-'}</td>
                        <td>${cliente.tel_celular || '-'}</td>
                        <td>${cliente.zona || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="editCliente('${cliente.nit}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteCliente('${cliente.nit}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
        }
        
        function showClienteForm(nit = null) {
            const isEdit = nit !== null;
            const cliente = isEdit ? offlineData.clientes.find(c => c.nit === nit) : {};
            
            const zonasOptions = offlineData.zonas.map(zona => 
                `<option value="${zona.id}" ${cliente.zona === zona.id ? 'selected' : ''}>${zona.nombre}</option>`
            ).join('');
            
            const formContent = `
                <form id="clienteForm">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="clienteNit">NIT</label>
                            <input type="text" id="clienteNit" value="${cliente.nit || ''}" ${isEdit ? 'readonly' : ''} required>
                        </div>
                        <div class="form-group">
                            <label for="clienteNombre">Nombre</label>
                            <input type="text" id="clienteNombre" value="${cliente.nombre || ''}" required>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="clienteCorreo">Correo</label>
                            <input type="email" id="clienteCorreo" value="${cliente.correo || ''}">
                        </div>
                        <div class="form-group">
                            <label for="clienteZona">Zona</label>
                            <select id="clienteZona">
                                <option value="">Seleccionar zona</option>
                                ${zonasOptions}
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="clienteCelular">Tel√©fono Celular</label>
                            <input type="text" id="clienteCelular" value="${cliente.tel_celular || ''}">
                        </div>
                        <div class="form-group">
                            <label for="clienteFijo">Tel√©fono Fijo</label>
                            <input type="text" id="clienteFijo" value="${cliente.tel_fijo || ''}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="clienteDireccion">Direcci√≥n</label>
                        <textarea id="clienteDireccion" rows="3">${cliente.direccion || ''}</textarea>
                    </div>
                </form>
            `;
            
            showModal(
                isEdit ? 'Editar Cliente' : 'Nuevo Cliente', 
                formContent,
                [
                    `<button class="btn" onclick="saveCliente(${isEdit})">${isEdit ? 'Actualizar' : 'Guardar'}</button>`,
                    '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
                ]
            );
        }
        
        async function saveCliente(isEdit) {
            const form = document.getElementById('clienteForm');
            const formData = new FormData(form);
            
            const clienteData = {
                nit: document.getElementById('clienteNit').value,
                nombre: document.getElementById('clienteNombre').value,
                correo: document.getElementById('clienteCorreo').value,
                zona: document.getElementById('clienteZona').value,
                tel_celular: document.getElementById('clienteCelular').value,
                tel_fijo: document.getElementById('clienteFijo').value,
                direccion: document.getElementById('clienteDireccion').value,
                activo: true
            };
            
            // Validar datos
            if (!clienteData.nit || !clienteData.nombre) {
                showNotification('NIT y nombre son obligatorios', 'error');
                return;
            }
            
            // Verificar duplicados
            if (!isEdit && offlineData.clientes.find(c => c.nit === clienteData.nit)) {
                showNotification('Ya existe un cliente con ese NIT', 'error');
                return;
            }
            
            try {
                if (isOnline) {
                    if (isEdit) {
                        await supabase.from('clientes').update(clienteData).eq('nit', clienteData.nit);
                    } else {
                        await supabase.from('clientes').insert(clienteData);
                    }
                } else {
                    // Guardar para sincronizaci√≥n posterior
                    addToSyncQueue(isEdit ? 'update' : 'create', 'clientes', clienteData);
                }
                
                // Actualizar datos locales
                if (isEdit) {
                    const index = offlineData.clientes.findIndex(c => c.nit === clienteData.nit);
                    offlineData.clientes[index] = clienteData;
                } else {
                    offlineData.clientes.push(clienteData);
                }
                
                saveToOfflineDB('clientes', offlineData.clientes);
                
                showNotification(`Cliente ${isEdit ? 'actualizado' : 'creado'} exitosamente`, 'success');
                closeModal();
                openClientesModule(); // Refrescar la vista
                
            } catch (error) {
                console.error('Error guardando cliente:', error);
                showNotification('Error al guardar cliente', 'error');
            }
        }
        
        async function deleteCliente(nit) {
            if (!confirm('¬øEst√° seguro de eliminar este cliente?')) return;
            
            try {
                if (isOnline) {
                    await supabase.from('clientes').update({ activo: false }).eq('nit', nit);
                } else {
                    addToSyncQueue('update', 'clientes', { nit: nit, activo: false });
                }
                
                // Remover de datos locales
                offlineData.clientes = offlineData.clientes.filter(c => c.nit !== nit);
                saveToOfflineDB('clientes', offlineData.clientes);
                
                showNotification('Cliente eliminado exitosamente', 'success');
                openClientesModule(); // Refrescar la vista
                
            } catch (error) {
                console.error('Error eliminando cliente:', error);
                showNotification('Error al eliminar cliente', 'error');
            }
        }
        
        function editCliente(nit) {
            showClienteForm(nit);
        }
        
        // ===========================================
        // M√ìDULO DE PRODUCTOS
        // ===========================================
        
        function openProductosModule() {
            const modalContent = `
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Buscar por c√≥digo o nombre..." onkeyup="filterProductos(this.value)">
                    <button class="btn" onclick="showProductoForm()">+ Nuevo Producto</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>C√≥digo</th>
                                <th>Nombre</th>
                                <th>Stock Actual</th>
                                <th>Stock M√≠nimo</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productosTableBody">
                            ${renderProductosTable()}
                        </tbody>
                    </table>
                </div>
            `;
            
            showModal('Gesti√≥n de Productos', modalContent, [
                '<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>'
            ]);
        }
        
        function renderProductosTable() {
            return offlineData.productos.map(producto => {
                const stockStatus = producto.stock_actual <= producto.stock_minimo ? '‚ö†Ô∏è Bajo' : '‚úÖ OK';
                const stockColor = producto.stock_actual <= producto.stock_minimo ? 'color: #dc2626;' : 'color: #059669;';
                
                return `
                    <tr>
                        <td>${producto.codigo}</td>
                        <td>${producto.nombre}</td>
                        <td>${producto.stock_actual || 0}</td>
                        <td>${producto.stock_minimo || 5}</td>
                        <td style="${stockColor}">${stockStatus}</td>
                        <td>
                            <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="editProducto('${producto.codigo}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteProducto('${producto.codigo}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterProductos(searchTerm) {
            const filteredProductos = offlineData.productos.filter(producto => 
                producto.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                producto.codigo.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            document.getElementById('productosTableBody').innerHTML = 
                filteredProductos.map(producto => {
                    const stockStatus = producto.stock_actual <= producto.stock_minimo ? '‚ö†Ô∏è Bajo' : '‚úÖ OK';
                    const stockColor = producto.stock_actual <= producto.stock_minimo ? 'color: #dc2626;' : 'color: #059669;';
                    
                    return `
                        <tr>
                            <td>${producto.codigo}</td>
                            <td>${producto.nombre}</td>
                            <td>${producto.stock_actual || 0}</td>
                            <td>${producto.stock_minimo || 5}</td>
                            <td style="${stockColor}">${stockStatus}</td>
                            <td>
                                <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="editProducto('${producto.codigo}')">‚úèÔ∏è</button>
                                <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteProducto('${producto.codigo}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                }).join('');
        }
        
        function showProductoForm(codigo = null) {
            const isEdit = codigo !== null;
            const producto = isEdit ? offlineData.productos.find(p => p.codigo === codigo) : {};
            
            const formContent = `
                <form id="productoForm">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="productoCodigo">C√≥digo</label>
                            <input type="text" id="productoCodigo" value="${producto.codigo || ''}" ${isEdit ? 'readonly' : ''} required>
                        </div>
                        <div class="form-group">
                            <label for="productoNombre">Nombre</label>
                            <input type="text" id="productoNombre" value="${producto.nombre || ''}" required>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="productoStockMinimo">Stock M√≠nimo</label>
                            <input type="number" id="productoStockMinimo" value="${producto.stock_minimo || 5}" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="productoFoto">Foto del Producto</label>
                            <input type="file" id="productoFoto" accept="image/*" onchange="previewImage(this)">
                            <small>M√°ximo 1MB</small>
                        </div>
                    </div>
                    
                    <div id="imagePreview" class="text-center mb-20">
                        ${producto.foto_base64 ? `<img src="${producto.foto_base64}" style="max-width: 200px; max-height: 200px; border-radius: 8px;" alt="Vista previa">` : ''}
                    </div>
                </form>
            `;
            
            showModal(
                isEdit ? 'Editar Producto' : 'Nuevo Producto', 
                formContent,
                [
                    `<button class="btn" onclick="saveProducto(${isEdit})">${isEdit ? 'Actualizar' : 'Guardar'}</button>`,
                    '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
                ]
            );
        }
        
        function previewImage(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Verificar tama√±o (1MB = 1048576 bytes)
            if (file.size > 1048576) {
                showNotification('La imagen debe ser menor a 1MB', 'error');
                input.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').innerHTML = 
                    `<img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 8px;" alt="Vista previa">`;
            };
            reader.readAsDataURL(file);
        }
        
        async function saveProducto(isEdit) {
            const productoData = {
                codigo: document.getElementById('productoCodigo').value,
                nombre: document.getElementById('productoNombre').value,
                stock_minimo: parseInt(document.getElementById('productoStockMinimo').value),
                activo: true
            };
            
            // Validar datos
            if (!productoData.codigo || !productoData.nombre) {
                showNotification('C√≥digo y nombre son obligatorios', 'error');
                return;
            }
            
            // Verificar duplicados
            if (!isEdit && offlineData.productos.find(p => p.codigo === productoData.codigo)) {
                showNotification('Ya existe un producto con ese c√≥digo', 'error');
                return;
            }
            
            // Procesar imagen si se seleccion√≥
            const fileInput = document.getElementById('productoFoto');
            if (fileInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    productoData.foto_base64 = e.target.result;
                    saveProductoData(productoData, isEdit);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                if (isEdit) {
                    const existingProduct = offlineData.productos.find(p => p.codigo === productoData.codigo);
                    productoData.foto_base64 = existingProduct.foto_base64;
                }
                saveProductoData(productoData, isEdit);
            }
        }
        
        async function saveProductoData(productoData, isEdit) {
            try {
                if (!isEdit) {
                    productoData.stock_actual = 0;
                    productoData.fecha_hora_creacion = new Date().toISOString();
                }
                
                if (isOnline) {
                    if (isEdit) {
                        await supabase.from('productos').update(productoData).eq('codigo', productoData.codigo);
                    } else {
                        await supabase.from('productos').insert(productoData);
                    }
                } else {
                    addToSyncQueue(isEdit ? 'update' : 'create', 'productos', productoData);
                }
                
                // Actualizar datos locales
                if (isEdit) {
                    const index = offlineData.productos.findIndex(p => p.codigo === productoData.codigo);
                    offlineData.productos[index] = { ...offlineData.productos[index], ...productoData };
                } else {
                    offlineData.productos.push(productoData);
                }
                
                saveToOfflineDB('productos', offlineData.productos);
                
                showNotification(`Producto ${isEdit ? 'actualizado' : 'creado'} exitosamente`, 'success');
                closeModal();
                openProductosModule();
                
            } catch (error) {
                console.error('Error guardando producto:', error);
                showNotification('Error al guardar producto', 'error');
            }
        }
        
        function editProducto(codigo) {
            showProductoForm(codigo);
        }
        
        async function deleteProducto(codigo) {
            if (!confirm('¬øEst√° seguro de eliminar este producto?')) return;
            
            try {
                if (isOnline) {
                    await supabase.from('productos').update({ activo: false }).eq('codigo', codigo);
                } else {
                    addToSyncQueue('update', 'productos', { codigo: codigo, activo: false });
                }
                
                offlineData.productos = offlineData.productos.filter(p => p.codigo !== codigo);
                saveToOfflineDB('productos', offlineData.productos);
                
                showNotification('Producto eliminado exitosamente', 'success');
                openProductosModule();
                
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showNotification('Error al eliminar producto', 'error');
            }
        }
        
        // ===========================================
        // M√ìDULO DE ENTRADAS
        // ===========================================
        
        function openEntradasModule() {
            const modalContent = `
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Buscar por c√≥digo de producto..." onkeyup="filterEntradas(this.value)">
                    <button class="btn" onclick="showEntradaForm()">+ Nueva Entrada</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Valor Mayor</th>
                                <th>Valor Menor</th>
                                <th>Motivo</th>
                            </tr>
                        </thead>
                        <tbody id="entradasTableBody">
                            ${renderEntradasTable()}
                        </tbody>
                    </table>
                </div>
            `;
            
            showModal('Gesti√≥n de Entradas', modalContent, [
                '<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>'
            ]);
            
            loadEntradas();
        }
        
        async function loadEntradas() {
            try {
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('entradas')
                        .select('*, productos(nombre)')
                        .order('fecha_hora', { ascending: false })
                        .limit(50);
                    
                    if (!error && data) {
                        offlineData.entradas = data;
                        saveToOfflineDB('entradas', data);
                        document.getElementById('entradasTableBody').innerHTML = renderEntradasTable();
                    }
                } else {
                    offlineData.entradas = await getFromOfflineDB('entradas');
                    document.getElementById('entradasTableBody').innerHTML = renderEntradasTable();
                }
            } catch (error) {
                console.error('Error cargando entradas:', error);
            }
        }
        
        function renderEntradasTable() {
            if (!offlineData.entradas || offlineData.entradas.length === 0) {
                return '<tr><td colspan="6" class="text-center">No hay entradas registradas</td></tr>';
            }
            
            return offlineData.entradas.map(entrada => {
                const fecha = new Date(entrada.fecha_hora).toLocaleDateString('es-CO');
                const producto = offlineData.productos.find(p => p.codigo === entrada.codigo_producto);
                const nombreProducto = producto ? producto.nombre : entrada.codigo_producto;
                
                return `
                    <tr>
                        <td>${fecha}</td>
                        <td>${nombreProducto}</td>
                        <td>${entrada.cantidad}</td>
                        <td>${formatNumber(entrada.valor_mayor)}</td>
                        <td>${formatNumber(entrada.valor_menor)}</td>
                        <td><span style="color: ${entrada.motivo === 'entrada' ? '#059669' : '#d97706'};">${entrada.motivo}</span></td>
                    </tr>
                `;
            }).join('');
        }
        
        function showEntradaForm() {
            const productosOptions = offlineData.productos.map(producto => 
                `<option value="${producto.codigo}">${producto.codigo} - ${producto.nombre}</option>`
            ).join('');
            
            const formContent = `
                <form id="entradaForm">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="entradaProducto">Producto</label>
                            <select id="entradaProducto" required onchange="loadLastPrices()">
                                <option value="">Seleccionar producto</option>
                                ${productosOptions}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="entradaMotivo">Motivo</label>
                            <select id="entradaMotivo" required onchange="loadLastPrices()">
                                <option value="">Seleccionar motivo</option>
                                <option value="entrada">Entrada</option>
                                <option value="devolucion">Devoluci√≥n</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="entradaValorMayor">Valor Unitario Mayor</label>
                            <input type="number" id="entradaValorMayor" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="entradaValorMenor">Valor Unitario Menor</label>
                            <input type="number" id="entradaValorMenor" step="0.01" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="entradaCantidad">Cantidad</label>
                        <input type="number" id="entradaCantidad" min="1" required>
                    </div>
                </form>
            `;
            
            showModal('Nueva Entrada', formContent, [
                '<button class="btn" onclick="saveEntrada()">Guardar</button>',
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
            ]);
        }
        
        async function loadLastPrices() {
            const producto = document.getElementById('entradaProducto').value;
            const motivo = document.getElementById('entradaMotivo').value;
            
            if (producto && motivo === 'devolucion') {
                try {
                    let lastEntry = null;
                    
                    if (isOnline) {
                        const { data } = await supabase
                            .from('entradas')
                            .select('valor_mayor, valor_menor')
                            .eq('codigo_producto', producto)
                            .order('fecha_hora', { ascending: false })
                            .limit(1);
                        
                        lastEntry = data && data.length > 0 ? data[0] : null;
                    } else {
                        const entradas = await getFromOfflineDB('entradas');
                        const productEntries = entradas
                            .filter(e => e.codigo_producto === producto)
                            .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                        
                        lastEntry = productEntries.length > 0 ? productEntries[0] : null;
                    }
                    
                    if (lastEntry) {
                        document.getElementById('entradaValorMayor').value = lastEntry.valor_mayor;
                        document.getElementById('entradaValorMenor').value = lastEntry.valor_menor;
                    }
                } catch (error) {
                    console.error('Error cargando √∫ltimos precios:', error);
                }
            }
        }
        
        async function saveEntrada() {
            const entradaData = {
                codigo_producto: document.getElementById('entradaProducto').value,
                valor_mayor: parseFloat(document.getElementById('entradaValorMayor').value),
                valor_menor: parseFloat(document.getElementById('entradaValorMenor').value),
                cantidad: parseInt(document.getElementById('entradaCantidad').value),
                motivo: document.getElementById('entradaMotivo').value,
                fecha_hora: new Date().toISOString()
            };
            
            // Validar datos
            if (!entradaData.codigo_producto || !entradaData.motivo || !entradaData.cantidad) {
                showNotification('Todos los campos son obligatorios', 'error');
                return;
            }
            
            try {
                if (isOnline) {
                    await supabase.from('entradas').insert(entradaData);
                    
                    // Actualizar stock del producto autom√°ticamente (trigger en BD)
                } else {
                    addToSyncQueue('create', 'entradas', entradaData);
                    
                    // Actualizar stock localmente
                    const producto = offlineData.productos.find(p => p.codigo === entradaData.codigo_producto);
                    if (producto) {
                        producto.stock_actual = (producto.stock_actual || 0) + entradaData.cantidad;
                        saveToOfflineDB('productos', offlineData.productos);
                    }
                }
                
                showNotification('Entrada registrada exitosamente', 'success');
                closeModal();
                openEntradasModule();
                
            } catch (error) {
                console.error('Error guardando entrada:', error);
                showNotification('Error al guardar entrada', 'error');
            }
        }
        
        // ===========================================
        // M√ìDULO DE COTIZACIONES
        // ===========================================
        
        function openCotizacionesModule() {
            const modalContent = `
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Buscar por cliente o consecutivo..." onkeyup="filterCotizaciones(this.value)">
                    <button class="btn" onclick="showNuevaCotizacion()">+ Nueva Cotizaci√≥n</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-secondary" onclick="filterCotizacionesByEstado('all')" style="margin-right: 10px;">Todas</button>
                    <button class="btn btn-secondary" onclick="filterCotizacionesByEstado('Pendiente')" style="margin-right: 10px;">Pendientes</button>
                    <button class="btn btn-secondary" onclick="filterCotizacionesByEstado('Enviada')" style="margin-right: 10px;">Enviadas</button>
                    <button class="btn btn-success" onclick="filterCotizacionesByEstado('Vendida')" style="margin-right: 10px;">Vendidas</button>
                    <button class="btn btn-danger" onclick="filterCotizacionesByEstado('Anulada')">Anuladas</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Consecutivo</th>
                                <th>Cliente</th>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="cotizacionesTableBody">
                            ${renderCotizacionesTable()}
                        </tbody>
                    </table>
                </div>
            `;
            
            showModal('Gesti√≥n de Cotizaciones', modalContent, [
                '<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>'
            ]);
            
            loadCotizaciones();
        }
        
        async function loadCotizaciones() {
            try {
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('cotizaciones')
                        .select('*')
                        .order('fecha_hora', { ascending: false });
                    
                    if (!error && data) {
                        offlineData.cotizaciones = data;
                        saveToOfflineDB('cotizaciones', data);
                        document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable();
                    }
                } else {
                    offlineData.cotizaciones = await getFromOfflineDB('cotizaciones');
                    document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable();
                }
            } catch (error) {
                console.error('Error cargando cotizaciones:', error);
            }
        }
        
        function renderCotizacionesTable(cotizaciones = null) {
            const data = cotizaciones || offlineData.cotizaciones || [];
            
            if (data.length === 0) {
                return '<tr><td colspan="6" class="text-center">No hay cotizaciones registradas</td></tr>';
            }
            
            return data.map(cotizacion => {
                const fecha = new Date(cotizacion.fecha_hora).toLocaleDateString('es-CO');
            const fechaVencimiento = new Date(cotizacion.fecha_vencimiento).toLocaleDateString('es-CO');
            
            const detallesHtml = detalles.map(item => `
                <tr>
                    <td>${item.nombre_producto}</td>
                    <td>${item.cantidad}</td>
                    <td>${formatNumber(item.valor_unitario)}</td>
                    <td>${formatNumber(item.subtotal)}</td>
                </tr>
            `).join('');
            
            const cotizacionContent = `
                <div class="grid-2">
                    <div>
                        <h4>Informaci√≥n General</h4>
                        <p><strong>Consecutivo:</strong> ${cotizacion.consecutivo}</p>
                        <p><strong>Cliente:</strong> ${cotizacion.nombre_cliente}</p>
                        <p><strong>NIT:</strong> ${cotizacion.nit_cliente}</p>
                        <p><strong>Zona:</strong> ${cotizacion.zona_cliente || 'No asignada'}</p>
                    </div>
                    <div>
                        <h4>Fechas y Estado</h4>
                        <p><strong>Fecha:</strong> ${fecha}</p>
                        <p><strong>Vencimiento:</strong> ${fechaVencimiento}</p>
                        <p><strong>Estado:</strong> <span style="color: ${getEstadoColor(cotizacion.estado)}; font-weight: 600;">${cotizacion.estado}</span></p>
                        <p><strong>Total:</strong> ${formatNumber(cotizacion.total)}</p>
                    </div>
                </div>
                
                <h4 style="margin-top: 20px;">Detalle de Productos</h4>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unit.</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${detallesHtml}
                        </tbody>
                    </table>
                </div>
            `;
            
            const buttons = [];
            
            if (cotizacion.estado === 'Pendiente') {
                buttons.push('<button class="btn" onclick="enviarCotizacion(' + idCotizacion + ')">üìß Enviar por Correo</button>');
                buttons.push('<button class="btn btn-secondary" onclick="editCotizacion(' + idCotizacion + ')">‚úèÔ∏è Editar</button>');
            }
            
            if (cotizacion.estado === 'Enviada') {
                buttons.push('<button class="btn" onclick="enviarCotizacion(' + idCotizacion + ')">üìß Reenviar</button>');
                buttons.push('<button class="btn btn-success" onclick="confirmarVenta(' + idCotizacion + ')">‚úÖ Confirmar Venta</button>');
            }
            
            if (cotizacion.estado !== 'Vendida' && cotizacion.estado !== 'Anulada') {
                buttons.push('<button class="btn btn-danger" onclick="anularCotizacion(' + idCotizacion + ')">‚ùå Anular</button>');
            }
            
            buttons.push('<button class="btn btn-secondary" onclick="generatePDF(' + idCotizacion + ')">üìÑ Generar PDF</button>');
            buttons.push('<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>');
            
            showModal(`Cotizaci√≥n ${cotizacion.consecutivo}`, cotizacionContent, buttons);
        }
        
        async function enviarCotizacion(idCotizacion) {
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return;
            
            const cliente = offlineData.clientes.find(c => c.nit === cotizacion.nit_cliente);
            if (!cliente || !cliente.correo) {
                showNotification('El cliente no tiene correo registrado', 'error');
                return;
            }
            
            try {
                showNotification('Generando y enviando cotizaci√≥n...', 'info');
                
                // Generar PDF
                const pdfBase64 = await generatePDFData(idCotizacion);
                
                // Enviar correo usando EmailJS
                const templateParams = {
                    to_email: cliente.correo,
                    cc_email: 'toolcenter.com.co@gmail.com',
                    cliente_nombre: cliente.nombre,
                    cotizacion_consecutivo: cotizacion.consecutivo,
                    cotizacion_total: formatNumber(cotizacion.total),
                    pdf_attachment: pdfBase64
                };
                
                if (typeof emailjs !== 'undefined' && EMAILJS_SERVICE_ID !== 'your_service_id') {
                    await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                    
                    // Actualizar estado a Enviada
                    cotizacion.estado = 'Enviada';
                    
                    if (isOnline) {
                        await supabase
                            .from('cotizaciones')
                            .update({ estado: 'Enviada' })
                            .eq('id_cotizacion', idCotizacion);
                    } else {
                        addToSyncQueue('update', 'cotizaciones', { id_cotizacion: idCotizacion, estado: 'Enviada' });
                    }
                    
                    saveToOfflineDB('cotizaciones', offlineData.cotizaciones);
                    showNotification('Cotizaci√≥n enviada exitosamente', 'success');
                    closeModal();
                    openCotizacionesModule();
                    
                } else {
                    // Fallback: descargar PDF
                    downloadPDF(pdfBase64, `cotizacion_${cotizacion.consecutivo}.pdf`);
                    showNotification('PDF generado. Configura EmailJS para env√≠o autom√°tico.', 'warning');
                }
                
            } catch (error) {
                console.error('Error enviando cotizaci√≥n:', error);
                showNotification('Error al enviar cotizaci√≥n', 'error');
            }
        }
        
        async function confirmarVenta(idCotizacion) {
            if (!confirm('¬øConfirmar esta cotizaci√≥n como venta? Esto descontar√° el inventario.')) return;
            
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return;
            
            try {
                // Cargar detalles de la cotizaci√≥n
                let detalles = [];
                if (isOnline) {
                    const { data } = await supabase
                        .from('cotizacion_detalle')
                        .select('*')
                        .eq('id_cotizacion', idCotizacion);
                    detalles = data || [];
                } else {
                    detalles = await getFromOfflineDB('cotizacion_detalle');
                    detalles = detalles.filter(d => d.id_cotizacion === idCotizacion);
                }
                
                // Verificar stock disponible
                for (const detalle of detalles) {
                    const producto = offlineData.productos.find(p => p.codigo === detalle.codigo_producto);
                    if (!producto || producto.stock_actual < detalle.cantidad) {
                        showNotification(`Stock insuficiente para ${detalle.nombre_producto}`, 'error');
                        return;
                    }
                }
                
                // Descontar stock
                for (const detalle of detalles) {
                    const producto = offlineData.productos.find(p => p.codigo === detalle.codigo_producto);
                    producto.stock_actual -= detalle.cantidad;
                    
                    if (isOnline) {
                        await supabase
                            .from('productos')
                            .update({ stock_actual: producto.stock_actual })
                            .eq('codigo', producto.codigo);
                    } else {
                        addToSyncQueue('update', 'productos', { 
                            codigo: producto.codigo, 
                            stock_actual: producto.stock_actual 
                        });
                    }
                }
                
                // Actualizar estado de cotizaci√≥n
                cotizacion.estado = 'Vendida';
                
                if (isOnline) {
                    await supabase
                        .from('cotizaciones')
                        .update({ estado: 'Vendida' })
                        .eq('id_cotizacion', idCotizacion);
                } else {
                    addToSyncQueue('update', 'cotizaciones', { id_cotizacion: idCotizacion, estado: 'Vendida' });
                }
                
                saveToOfflineDB('cotizaciones', offlineData.cotizaciones);
                saveToOfflineDB('productos', offlineData.productos);
                
                showNotification('Venta confirmada exitosamente', 'success');
                closeModal();
                openCotizacionesModule();
                
            } catch (error) {
                console.error('Error confirmando venta:', error);
                showNotification('Error al confirmar venta', 'error');
            }
        }
        
        async function anularCotizacion(idCotizacion) {
            const motivo = prompt('Ingrese el motivo de anulaci√≥n:');
            if (!motivo) return;
            
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return;
            
            try {
                cotizacion.estado = 'Anulada';
                cotizacion.motivo_anulacion = motivo;
                
                if (isOnline) {
                    await supabase
                        .from('cotizaciones')
                        .update({ estado: 'Anulada', motivo_anulacion: motivo })
                        .eq('id_cotizacion', idCotizacion);
                } else {
                    addToSyncQueue('update', 'cotizaciones', { 
                        id_cotizacion: idCotizacion, 
                        estado: 'Anulada', 
                        motivo_anulacion: motivo 
                    });
                }
                
                saveToOfflineDB('cotizaciones', offlineData.cotizaciones);
                
                showNotification('Cotizaci√≥n anulada', 'success');
                closeModal();
                openCotizacionesModule();
                
            } catch (error) {
                console.error('Error anulando cotizaci√≥n:', error);
                showNotification('Error al anular cotizaci√≥n', 'error');
            }
        }
        
        // ===========================================
        // GENERACI√ìN DE PDF
        // ===========================================
        
        async function generatePDF(idCotizacion) {
            const pdfBase64 = await generatePDFData(idCotizacion);
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            const filename = `cotizacion_${cotizacion.nombre_cliente.replace(/\s+/g, '_')}_${cotizacion.consecutivo}.pdf`;
            
            downloadPDF(pdfBase64, filename);
        }
        
        async function generatePDFData(idCotizacion) {
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return null;
            
            // Cargar detalles
            let detalles = [];
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('cotizacion_detalle')
                        .select('*')
                        .eq('id_cotizacion', idCotizacion);
                    detalles = data || [];
                } else {
                    detalles = await getFromOfflineDB('cotizacion_detalle');
                    detalles = detalles.filter(d => d.id_cotizacion === idCotizacion);
                }
            } catch (error) {
                console.error('Error cargando detalles para PDF:', error);
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configurar fuente
            doc.setFont('Arial', 'normal');
            doc.setFontSize(11);
            
            // Encabezado con logo (centrado)
            doc.setFontSize(16);
            doc.setFont('Arial', 'bold');
            doc.text('TOOL CENTER', 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.setFont('Arial', 'normal');
            doc.text('Ibagu√©, ' + new Date(cotizacion.fecha_hora).toLocaleDateString('es-CO'), 105, 30, { align: 'center' });
            
            // Informaci√≥n del cliente
            doc.setFont('Arial', 'bold');
            doc.text('Se√±or/a ' + cotizacion.nombre_cliente, 20, 50);
            doc.setFont('Arial', 'normal');
            doc.text('Cordial saludo', 20, 60);
            doc.text('Anexo cotizaci√≥n seg√∫n lista', 20, 75);
            
            // Tabla de productos
            let yPosition = 90;
            
            // Encabezados de tabla
            doc.setFont('Arial', 'bold');
            doc.text('Producto', 20, yPosition);
            doc.text('Cantidad', 100, yPosition);
            doc.text('Valor Unit.', 130, yPosition);
            doc.text('Subtotal', 170, yPosition);
            
            doc.line(20, yPosition + 2, 190, yPosition + 2);
            yPosition += 10;
            
            doc.setFont('Arial', 'normal');
            
            // Detalles de productos
            detalles.forEach(item => {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.text(item.nombre_producto, 20, yPosition);
                doc.text(item.cantidad.toString(), 100, yPosition);
                doc.text('.fecha_hora).toLocaleDateString('es-CO');
                const estadoColor = getEstadoColor(cotizacion.estado);
                
                return `
                    <tr>
                        <td>${cotizacion.consecutivo}</td>
                        <td>${cotizacion.nombre_cliente}</td>
                        <td>${fecha}</td>
                        <td>${formatNumber(cotizacion.total)}</td>
                        <td><span style="color: ${estadoColor}; font-weight: 600;">${cotizacion.estado}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="verCotizacion(${cotizacion.id_cotizacion})">üëÅÔ∏è</button>
                            ${cotizacion.estado === 'Pendiente' ? `<button class="btn" style="margin-right: 5px; padding: 5px 10px;" onclick="editCotizacion(${cotizacion.id_cotizacion})">‚úèÔ∏è</button>` : ''}
                            ${cotizacion.estado === 'Enviada' ? `<button class="btn btn-success" style="margin-right: 5px; padding: 5px 10px;" onclick="confirmarVenta(${cotizacion.id_cotizacion})">‚úÖ</button>` : ''}
                            ${cotizacion.estado !== 'Vendida' ? `<button class="btn btn-danger" style="padding: 5px 10px;" onclick="anularCotizacion(${cotizacion.id_cotizacion})">‚ùå</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getEstadoColor(estado) {
            switch (estado) {
                case 'Pendiente': return '#d97706';
                case 'Enviada': return '#2563eb';
                case 'Vendida': return '#059669';
                case 'Anulada': return '#dc2626';
                default: return '#6b7280';
            }
        }
        
        function filterCotizaciones(searchTerm) {
            const filtered = offlineData.cotizaciones.filter(cot => 
                cot.nombre_cliente.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cot.consecutivo.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function filterCotizacionesByEstado(estado) {
            const filtered = estado === 'all' 
                ? offlineData.cotizaciones 
                : offlineData.cotizaciones.filter(cot => cot.estado === estado);
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function showNuevaCotizacion() {
            currentCotizacion = {
                items: [],
                cliente: null,
                total: 0
            };
            
            const clientesOptions = offlineData.clientes.map(cliente => 
                `<option value="${cliente.nit}" data-nombre="${cliente.nombre}" data-zona="${cliente.zona}">${cliente.nombre} (${cliente.nit})</option>`
            ).join('');
            
            const formContent = `
                <div class="form-group">
                    <label for="cotizacionCliente">Cliente</label>
                    <select id="cotizacionCliente" required onchange="selectCliente()">
                        <option value="">Seleccionar cliente</option>
                        ${clientesOptions}
                    </select>
                </div>
                
                <div id="clienteInfo" class="hidden" style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Informaci√≥n del Cliente</h4>
                    <p id="clienteDetalles"></p>
                </div>
                
                <div class="form-group">
                    <label>Productos</label>
                    <input type="text" placeholder="Buscar productos..." onkeyup="filterProductosGrid(this.value)" style="margin-bottom: 15px;">
                </div>
                
                <div class="product-grid" id="productosGrid">
                    ${renderProductosGrid()}
                </div>
                
                <div id="cotizacionSummary" class="quotation-summary hidden">
                    <h4>Resumen de Cotizaci√≥n</h4>
                    <div id="cotizacionItems"></div>
                    <div class="total-row">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total:</span>
                            <span id="cotizacionTotal">$0</span>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('Nueva Cotizaci√≥n', formContent, [
                '<button class="btn" onclick="saveCotizacion()" id="saveCotizacionBtn" disabled>Guardar Cotizaci√≥n</button>',
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
            ]);
        }
        
        let currentCotizacion = {
            items: [],
            cliente: null,
            total: 0
        };
        
        function selectCliente() {
            const select = document.getElementById('cotizacionCliente');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                currentCotizacion.cliente = {
                    nit: selectedOption.value,
                    nombre: selectedOption.dataset.nombre,
                    zona: selectedOption.dataset.zona
                };
                
                document.getElementById('clienteInfo').classList.remove('hidden');
                document.getElementById('clienteDetalles').innerHTML = `
                    <strong>${currentCotizacion.cliente.nombre}</strong><br>
                    NIT: ${currentCotizacion.cliente.nit}<br>
                    Zona: ${currentCotizacion.cliente.zona || 'No asignada'}
                `;
                
                updateSaveCotizacionButton();
            } else {
                currentCotizacion.cliente = null;
                document.getElementById('clienteInfo').classList.add('hidden');
                updateSaveCotizacionButton();
            }
        }
        
        function renderProductosGrid() {
            return offlineData.productos.map(producto => `
                <div class="product-card" data-codigo="${producto.codigo}">
                    <img src="${producto.foto_base64 || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAxNkg1NlY0OEgyNFYxNloiIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjQwIiBjeT0iMzIiIHI9IjQiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
                          class="product-image" alt="${producto.nombre}">
                    <div style="font-weight: 600; margin-bottom: 5px;">${producto.nombre}</div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">${producto.codigo}</div>
                    <div style="color: #6b7280; font-size: 12px;">Stock: ${producto.stock_actual || 0}</div>
                    <div class="quantity-controls hidden">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', -1)">-</button>
                        <input type="number" class="qty-input" value="1" min="1" onchange="updateQuantity('${producto.codigo}', this.value)">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', 1)">+</button>
                        <button class="btn" style="margin-left: 10px; padding: 5px 10px;" onclick="addToQuotation('${producto.codigo}')">Agregar</button>
                    </div>
                </div>
            `).join('');
        }
        
        function filterProductosGrid(searchTerm) {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const nombre = card.querySelector('div').textContent.toLowerCase();
                const codigo = card.dataset.codigo.toLowerCase();
                
                if (nombre.includes(searchTerm.toLowerCase()) || codigo.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function selectProduct(codigo) {
            // Deseleccionar todos los productos
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.quantity-controls').classList.add('hidden');
            });
            
            // Seleccionar el producto actual
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            card.classList.add('selected');
            card.querySelector('.quantity-controls').classList.remove('hidden');
        }
        
        // Agregar event listeners a las tarjetas de productos
        document.addEventListener('click', function(e) {
            if (e.target.closest('.product-card') && !e.target.closest('.quantity-controls')) {
                const card = e.target.closest('.product-card');
                const codigo = card.dataset.codigo;
                selectProduct(codigo);
            }
        });
        
        function changeQuantity(codigo, delta) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            const newValue = Math.max(1, parseInt(input.value) + delta);
            input.value = newValue;
        }
        
        function updateQuantity(codigo, value) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            input.value = Math.max(1, parseInt(value));
        }
        
        async function addToQuotation(codigo) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const quantity = parseInt(card.querySelector('.qty-input').value);
            const producto = offlineData.productos.find(p => p.codigo === codigo);
            
            if (!producto) return;
            
            // Obtener √∫ltimos precios del producto
            let valorMayor = 0, valorMenor = 0;
            
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('entradas')
                        .select('valor_mayor, valor_menor')
                        .eq('codigo_producto', codigo)
                        .order('fecha_hora', { ascending: false })
                        .limit(1);
                    
                    if (data && data.length > 0) {
                        valorMayor = data[0].valor_mayor;
                        valorMenor = data[0].valor_menor;
                    }
                } else {
                    const entradas = await getFromOfflineDB('entradas');
                    const productEntries = entradas
                        .filter(e => e.codigo_producto === codigo)
                        .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                    
                    if (productEntries.length > 0) {
                        valorMayor = productEntries[0].valor_mayor;
                        valorMenor = productEntries[0].valor_menor;
                    }
                }
            } catch (error) {
                console.error('Error obteniendo precios:', error);
            }
            
            if (valorMayor === 0 || valorMenor === 0) {
                showNotification('No se encontraron precios para este producto. Registre una entrada primero.', 'warning');
                return;
            }
            
            // Calcular precio seg√∫n cantidad (>= 6 usa precio mayor, < 6 usa precio menor)
            const cantidadMayorista = 6; // Esto deber√≠a venir de par√°metros
            const precioUnitario = quantity >= cantidadMayorista ? valorMayor : valorMenor;
            const subtotal = quantity * precioUnitario;
            
            // Verificar si el producto ya est√° en la cotizaci√≥n
            const existingIndex = currentCotizacion.items.findIndex(item => item.codigo === codigo);
            
            if (existingIndex >= 0) {
                // Actualizar cantidad existente
                currentCotizacion.items[existingIndex].cantidad += quantity;
                currentCotizacion.items[existingIndex].subtotal = 
                    currentCotizacion.items[existingIndex].cantidad * 
                    (currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor);
                currentCotizacion.items[existingIndex].valor_unitario = 
                    currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor;
            } else {
                // Agregar nuevo item
                currentCotizacion.items.push({
                    codigo: codigo,
                    nombre: producto.nombre,
                    cantidad: quantity,
                    valor_unitario: precioUnitario,
                    subtotal: subtotal,
                    tipo_precio: quantity >= cantidadMayorista ? 'mayor' : 'menor'
                });
            }
            
            updateCotizacionSummary();
            showNotification(`${producto.nombre} agregado a la cotizaci√≥n`, 'success');
            
            // Limpiar selecci√≥n
            card.classList.remove('selected');
            card.querySelector('.quantity-controls').classList.add('hidden');
            card.querySelector('.qty-input').value = 1;
        }
        
        function updateCotizacionSummary() {
            const summaryDiv = document.getElementById('cotizacionSummary');
            const itemsDiv = document.getElementById('cotizacionItems');
            const totalSpan = document.getElementById('cotizacionTotal');
            
            if (currentCotizacion.items.length === 0) {
                summaryDiv.classList.add('hidden');
                updateSaveCotizacionButton();
                return;
            }
            
            summaryDiv.classList.remove('hidden');
            
            itemsDiv.innerHTML = currentCotizacion.items.map((item, index) => `
                <div class="quotation-item">
                    <div class="item-info">
                        <div class="item-name">${item.nombre}</div>
                        <div class="item-details">
                            Cantidad: ${item.cantidad} | 
                            Precio: ${formatNumber(item.valor_unitario)} (${item.tipo_precio})
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="item-total">${formatNumber(item.subtotal)}</div>
                        <button class="delete-btn" onclick="removeFromQuotation(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            currentCotizacion.total = currentCotizacion.items.reduce((sum, item) => sum + item.subtotal, 0);
            totalSpan.textContent = `${formatNumber(currentCotizacion.total)}`;
            
            updateSaveCotizacionButton();
        }
        
        function removeFromQuotation(index) {
            currentCotizacion.items.splice(index, 1);
            updateCotizacionSummary();
        }
        
        function updateSaveCotizacionButton() {
            const btn = document.getElementById('saveCotizacionBtn');
            btn.disabled = !currentCotizacion.cliente || currentCotizacion.items.length === 0;
        }
        
        async function saveCotizacion() {
            if (!currentCotizacion.cliente || currentCotizacion.items.length === 0) {
                showNotification('Seleccione un cliente y agregue productos', 'error');
                return;
            }
            
            try {
                // Generar consecutivo
                const a√±o = new Date().getFullYear();
                let consecutivo;
                
                if (isOnline) {
                    const { data } = await supabase.rpc('generar_consecutivo_cotizacion', { a√±o_param: a√±o });
                    consecutivo = data;
                } else {
                    // Generar consecutivo offline (simplificado)
                    const cotizacionesA√±o = offlineData.cotizaciones.filter(c => 
                        new Date(c.fecha_hora).getFullYear() === a√±o
                    );
                    const nextNumber = cotizacionesA√±o.length + 1;
                    consecutivo = `COT-${a√±o}-${nextNumber.toString().padStart(3, '0')}`;
                }
                
                const cotizacionData = {
                    consecutivo: consecutivo,
                    nit_cliente: currentCotizacion.cliente.nit,
                    nombre_cliente: currentCotizacion.cliente.nombre,
                    zona_cliente: currentCotizacion.cliente.zona,
                    fecha_hora: new Date().toISOString(),
                    fecha_vencimiento: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 d√≠as
                    subtotal: currentCotizacion.total,
                    total: currentCotizacion.total,
                    estado: 'Pendiente',
                    usuario_creacion: currentUser.username
                };
                
                let cotizacionId;
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('cotizaciones')
                        .insert(cotizacionData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    cotizacionId = data.id_cotizacion;
                    
                    // Insertar detalles
                    const detalles = currentCotizacion.items.map(item => ({
                        id_cotizacion: cotizacionId,
                        codigo_producto: item.codigo,
                        nombre_producto: item.nombre,
                        cantidad: item.cantidad,
                        valor_unitario: item.valor_unitario,
                        subtotal: item.subtotal,
                        tipo_precio: item.tipo_precio
                    }));
                    
                    await supabase.from('cotizacion_detalle').insert(detalles);
                    
                } else {
                    cotizacionId = Date.now();
                    cotizacionData.id_cotizacion = cotizacionId;
                    addToSyncQueue('create', 'cotizaciones', cotizacionData);
                    
                    // Guardar detalles para sincronizaci√≥n
                    currentCotizacion.items.forEach(item => {
                        addToSyncQueue('create', 'cotizacion_detalle', {
                            id_cotizacion: cotizacionId,
                            codigo_producto: item.codigo,
                            nombre_producto: item.nombre,
                            cantidad: item.cantidad,
                            valor_unitario: item.valor_unitario,
                            subtotal: item.subtotal,
                            tipo_precio: item.tipo_precio
                        });
                    });
                }
                
                // Agregar a datos locales
                cotizacionData.id_cotizacion = cotizacionId;
                offlineData.cotizaciones.push(cotizacionData);
                saveToOfflineDB('cotizaciones', offlineData.cotizaciones);
                
                showNotification(`Cotizaci√≥n ${consecutivo} creada exitosamente`, 'success');
                closeModal();
                openCotizacionesModule();
                
            } catch (error) {
                console.error('Error guardando cotizaci√≥n:', error);
                showNotification('Error al guardar cotizaci√≥n', 'error');
            }
        }
        
        // ===========================================
        // FUNCIONES DE COTIZACIONES (CONTINUAR)
        // ===========================================
        
        async function verCotizacion(idCotizacion) {
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return;
            
            // Cargar detalles
            let detalles = [];
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('cotizacion_detalle')
                        .select('*')
                        .eq('id_cotizacion', idCotizacion);
                    detalles = data || [];
                } else {
                    // Cargar detalles desde offline (simplificado)
                    detalles = await getFromOfflineDB('cotizacion_detalle');
                    detalles = detalles.filter(d => d.id_cotizacion === idCotizacion);
                }
            } catch (error) {
                console.error('Error cargando detalles:', error);
            }
            
            const fecha = new Date(cotizacion + formatNumber(item.valor_unitario), 130, yPosition);
                doc.text('.fecha_hora).toLocaleDateString('es-CO');
                const estadoColor = getEstadoColor(cotizacion.estado);
                
                return `
                    <tr>
                        <td>${cotizacion.consecutivo}</td>
                        <td>${cotizacion.nombre_cliente}</td>
                        <td>${fecha}</td>
                        <td>${formatNumber(cotizacion.total)}</td>
                        <td><span style="color: ${estadoColor}; font-weight: 600;">${cotizacion.estado}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="verCotizacion(${cotizacion.id_cotizacion})">üëÅÔ∏è</button>
                            ${cotizacion.estado === 'Pendiente' ? `<button class="btn" style="margin-right: 5px; padding: 5px 10px;" onclick="editCotizacion(${cotizacion.id_cotizacion})">‚úèÔ∏è</button>` : ''}
                            ${cotizacion.estado === 'Enviada' ? `<button class="btn btn-success" style="margin-right: 5px; padding: 5px 10px;" onclick="confirmarVenta(${cotizacion.id_cotizacion})">‚úÖ</button>` : ''}
                            ${cotizacion.estado !== 'Vendida' ? `<button class="btn btn-danger" style="padding: 5px 10px;" onclick="anularCotizacion(${cotizacion.id_cotizacion})">‚ùå</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getEstadoColor(estado) {
            switch (estado) {
                case 'Pendiente': return '#d97706';
                case 'Enviada': return '#2563eb';
                case 'Vendida': return '#059669';
                case 'Anulada': return '#dc2626';
                default: return '#6b7280';
            }
        }
        
        function filterCotizaciones(searchTerm) {
            const filtered = offlineData.cotizaciones.filter(cot => 
                cot.nombre_cliente.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cot.consecutivo.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function filterCotizacionesByEstado(estado) {
            const filtered = estado === 'all' 
                ? offlineData.cotizaciones 
                : offlineData.cotizaciones.filter(cot => cot.estado === estado);
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function showNuevaCotizacion() {
            currentCotizacion = {
                items: [],
                cliente: null,
                total: 0
            };
            
            const clientesOptions = offlineData.clientes.map(cliente => 
                `<option value="${cliente.nit}" data-nombre="${cliente.nombre}" data-zona="${cliente.zona}">${cliente.nombre} (${cliente.nit})</option>`
            ).join('');
            
            const formContent = `
                <div class="form-group">
                    <label for="cotizacionCliente">Cliente</label>
                    <select id="cotizacionCliente" required onchange="selectCliente()">
                        <option value="">Seleccionar cliente</option>
                        ${clientesOptions}
                    </select>
                </div>
                
                <div id="clienteInfo" class="hidden" style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Informaci√≥n del Cliente</h4>
                    <p id="clienteDetalles"></p>
                </div>
                
                <div class="form-group">
                    <label>Productos</label>
                    <input type="text" placeholder="Buscar productos..." onkeyup="filterProductosGrid(this.value)" style="margin-bottom: 15px;">
                </div>
                
                <div class="product-grid" id="productosGrid">
                    ${renderProductosGrid()}
                </div>
                
                <div id="cotizacionSummary" class="quotation-summary hidden">
                    <h4>Resumen de Cotizaci√≥n</h4>
                    <div id="cotizacionItems"></div>
                    <div class="total-row">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total:</span>
                            <span id="cotizacionTotal">$0</span>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('Nueva Cotizaci√≥n', formContent, [
                '<button class="btn" onclick="saveCotizacion()" id="saveCotizacionBtn" disabled>Guardar Cotizaci√≥n</button>',
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
            ]);
        }
        
        let currentCotizacion = {
            items: [],
            cliente: null,
            total: 0
        };
        
        function selectCliente() {
            const select = document.getElementById('cotizacionCliente');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                currentCotizacion.cliente = {
                    nit: selectedOption.value,
                    nombre: selectedOption.dataset.nombre,
                    zona: selectedOption.dataset.zona
                };
                
                document.getElementById('clienteInfo').classList.remove('hidden');
                document.getElementById('clienteDetalles').innerHTML = `
                    <strong>${currentCotizacion.cliente.nombre}</strong><br>
                    NIT: ${currentCotizacion.cliente.nit}<br>
                    Zona: ${currentCotizacion.cliente.zona || 'No asignada'}
                `;
                
                updateSaveCotizacionButton();
            } else {
                currentCotizacion.cliente = null;
                document.getElementById('clienteInfo').classList.add('hidden');
                updateSaveCotizacionButton();
            }
        }
        
        function renderProductosGrid() {
            return offlineData.productos.map(producto => `
                <div class="product-card" data-codigo="${producto.codigo}">
                    <img src="${producto.foto_base64 || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAxNkg1NlY0OEgyNFYxNloiIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjQwIiBjeT0iMzIiIHI9IjQiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
                          class="product-image" alt="${producto.nombre}">
                    <div style="font-weight: 600; margin-bottom: 5px;">${producto.nombre}</div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">${producto.codigo}</div>
                    <div style="color: #6b7280; font-size: 12px;">Stock: ${producto.stock_actual || 0}</div>
                    <div class="quantity-controls hidden">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', -1)">-</button>
                        <input type="number" class="qty-input" value="1" min="1" onchange="updateQuantity('${producto.codigo}', this.value)">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', 1)">+</button>
                        <button class="btn" style="margin-left: 10px; padding: 5px 10px;" onclick="addToQuotation('${producto.codigo}')">Agregar</button>
                    </div>
                </div>
            `).join('');
        }
        
        function filterProductosGrid(searchTerm) {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const nombre = card.querySelector('div').textContent.toLowerCase();
                const codigo = card.dataset.codigo.toLowerCase();
                
                if (nombre.includes(searchTerm.toLowerCase()) || codigo.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function selectProduct(codigo) {
            // Deseleccionar todos los productos
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.quantity-controls').classList.add('hidden');
            });
            
            // Seleccionar el producto actual
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            card.classList.add('selected');
            card.querySelector('.quantity-controls').classList.remove('hidden');
        }
        
        // Agregar event listeners a las tarjetas de productos
        document.addEventListener('click', function(e) {
            if (e.target.closest('.product-card') && !e.target.closest('.quantity-controls')) {
                const card = e.target.closest('.product-card');
                const codigo = card.dataset.codigo;
                selectProduct(codigo);
            }
        });
        
        function changeQuantity(codigo, delta) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            const newValue = Math.max(1, parseInt(input.value) + delta);
            input.value = newValue;
        }
        
        function updateQuantity(codigo, value) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            input.value = Math.max(1, parseInt(value));
        }
        
        async function addToQuotation(codigo) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const quantity = parseInt(card.querySelector('.qty-input').value);
            const producto = offlineData.productos.find(p => p.codigo === codigo);
            
            if (!producto) return;
            
            // Obtener √∫ltimos precios del producto
            let valorMayor = 0, valorMenor = 0;
            
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('entradas')
                        .select('valor_mayor, valor_menor')
                        .eq('codigo_producto', codigo)
                        .order('fecha_hora', { ascending: false })
                        .limit(1);
                    
                    if (data && data.length > 0) {
                        valorMayor = data[0].valor_mayor;
                        valorMenor = data[0].valor_menor;
                    }
                } else {
                    const entradas = await getFromOfflineDB('entradas');
                    const productEntries = entradas
                        .filter(e => e.codigo_producto === codigo)
                        .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                    
                    if (productEntries.length > 0) {
                        valorMayor = productEntries[0].valor_mayor;
                        valorMenor = productEntries[0].valor_menor;
                    }
                }
            } catch (error) {
                console.error('Error obteniendo precios:', error);
            }
            
            if (valorMayor === 0 || valorMenor === 0) {
                showNotification('No se encontraron precios para este producto. Registre una entrada primero.', 'warning');
                return;
            }
            
            // Calcular precio seg√∫n cantidad (>= 6 usa precio mayor, < 6 usa precio menor)
            const cantidadMayorista = 6; // Esto deber√≠a venir de par√°metros
            const precioUnitario = quantity >= cantidadMayorista ? valorMayor : valorMenor;
            const subtotal = quantity * precioUnitario;
            
            // Verificar si el producto ya est√° en la cotizaci√≥n
            const existingIndex = currentCotizacion.items.findIndex(item => item.codigo === codigo);
            
            if (existingIndex >= 0) {
                // Actualizar cantidad existente
                currentCotizacion.items[existingIndex].cantidad += quantity;
                currentCotizacion.items[existingIndex].subtotal = 
                    currentCotizacion.items[existingIndex].cantidad * 
                    (currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor);
                currentCotizacion.items[existingIndex].valor_unitario = 
                    currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor;
            } else {
                // Agregar nuevo item
                currentCotizacion.items.push({
                    codigo: codigo,
                    nombre: producto.nombre,
                    cantidad: quantity,
                    valor_unitario: precioUnitario,
                    subtotal: subtotal,
                    tipo_precio: quantity >= cantidadMayorista ? 'mayor' : 'menor'
                });
            }
            
            updateCotizacionSummary();
            showNotification(`${producto.nombre} agregado a la cotizaci√≥n`, 'success');
            
            // Limpiar selecci√≥n
            card.classList.remove('selected');
            card.querySelector('.quantity-controls').classList.add('hidden');
            card.querySelector('.qty-input').value = 1;
        }
        
        function updateCotizacionSummary() {
            const summaryDiv = document.getElementById('cotizacionSummary');
            const itemsDiv = document.getElementById('cotizacionItems');
            const totalSpan = document.getElementById('cotizacionTotal');
            
            if (currentCotizacion.items.length === 0) {
                summaryDiv.classList.add('hidden');
                updateSaveCotizacionButton();
                return;
            }
            
            summaryDiv.classList.remove('hidden');
            
            itemsDiv.innerHTML = currentCotizacion.items.map((item, index) => `
                <div class="quotation-item">
                    <div class="item-info">
                        <div class="item-name">${item.nombre}</div>
                        <div class="item-details">
                            Cantidad: ${item.cantidad} | 
                            Precio: ${formatNumber(item.valor_unitario)} (${item.tipo_precio})
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="item-total">${formatNumber(item.subtotal)}</div>
                        <button class="delete-btn" onclick="removeFromQuotation(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            currentCotizacion.total = currentCotizacion.items.reduce((sum, item) => sum + item.subtotal, 0);
            totalSpan.textContent = `${formatNumber(currentCotizacion.total)}`;
            
            updateSaveCotizacionButton();
        }
        
        function removeFromQuotation(index) {
            currentCotizacion.items.splice(index, 1);
            updateCotizacionSummary();
        }
        
        function updateSaveCotizacionButton() {
            const btn = document.getElementById('saveCotizacionBtn');
            btn.disabled = !currentCotizacion.cliente || currentCotizacion.items.length === 0;
        }
        
        async function saveCotizacion() {
            if (!currentCotizacion.cliente || currentCotizacion.items.length === 0) {
                showNotification('Seleccione un cliente y agregue productos', 'error');
                return;
            }
            
            try {
                // Generar consecutivo
                const a√±o = new Date().getFullYear();
                let consecutivo;
                
                if (isOnline) {
                    const { data } = await supabase.rpc('generar_consecutivo_cotizacion', { a√±o_param: a√±o });
                    consecutivo = data;
                } else {
                    // Generar consecutivo offline (simplificado)
                    const cotizacionesA√±o = offlineData.cotizaciones.filter(c => 
                        new Date(c.fecha_hora).getFullYear() === a√±o
                    );
                    const nextNumber = cotizacionesA√±o.length + 1;
                    consecutivo = `COT-${a√±o}-${nextNumber.toString().padStart(3, '0')}`;
                }
                
                const cotizacionData = {
                    consecutivo: consecutivo,
                    nit_cliente: currentCotizacion.cliente.nit,
                    nombre_cliente: currentCotizacion.cliente.nombre,
                    zona_cliente: currentCotizacion.cliente.zona,
                    fecha_hora: new Date().toISOString(),
                    fecha_vencimiento: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 d√≠as
                    subtotal: currentCotizacion.total,
                    total: currentCotizacion.total,
                    estado: 'Pendiente',
                    usuario_creacion: currentUser.username
                };
                
                let cotizacionId;
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('cotizaciones')
                        .insert(cotizacionData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    cotizacionId = data.id_cotizacion;
                    
                    // Insertar detalles
                    const detalles = currentCotizacion.items.map(item => ({
                        id_cotizacion: cotizacionId,
                        codigo_producto: item.codigo,
                        nombre_producto: item.nombre,
                        cantidad: item.cantidad,
                        valor_unitario: item.valor_unitario,
                        subtotal: item.subtotal,
                        tipo_precio: item.tipo_precio
                    }));
                    
                    await supabase.from('cotizacion_detalle').insert(detalles);
                    
                } else {
                    cotizacionId = Date.now();
                    cotizacionData.id_cotizacion = cotizacionId;
                    addToSyncQueue('create', 'cotizaciones', cotizacionData);
                    
                    // Guardar detalles para sincronizaci√≥n
                    currentCotizacion.items.forEach(item => {
                        addToSyncQueue('create', 'cotizacion_detalle', {
                            id_cotizacion: cotizacionId,
                            codigo_producto: item.codigo,
                            nombre_producto: item.nombre,
                            cantidad: item.cantidad,
                            valor_unitario: item.valor_unitario,
                            subtotal: item.subtotal,
                            tipo_precio: item.tipo_precio
                        });
                    });
                }
                
                // Agregar a datos locales
                cotizacionData.id_cotizacion = cotizacionId;
                offlineData.cotizaciones.push(cotizacionData);
                saveToOfflineDB('cotizaciones', offlineData.cotizaciones);
                
                showNotification(`Cotizaci√≥n ${consecutivo} creada exitosamente`, 'success');
                closeModal();
                openCotizacionesModule();
                
            } catch (error) {
                console.error('Error guardando cotizaci√≥n:', error);
                showNotification('Error al guardar cotizaci√≥n', 'error');
            }
        }
        
        // ===========================================
        // FUNCIONES DE COTIZACIONES (CONTINUAR)
        // ===========================================
        
        async function verCotizacion(idCotizacion) {
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return;
            
            // Cargar detalles
            let detalles = [];
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('cotizacion_detalle')
                        .select('*')
                        .eq('id_cotizacion', idCotizacion);
                    detalles = data || [];
                } else {
                    // Cargar detalles desde offline (simplificado)
                    detalles = await getFromOfflineDB('cotizacion_detalle');
                    detalles = detalles.filter(d => d.id_cotizacion === idCotizacion);
                }
            } catch (error) {
                console.error('Error cargando detalles:', error);
            }
            
            const fecha = new Date(cotizacion + formatNumber(item.subtotal), 170, yPosition);
                
                yPosition += 8;
            });
            
            // Total
            yPosition += 10;
            doc.line(130, yPosition, 190, yPosition);
            yPosition += 10;
            
            doc.setFont('Arial', 'bold');
            doc.text('Total: .fecha_hora).toLocaleDateString('es-CO');
                const estadoColor = getEstadoColor(cotizacion.estado);
                
                return `
                    <tr>
                        <td>${cotizacion.consecutivo}</td>
                        <td>${cotizacion.nombre_cliente}</td>
                        <td>${fecha}</td>
                        <td>${formatNumber(cotizacion.total)}</td>
                        <td><span style="color: ${estadoColor}; font-weight: 600;">${cotizacion.estado}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="verCotizacion(${cotizacion.id_cotizacion})">üëÅÔ∏è</button>
                            ${cotizacion.estado === 'Pendiente' ? `<button class="btn" style="margin-right: 5px; padding: 5px 10px;" onclick="editCotizacion(${cotizacion.id_cotizacion})">‚úèÔ∏è</button>` : ''}
                            ${cotizacion.estado === 'Enviada' ? `<button class="btn btn-success" style="margin-right: 5px; padding: 5px 10px;" onclick="confirmarVenta(${cotizacion.id_cotizacion})">‚úÖ</button>` : ''}
                            ${cotizacion.estado !== 'Vendida' ? `<button class="btn btn-danger" style="padding: 5px 10px;" onclick="anularCotizacion(${cotizacion.id_cotizacion})">‚ùå</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getEstadoColor(estado) {
            switch (estado) {
                case 'Pendiente': return '#d97706';
                case 'Enviada': return '#2563eb';
                case 'Vendida': return '#059669';
                case 'Anulada': return '#dc2626';
                default: return '#6b7280';
            }
        }
        
        function filterCotizaciones(searchTerm) {
            const filtered = offlineData.cotizaciones.filter(cot => 
                cot.nombre_cliente.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cot.consecutivo.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function filterCotizacionesByEstado(estado) {
            const filtered = estado === 'all' 
                ? offlineData.cotizaciones 
                : offlineData.cotizaciones.filter(cot => cot.estado === estado);
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function showNuevaCotizacion() {
            currentCotizacion = {
                items: [],
                cliente: null,
                total: 0
            };
            
            const clientesOptions = offlineData.clientes.map(cliente => 
                `<option value="${cliente.nit}" data-nombre="${cliente.nombre}" data-zona="${cliente.zona}">${cliente.nombre} (${cliente.nit})</option>`
            ).join('');
            
            const formContent = `
                <div class="form-group">
                    <label for="cotizacionCliente">Cliente</label>
                    <select id="cotizacionCliente" required onchange="selectCliente()">
                        <option value="">Seleccionar cliente</option>
                        ${clientesOptions}
                    </select>
                </div>
                
                <div id="clienteInfo" class="hidden" style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Informaci√≥n del Cliente</h4>
                    <p id="clienteDetalles"></p>
                </div>
                
                <div class="form-group">
                    <label>Productos</label>
                    <input type="text" placeholder="Buscar productos..." onkeyup="filterProductosGrid(this.value)" style="margin-bottom: 15px;">
                </div>
                
                <div class="product-grid" id="productosGrid">
                    ${renderProductosGrid()}
                </div>
                
                <div id="cotizacionSummary" class="quotation-summary hidden">
                    <h4>Resumen de Cotizaci√≥n</h4>
                    <div id="cotizacionItems"></div>
                    <div class="total-row">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total:</span>
                            <span id="cotizacionTotal">$0</span>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('Nueva Cotizaci√≥n', formContent, [
                '<button class="btn" onclick="saveCotizacion()" id="saveCotizacionBtn" disabled>Guardar Cotizaci√≥n</button>',
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
            ]);
        }
        
        let currentCotizacion = {
            items: [],
            cliente: null,
            total: 0
        };
        
        function selectCliente() {
            const select = document.getElementById('cotizacionCliente');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                currentCotizacion.cliente = {
                    nit: selectedOption.value,
                    nombre: selectedOption.dataset.nombre,
                    zona: selectedOption.dataset.zona
                };
                
                document.getElementById('clienteInfo').classList.remove('hidden');
                document.getElementById('clienteDetalles').innerHTML = `
                    <strong>${currentCotizacion.cliente.nombre}</strong><br>
                    NIT: ${currentCotizacion.cliente.nit}<br>
                    Zona: ${currentCotizacion.cliente.zona || 'No asignada'}
                `;
                
                updateSaveCotizacionButton();
            } else {
                currentCotizacion.cliente = null;
                document.getElementById('clienteInfo').classList.add('hidden');
                updateSaveCotizacionButton();
            }
        }
        
        function renderProductosGrid() {
            return offlineData.productos.map(producto => `
                <div class="product-card" data-codigo="${producto.codigo}">
                    <img src="${producto.foto_base64 || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAxNkg1NlY0OEgyNFYxNloiIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjQwIiBjeT0iMzIiIHI9IjQiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
                          class="product-image" alt="${producto.nombre}">
                    <div style="font-weight: 600; margin-bottom: 5px;">${producto.nombre}</div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">${producto.codigo}</div>
                    <div style="color: #6b7280; font-size: 12px;">Stock: ${producto.stock_actual || 0}</div>
                    <div class="quantity-controls hidden">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', -1)">-</button>
                        <input type="number" class="qty-input" value="1" min="1" onchange="updateQuantity('${producto.codigo}', this.value)">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', 1)">+</button>
                        <button class="btn" style="margin-left: 10px; padding: 5px 10px;" onclick="addToQuotation('${producto.codigo}')">Agregar</button>
                    </div>
                </div>
            `).join('');
        }
        
        function filterProductosGrid(searchTerm) {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const nombre = card.querySelector('div').textContent.toLowerCase();
                const codigo = card.dataset.codigo.toLowerCase();
                
                if (nombre.includes(searchTerm.toLowerCase()) || codigo.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function selectProduct(codigo) {
            // Deseleccionar todos los productos
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.quantity-controls').classList.add('hidden');
            });
            
            // Seleccionar el producto actual
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            card.classList.add('selected');
            card.querySelector('.quantity-controls').classList.remove('hidden');
        }
        
        // Agregar event listeners a las tarjetas de productos
        document.addEventListener('click', function(e) {
            if (e.target.closest('.product-card') && !e.target.closest('.quantity-controls')) {
                const card = e.target.closest('.product-card');
                const codigo = card.dataset.codigo;
                selectProduct(codigo);
            }
        });
        
        function changeQuantity(codigo, delta) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            const newValue = Math.max(1, parseInt(input.value) + delta);
            input.value = newValue;
        }
        
        function updateQuantity(codigo, value) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            input.value = Math.max(1, parseInt(value));
        }
        
        async function addToQuotation(codigo) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const quantity = parseInt(card.querySelector('.qty-input').value);
            const producto = offlineData.productos.find(p => p.codigo === codigo);
            
            if (!producto) return;
            
            // Obtener √∫ltimos precios del producto
            let valorMayor = 0, valorMenor = 0;
            
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('entradas')
                        .select('valor_mayor, valor_menor')
                        .eq('codigo_producto', codigo)
                        .order('fecha_hora', { ascending: false })
                        .limit(1);
                    
                    if (data && data.length > 0) {
                        valorMayor = data[0].valor_mayor;
                        valorMenor = data[0].valor_menor;
                    }
                } else {
                    const entradas = await getFromOfflineDB('entradas');
                    const productEntries = entradas
                        .filter(e => e.codigo_producto === codigo)
                        .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                    
                    if (productEntries.length > 0) {
                        valorMayor = productEntries[0].valor_mayor;
                        valorMenor = productEntries[0].valor_menor;
                    }
                }
            } catch (error) {
                console.error('Error obteniendo precios:', error);
            }
            
            if (valorMayor === 0 || valorMenor === 0) {
                showNotification('No se encontraron precios para este producto. Registre una entrada primero.', 'warning');
                return;
            }
            
            // Calcular precio seg√∫n cantidad (>= 6 usa precio mayor, < 6 usa precio menor)
            const cantidadMayorista = 6; // Esto deber√≠a venir de par√°metros
            const precioUnitario = quantity >= cantidadMayorista ? valorMayor : valorMenor;
            const subtotal = quantity * precioUnitario;
            
            // Verificar si el producto ya est√° en la cotizaci√≥n
            const existingIndex = currentCotizacion.items.findIndex(item => item.codigo === codigo);
            
            if (existingIndex >= 0) {
                // Actualizar cantidad existente
                currentCotizacion.items[existingIndex].cantidad += quantity;
                currentCotizacion.items[existingIndex].subtotal = 
                    currentCotizacion.items[existingIndex].cantidad * 
                    (currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor);
                currentCotizacion.items[existingIndex].valor_unitario = 
                    currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor;
            } else {
                // Agregar nuevo item
                currentCotizacion.items.push({
                    codigo: codigo,
                    nombre: producto.nombre,
                    cantidad: quantity,
                    valor_unitario: precioUnitario,
                    subtotal: subtotal,
                    tipo_precio: quantity >= cantidadMayorista ? 'mayor' : 'menor'
                });
            }
            
            updateCotizacionSummary();
            showNotification(`${producto.nombre} agregado a la cotizaci√≥n`, 'success');
            
            // Limpiar selecci√≥n
            card.classList.remove('selected');
            card.querySelector('.quantity-controls').classList.add('hidden');
            card.querySelector('.qty-input').value = 1;
        }
        
        function updateCotizacionSummary() {
            const summaryDiv = document.getElementById('cotizacionSummary');
            const itemsDiv = document.getElementById('cotizacionItems');
            const totalSpan = document.getElementById('cotizacionTotal');
            
            if (currentCotizacion.items.length === 0) {
                summaryDiv.classList.add('hidden');
                updateSaveCotizacionButton();
                return;
            }
            
            summaryDiv.classList.remove('hidden');
            
            itemsDiv.innerHTML = currentCotizacion.items.map((item, index) => `
                <div class="quotation-item">
                    <div class="item-info">
                        <div class="item-name">${item.nombre}</div>
                        <div class="item-details">
                            Cantidad: ${item.cantidad} | 
                            Precio: ${formatNumber(item.valor_unitario)} (${item.tipo_precio})
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="item-total">${formatNumber(item.subtotal)}</div>
                        <button class="delete-btn" onclick="removeFromQuotation(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            currentCotizacion.total = currentCotizacion.items.reduce((sum, item) => sum + item.subtotal, 0);
            totalSpan.textContent = `${formatNumber(currentCotizacion.total)}`;
            
            updateSaveCotizacionButton();
        }
        
        function removeFromQuotation(index) {
            currentCotizacion.items.splice(index, 1);
            updateCotizacionSummary();
        }
        
        function updateSaveCotizacionButton() {
            const btn = document.getElementById('saveCotizacionBtn');
            btn.disabled = !currentCotizacion.cliente || currentCotizacion.items.length === 0;
        }
        
        async function saveCotizacion() {
            if (!currentCotizacion.cliente || currentCotizacion.items.length === 0) {
                showNotification('Seleccione un cliente y agregue productos', 'error');
                return;
            }
            
            try {
                // Generar consecutivo
                const a√±o = new Date().getFullYear();
                let consecutivo;
                
                if (isOnline) {
                    const { data } = await supabase.rpc('generar_consecutivo_cotizacion', { a√±o_param: a√±o });
                    consecutivo = data;
                } else {
                    // Generar consecutivo offline (simplificado)
                    const cotizacionesA√±o = offlineData.cotizaciones.filter(c => 
                        new Date(c.fecha_hora).getFullYear() === a√±o
                    );
                    const nextNumber = cotizacionesA√±o.length + 1;
                    consecutivo = `COT-${a√±o}-${nextNumber.toString().padStart(3, '0')}`;
                }
                
                const cotizacionData = {
                    consecutivo: consecutivo,
                    nit_cliente: currentCotizacion.cliente.nit,
                    nombre_cliente: currentCotizacion.cliente.nombre,
                    zona_cliente: currentCotizacion.cliente.zona,
                    fecha_hora: new Date().toISOString(),
                    fecha_vencimiento: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 d√≠as
                    subtotal: currentCotizacion.total,
                    total: currentCotizacion.total,
                    estado: 'Pendiente',
                    usuario_creacion: currentUser.username
                };
                
                let cotizacionId;
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('cotizaciones')
                        .insert(cotizacionData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    cotizacionId = data.id_cotizacion;
                    
                    // Insertar detalles
                    const detalles = currentCotizacion.items.map(item => ({
                        id_cotizacion: cotizacionId,
                        codigo_producto: item.codigo,
                        nombre_producto: item.nombre,
                        cantidad: item.cantidad,
                        valor_unitario: item.valor_unitario,
                        subtotal: item.subtotal,
                        tipo_precio: item.tipo_precio
                    }));
                    
                    await supabase.from('cotizacion_detalle').insert(detalles);
                    
                } else {
                    cotizacionId = Date.now();
                    cotizacionData.id_cotizacion = cotizacionId;
                    addToSyncQueue('create', 'cotizaciones', cotizacionData);
                    
                    // Guardar detalles para sincronizaci√≥n
                    currentCotizacion.items.forEach(item => {
                        addToSyncQueue('create', 'cotizacion_detalle', {
                            id_cotizacion: cotizacionId,
                            codigo_producto: item.codigo,
                            nombre_producto: item.nombre,
                            cantidad: item.cantidad,
                            valor_unitario: item.valor_unitario,
                            subtotal: item.subtotal,
                            tipo_precio: item.tipo_precio
                        });
                    });
                }
                
                // Agregar a datos locales
                cotizacionData.id_cotizacion = cotizacionId;
                offlineData.cotizaciones.push(cotizacionData);
                saveToOfflineDB('cotizaciones', offlineData.cotizaciones);
                
                showNotification(`Cotizaci√≥n ${consecutivo} creada exitosamente`, 'success');
                closeModal();
                openCotizacionesModule();
                
            } catch (error) {
                console.error('Error guardando cotizaci√≥n:', error);
                showNotification('Error al guardar cotizaci√≥n', 'error');
            }
        }
        
        // ===========================================
        // FUNCIONES DE COTIZACIONES (CONTINUAR)
        // ===========================================
        
        async function verCotizacion(idCotizacion) {
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return;
            
            // Cargar detalles
            let detalles = [];
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('cotizacion_detalle')
                        .select('*')
                        .eq('id_cotizacion', idCotizacion);
                    detalles = data || [];
                } else {
                    // Cargar detalles desde offline (simplificado)
                    detalles = await getFromOfflineDB('cotizacion_detalle');
                    detalles = detalles.filter(d => d.id_cotizacion === idCotizacion);
                }
            } catch (error) {
                console.error('Error cargando detalles:', error);
            }
            
            const fecha = new Date(cotizacion + formatNumber(cotizacion.total), 130, yPosition);
            
            // Firma
            yPosition += 30;
            doc.setFont('Arial', 'normal');
            doc.text('Cordialmente,', 20, yPosition);
            yPosition += 15;
            doc.text('Jorge Luis Hern√°ndez', 20, yPosition);
            yPosition += 8;
            doc.text('Celular: 314 345 2032', 20, yPosition);
            
            return doc.output('datauristring');
        }
        
        function downloadPDF(pdfBase64, filename) {
            const link = document.createElement('a');
            link.href = pdfBase64;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // ===========================================
        // M√ìDULO DE PAR√ÅMETROS
        // ===========================================
        
        function openParametrosModule() {
            // Cargar par√°metros actuales
            loadParametros();
        }
        
        async function loadParametros() {
            let parametros = {};
            
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('parametros')
                        .select('*')
                        .eq('id', 1)
                        .single();
                    
                    parametros = data || {};
                } else {
                    const savedParams = localStorage.getItem('parametros');
                    parametros = savedParams ? JSON.parse(savedParams) : {};
                }
            } catch (error) {
                console.error('Error cargando par√°metros:', error);
            }
            
            const formContent = `
                <form id="parametrosForm">
                    <h4>Informaci√≥n de la Empresa</h4>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="nombreEmpresa">Nombre de la Empresa</label>
                            <input type="text" id="nombreEmpresa" value="${parametros.nombre_empresa || 'Tool Center'}">
                        </div>
                        <div class="form-group">
                            <label for="correoEmpresa">Correo de la Empresa</label>
                            <input type="email" id="correoEmpresa" value="${parametros.correo_empresa || 'toolcenter.com.co@gmail.com'}">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="telefonoEmpresa">Tel√©fono</label>
                            <input type="text" id="telefonoEmpresa" value="${parametros.telefono_empresa || '314 345 2032'}">
                        </div>
                        <div class="form-group">
                            <label for="direccionEmpresa">Direcci√≥n</label>
                            <input type="text" id="direccionEmpresa" value="${parametros.direccion_empresa || 'Ibagu√©, Tolima'}">
                        </div>
                    </div>
                    
                    <h4 style="margin-top: 30px;">Configuraci√≥n del Sistema</h4>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="cantidadMayorista">Cantidad M√≠nima para Precio Mayorista</label>
                            <input type="number" id="cantidadMayorista" value="${parametros.cantidad_mayorista || 6}" min="1">
                        </div>
                        <div class="form-group">
                            <label for="validezCotizacion">Validez de Cotizaciones (d√≠as)</label>
                            <input type="number" id="validezCotizacion" value="${parametros.validez_cotizacion_dias || 30}" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="stockMinimo">Stock M√≠nimo por Defecto</label>
                        <input type="number" id="stockMinimo" value="${parametros.stock_minimo_default || 5}" min="0">
                    </div>
                    
                    <h4 style="margin-top: 30px;">Gesti√≥n de Zonas</h4>
                    <div class="form-group">
                        <button type="button" class="btn btn-secondary" onclick="openZonasManager()">Gestionar Zonas</button>
                    </div>
                </form>
            `;
            
            showModal('Par√°metros del Sistema', formContent, [
                '<button class="btn" onclick="saveParametros()">Guardar Cambios</button>',
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
            ]);
        }
        
        async function saveParametros() {
            const parametrosData = {
                nombre_empresa: document.getElementById('nombreEmpresa').value,
                correo_empresa: document.getElementById('correoEmpresa').value,
                telefono_empresa: document.getElementById('telefonoEmpresa').value,
                direccion_empresa: document.getElementById('direccionEmpresa').value,
                cantidad_mayorista: parseInt(document.getElementById('cantidadMayorista').value),
                validez_cotizacion_dias: parseInt(document.getElementById('validezCotizacion').value),
                stock_minimo_default: parseInt(document.getElementById('stockMinimo').value)
            };
            
            try {
                if (isOnline) {
                    await supabase
                        .from('parametros')
                        .update(parametrosData)
                        .eq('id', 1);
                } else {
                    addToSyncQueue('update', 'parametros', { id: 1, ...parametrosData });
                }
                
                // Guardar localmente
                localStorage.setItem('parametros', JSON.stringify(parametrosData));
                
                showNotification('Par√°metros guardados exitosamente', 'success');
                closeModal();
                
            } catch (error) {
                console.error('Error guardando par√°metros:', error);
                showNotification('Error al guardar par√°metros', 'error');
            }
        }
        
        function openZonasManager() {
            const zonasContent = `
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Nueva zona..." id="nuevaZonaNombre">
                    <button class="btn" onclick="addZona()">+ Agregar Zona</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="zonasTableBody">
                            ${renderZonasTable()}
                        </tbody>
                    </table>
                </div>
            `;
            
            showModal('Gesti√≥n de Zonas', zonasContent, [
                '<button class="btn btn-secondary" onclick="loadParametros()">Volver</button>'
            ]);
        }
        
        function renderZonasTable() {
            return offlineData.zonas.map(zona => `
                <tr>
                    <td>${zona.id}</td>
                    <td>${zona.nombre}</td>
                    <td><span style="color: ${zona.activa ? '#059669' : '#dc2626'};">${zona.activa ? 'Activa' : 'Inactiva'}</span></td>
                    <td>
                        <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="toggleZona('${zona.id}')">${zona.activa ? '‚ùå' : '‚úÖ'}</button>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteZona('${zona.id}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function addZona() {
            const nombre = document.getElementById('nuevaZonaNombre').value.trim();
            if (!nombre) {
                showNotification('Ingrese el nombre de la zona', 'error');
                return;
            }
            
            // Generar ID autom√°tico
            const maxId = Math.max(...offlineData.zonas.map(z => parseInt(z.id.replace('zona', ''))), 0);
            const newId = `zona${maxId + 1}`;
            
            const zonaData = {
                id: newId,
                nombre: nombre,
                activa: true,
                fecha_creacion: new Date().toISOString()
            };
            
            try {
                if (isOnline) {
                    await supabase.from('zonas').insert(zonaData);
                } else {
                    addToSyncQueue('create', 'zonas', zonaData);
                }
                
                offlineData.zonas.push(zonaData);
                saveToOfflineDB('zonas', offlineData.zonas);
                
                document.getElementById('nuevaZonaNombre').value = '';
                document.getElementById('zonasTableBody').innerHTML = renderZonasTable();
                
                showNotification('Zona agregada exitosamente', 'success');
                
            } catch (error) {
                console.error('Error agregando zona:', error);
                showNotification('Error al agregar zona', 'error');
            }
        }
        
        async function toggleZona(id) {
            const zona = offlineData.zonas.find(z => z.id === id);
            if (!zona) return;
            
            zona.activa = !zona.activa;
            
            try {
                if (isOnline) {
                    await supabase
                        .from('zonas')
                        .update({ activa: zona.activa })
                        .eq('id', id);
                } else {
                    addToSyncQueue('update', 'zonas', { id: id, activa: zona.activa });
                }
                
                saveToOfflineDB('zonas', offlineData.zonas);
                document.getElementById('zonasTableBody').innerHTML = renderZonasTable();
                
                showNotification(`Zona ${zona.activa ? 'activada' : 'desactivada'}`, 'success');
                
            } catch (error) {
                console.error('Error actualizando zona:', error);
                showNotification('Error al actualizar zona', 'error');
            }
        }
        
        // ===========================================
        // M√ìDULO DE INFORMES
        // ===========================================
        
        function openInformesModule() {
            const informesContent = `
                <div class="menu-grid">
                    <div class="menu-item" onclick="generateInformeCotizaciones()">
                        <span class="menu-icon">üìã</span>
                        <div class="menu-title">Informe de Cotizaciones</div>
                        <div class="menu-description">Reporte de cotizaciones por per√≠odo</div>
                    </div>
                    
                    <div class="menu-item" onclick="generateInformeVentas()">
                        <span class="menu-icon">üí∞</span>
                        <div class="menu-title">Informe de Ventas</div>
                        <div class="menu-description">Reporte de ventas confirmadas</div>
                    </div>
                    
                    <div class="menu-item" onclick="generateInformeProductos()">
                        <span class="menu-icon">üì¶</span>
                        <div class="menu-title">Informe de Productos</div>
                        <div class="menu-description">Estado de inventario</div>
                    </div>
                    
                    <div class="menu-item" onclick="exportarDatos()">
                        <span class="menu-icon">üì§</span>
                        <div class="menu-title">Exportar Datos</div>
                        <div class="menu-description">Backup completo en Excel</div>
                    </div>
                </div>
            `;
            
            showModal('Informes y Reportes', informesContent, [
                '<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>'
            ]);
        }
        
        // ===========================================
        // FUNCIONES AUXILIARES
        // ===========================================
        
        function formatNumber(number) {
            return new Intl.NumberFormat('es-CO').format(number);
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        
        function showModal(title, content, buttons = []) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modalFooter').innerHTML = buttons.join('');
            document.getElementById('universalModal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('universalModal').style.display = 'none';
        }
        
        // Service Worker para PWA (b√°sico)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Crear service worker inline para evitar problemas de archivos
                const swCode = `
                    self.addEventListener('install', function(event) {
                        console.log('Service Worker instalado');
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', function(event) {
                        console.log('Service Worker activado');
                        event.waitUntil(self.clients.claim());
                    });
                    
                    self.addEventListener('fetch', function(event) {
                        // Aqu√≠ puedes agregar l√≥gica de cache si es necesario
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker registrado exitosamente');
                    })
                    .catch(function(error) {
                        console.log('Error registrando ServiceWorker:', error);
                    });
            });
        }
        
        // Placeholder functions for features not fully implemented
        function editCotizacion(id) {
            showNotification('Funci√≥n de edici√≥n en desarrollo', 'info');
        }
        
        function generateInformeCotizaciones() {
            showNotification('Informe de cotizaciones en desarrollo', 'info');
        }
        
        function generateInformeVentas() {
            showNotification('Informe de ventas en desarrollo', 'info');
        }
        
        function generateInformeProductos() {
            showNotification('Informe de productos en desarrollo', 'info');
        }
        
        function exportarDatos() {
            showNotification('Exportaci√≥n de datos en desarrollo', 'info');
        }
        
        function deleteZona(id) {
            if (confirm('¬øEst√° seguro de eliminar esta zona?')) {
                showNotification('Eliminaci√≥n de zonas en desarrollo', 'info');
            }
        }
        
        function filterEntradas(searchTerm) {
            // Implementar filtrado de entradas
            showNotification('Filtro en desarrollo', 'info');
        }
    </script>
</body>
</html>.fecha_hora).toLocaleDateString('es-CO');
                const estadoColor = getEstadoColor(cotizacion.estado);
                
                return `
                    <tr>
                        <td>${cotizacion.consecutivo}</td>
                        <td>${cotizacion.nombre_cliente}</td>
                        <td>${fecha}</td>
                        <td>${formatNumber(cotizacion.total)}</td>
                        <td><span style="color: ${estadoColor}; font-weight: 600;">${cotizacion.estado}</span></td>
                        <td>
                            <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="verCotizacion(${cotizacion.id_cotizacion})">üëÅÔ∏è</button>
                            ${cotizacion.estado === 'Pendiente' ? `<button class="btn" style="margin-right: 5px; padding: 5px 10px;" onclick="editCotizacion(${cotizacion.id_cotizacion})">‚úèÔ∏è</button>` : ''}
                            ${cotizacion.estado === 'Enviada' ? `<button class="btn btn-success" style="margin-right: 5px; padding: 5px 10px;" onclick="confirmarVenta(${cotizacion.id_cotizacion})">‚úÖ</button>` : ''}
                            ${cotizacion.estado !== 'Vendida' ? `<button class="btn btn-danger" style="padding: 5px 10px;" onclick="anularCotizacion(${cotizacion.id_cotizacion})">‚ùå</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function getEstadoColor(estado) {
            switch (estado) {
                case 'Pendiente': return '#d97706';
                case 'Enviada': return '#2563eb';
                case 'Vendida': return '#059669';
                case 'Anulada': return '#dc2626';
                default: return '#6b7280';
            }
        }
        
        function filterCotizaciones(searchTerm) {
            const filtered = offlineData.cotizaciones.filter(cot => 
                cot.nombre_cliente.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cot.consecutivo.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function filterCotizacionesByEstado(estado) {
            const filtered = estado === 'all' 
                ? offlineData.cotizaciones 
                : offlineData.cotizaciones.filter(cot => cot.estado === estado);
            
            document.getElementById('cotizacionesTableBody').innerHTML = renderCotizacionesTable(filtered);
        }
        
        function showNuevaCotizacion() {
            currentCotizacion = {
                items: [],
                cliente: null,
                total: 0
            };
            
            const clientesOptions = offlineData.clientes.map(cliente => 
                `<option value="${cliente.nit}" data-nombre="${cliente.nombre}" data-zona="${cliente.zona}">${cliente.nombre} (${cliente.nit})</option>`
            ).join('');
            
            const formContent = `
                <div class="form-group">
                    <label for="cotizacionCliente">Cliente</label>
                    <select id="cotizacionCliente" required onchange="selectCliente()">
                        <option value="">Seleccionar cliente</option>
                        ${clientesOptions}
                    </select>
                </div>
                
                <div id="clienteInfo" class="hidden" style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4>Informaci√≥n del Cliente</h4>
                    <p id="clienteDetalles"></p>
                </div>
                
                <div class="form-group">
                    <label>Productos</label>
                    <input type="text" placeholder="Buscar productos..." onkeyup="filterProductosGrid(this.value)" style="margin-bottom: 15px;">
                </div>
                
                <div class="product-grid" id="productosGrid">
                    ${renderProductosGrid()}
                </div>
                
                <div id="cotizacionSummary" class="quotation-summary hidden">
                    <h4>Resumen de Cotizaci√≥n</h4>
                    <div id="cotizacionItems"></div>
                    <div class="total-row">
                        <div style="display: flex; justify-content: space-between;">
                            <span>Total:</span>
                            <span id="cotizacionTotal">$0</span>
                        </div>
                    </div>
                </div>
            `;
            
            showModal('Nueva Cotizaci√≥n', formContent, [
                '<button class="btn" onclick="saveCotizacion()" id="saveCotizacionBtn" disabled>Guardar Cotizaci√≥n</button>',
                '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
            ]);
        }
        
        let currentCotizacion = {
            items: [],
            cliente: null,
            total: 0
        };
        
        function selectCliente() {
            const select = document.getElementById('cotizacionCliente');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                currentCotizacion.cliente = {
                    nit: selectedOption.value,
                    nombre: selectedOption.dataset.nombre,
                    zona: selectedOption.dataset.zona
                };
                
                document.getElementById('clienteInfo').classList.remove('hidden');
                document.getElementById('clienteDetalles').innerHTML = `
                    <strong>${currentCotizacion.cliente.nombre}</strong><br>
                    NIT: ${currentCotizacion.cliente.nit}<br>
                    Zona: ${currentCotizacion.cliente.zona || 'No asignada'}
                `;
                
                updateSaveCotizacionButton();
            } else {
                currentCotizacion.cliente = null;
                document.getElementById('clienteInfo').classList.add('hidden');
                updateSaveCotizacionButton();
            }
        }
        
        function renderProductosGrid() {
            return offlineData.productos.map(producto => `
                <div class="product-card" data-codigo="${producto.codigo}">
                    <img src="${producto.foto_base64 || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAxNkg1NlY0OEgyNFYxNloiIHN0cm9rZT0iIzlDQTNBRiIgc3Ryb2tlLXdpZHRoPSIyIiBmaWxsPSJub25lIi8+CjxjaXJjbGUgY3g9IjQwIiBjeT0iMzIiIHI9IjQiIGZpbGw9IiM5Q0EzQUYiLz4KPC9zdmc+'}" 
                          class="product-image" alt="${producto.nombre}">
                    <div style="font-weight: 600; margin-bottom: 5px;">${producto.nombre}</div>
                    <div style="color: #6b7280; font-size: 12px; margin-bottom: 10px;">${producto.codigo}</div>
                    <div style="color: #6b7280; font-size: 12px;">Stock: ${producto.stock_actual || 0}</div>
                    <div class="quantity-controls hidden">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', -1)">-</button>
                        <input type="number" class="qty-input" value="1" min="1" onchange="updateQuantity('${producto.codigo}', this.value)">
                        <button class="qty-btn" onclick="changeQuantity('${producto.codigo}', 1)">+</button>
                        <button class="btn" style="margin-left: 10px; padding: 5px 10px;" onclick="addToQuotation('${producto.codigo}')">Agregar</button>
                    </div>
                </div>
            `).join('');
        }
        
        function filterProductosGrid(searchTerm) {
            const cards = document.querySelectorAll('.product-card');
            cards.forEach(card => {
                const nombre = card.querySelector('div').textContent.toLowerCase();
                const codigo = card.dataset.codigo.toLowerCase();
                
                if (nombre.includes(searchTerm.toLowerCase()) || codigo.includes(searchTerm.toLowerCase())) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function selectProduct(codigo) {
            // Deseleccionar todos los productos
            document.querySelectorAll('.product-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.quantity-controls').classList.add('hidden');
            });
            
            // Seleccionar el producto actual
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            card.classList.add('selected');
            card.querySelector('.quantity-controls').classList.remove('hidden');
        }
        
        // Agregar event listeners a las tarjetas de productos
        document.addEventListener('click', function(e) {
            if (e.target.closest('.product-card') && !e.target.closest('.quantity-controls')) {
                const card = e.target.closest('.product-card');
                const codigo = card.dataset.codigo;
                selectProduct(codigo);
            }
        });
        
        function changeQuantity(codigo, delta) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            const newValue = Math.max(1, parseInt(input.value) + delta);
            input.value = newValue;
        }
        
        function updateQuantity(codigo, value) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const input = card.querySelector('.qty-input');
            input.value = Math.max(1, parseInt(value));
        }
        
        async function addToQuotation(codigo) {
            const card = document.querySelector(`[data-codigo="${codigo}"]`);
            const quantity = parseInt(card.querySelector('.qty-input').value);
            const producto = offlineData.productos.find(p => p.codigo === codigo);
            
            if (!producto) return;
            
            // Obtener √∫ltimos precios del producto
            let valorMayor = 0, valorMenor = 0;
            
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('entradas')
                        .select('valor_mayor, valor_menor')
                        .eq('codigo_producto', codigo)
                        .order('fecha_hora', { ascending: false })
                        .limit(1);
                    
                    if (data && data.length > 0) {
                        valorMayor = data[0].valor_mayor;
                        valorMenor = data[0].valor_menor;
                    }
                } else {
                    const entradas = await getFromOfflineDB('entradas');
                    const productEntries = entradas
                        .filter(e => e.codigo_producto === codigo)
                        .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                    
                    if (productEntries.length > 0) {
                        valorMayor = productEntries[0].valor_mayor;
                        valorMenor = productEntries[0].valor_menor;
                    }
                }
            } catch (error) {
                console.error('Error obteniendo precios:', error);
            }
            
            if (valorMayor === 0 || valorMenor === 0) {
                showNotification('No se encontraron precios para este producto. Registre una entrada primero.', 'warning');
                return;
            }
            
            // Calcular precio seg√∫n cantidad (>= 6 usa precio mayor, < 6 usa precio menor)
            const cantidadMayorista = 6; // Esto deber√≠a venir de par√°metros
            const precioUnitario = quantity >= cantidadMayorista ? valorMayor : valorMenor;
            const subtotal = quantity * precioUnitario;
            
            // Verificar si el producto ya est√° en la cotizaci√≥n
            const existingIndex = currentCotizacion.items.findIndex(item => item.codigo === codigo);
            
            if (existingIndex >= 0) {
                // Actualizar cantidad existente
                currentCotizacion.items[existingIndex].cantidad += quantity;
                currentCotizacion.items[existingIndex].subtotal = 
                    currentCotizacion.items[existingIndex].cantidad * 
                    (currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor);
                currentCotizacion.items[existingIndex].valor_unitario = 
                    currentCotizacion.items[existingIndex].cantidad >= cantidadMayorista ? valorMayor : valorMenor;
            } else {
                // Agregar nuevo item
                currentCotizacion.items.push({
                    codigo: codigo,
                    nombre: producto.nombre,
                    cantidad: quantity,
                    valor_unitario: precioUnitario,
                    subtotal: subtotal,
                    tipo_precio: quantity >= cantidadMayorista ? 'mayor' : 'menor'
                });
            }
            
            updateCotizacionSummary();
            showNotification(`${producto.nombre} agregado a la cotizaci√≥n`, 'success');
            
            // Limpiar selecci√≥n
            card.classList.remove('selected');
            card.querySelector('.quantity-controls').classList.add('hidden');
            card.querySelector('.qty-input').value = 1;
        }
        
        function updateCotizacionSummary() {
            const summaryDiv = document.getElementById('cotizacionSummary');
            const itemsDiv = document.getElementById('cotizacionItems');
            const totalSpan = document.getElementById('cotizacionTotal');
            
            if (currentCotizacion.items.length === 0) {
                summaryDiv.classList.add('hidden');
                updateSaveCotizacionButton();
                return;
            }
            
            summaryDiv.classList.remove('hidden');
            
            itemsDiv.innerHTML = currentCotizacion.items.map((item, index) => `
                <div class="quotation-item">
                    <div class="item-info">
                        <div class="item-name">${item.nombre}</div>
                        <div class="item-details">
                            Cantidad: ${item.cantidad} | 
                            Precio: ${formatNumber(item.valor_unitario)} (${item.tipo_precio})
                        </div>
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="item-total">${formatNumber(item.subtotal)}</div>
                        <button class="delete-btn" onclick="removeFromQuotation(${index})">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
            
            currentCotizacion.total = currentCotizacion.items.reduce((sum, item) => sum + item.subtotal, 0);
            totalSpan.textContent = `${formatNumber(currentCotizacion.total)}`;
            
            updateSaveCotizacionButton();
        }
        
        function removeFromQuotation(index) {
            currentCotizacion.items.splice(index, 1);
            updateCotizacionSummary();
        }
        
        function updateSaveCotizacionButton() {
            const btn = document.getElementById('saveCotizacionBtn');
            btn.disabled = !currentCotizacion.cliente || currentCotizacion.items.length === 0;
        }
        
        async function saveCotizacion() {
            if (!currentCotizacion.cliente || currentCotizacion.items.length === 0) {
                showNotification('Seleccione un cliente y agregue productos', 'error');
                return;
            }
            
            try {
                // Generar consecutivo
                const a√±o = new Date().getFullYear();
                let consecutivo;
                
                if (isOnline) {
                    const { data } = await supabase.rpc('generar_consecutivo_cotizacion', { a√±o_param: a√±o });
                    consecutivo = data;
                } else {
                    // Generar consecutivo offline (simplificado)
                    const cotizacionesA√±o = offlineData.cotizaciones.filter(c => 
                        new Date(c.fecha_hora).getFullYear() === a√±o
                    );
                    const nextNumber = cotizacionesA√±o.length + 1;
                    consecutivo = `COT-${a√±o}-${nextNumber.toString().padStart(3, '0')}`;
                }
                
                const cotizacionData = {
                    consecutivo: consecutivo,
                    nit_cliente: currentCotizacion.cliente.nit,
                    nombre_cliente: currentCotizacion.cliente.nombre,
                    zona_cliente: currentCotizacion.cliente.zona,
                    fecha_hora: new Date().toISOString(),
                    fecha_vencimiento: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0], // 30 d√≠as
                    subtotal: currentCotizacion.total,
                    total: currentCotizacion.total,
                    estado: 'Pendiente',
                    usuario_creacion: currentUser.username
                };
                
                let cotizacionId;
                
                if (isOnline) {
                    const { data, error } = await supabase
                        .from('cotizaciones')
                        .insert(cotizacionData)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    cotizacionId = data.id_cotizacion;
                    
                    // Insertar detalles
                    const detalles = currentCotizacion.items.map(item => ({
                        id_cotizacion: cotizacionId,
                        codigo_producto: item.codigo,
                        nombre_producto: item.nombre,
                        cantidad: item.cantidad,
                        valor_unitario: item.valor_unitario,
                        subtotal: item.subtotal,
                        tipo_precio: item.tipo_precio
                    }));
                    
                    await supabase.from('cotizacion_detalle').insert(detalles);
                    
                } else {
                    cotizacionId = Date.now();
                    cotizacionData.id_cotizacion = cotizacionId;
                    addToSyncQueue('create', 'cotizaciones', cotizacionData);
                    
                    // Guardar detalles para sincronizaci√≥n
                    currentCotizacion.items.forEach(item => {
                        addToSyncQueue('create', 'cotizacion_detalle', {
                            id_cotizacion: cotizacionId,
                            codigo_producto: item.codigo,
                            nombre_producto: item.nombre,
                            cantidad: item.cantidad,
                            valor_unitario: item.valor_unitario,
                            subtotal: item.subtotal,
                            tipo_precio: item.tipo_precio
                        });
                    });
                }
                
                // Agregar a datos locales
                cotizacionData.id_cotizacion = cotizacionId;
                offlineData.cotizaciones.push(cotizacionData);
                saveToOfflineDB('cotizaciones', offlineData.cotizaciones);
                
                showNotification(`Cotizaci√≥n ${consecutivo} creada exitosamente`, 'success');
                closeModal();
                openCotizacionesModule();
                
            } catch (error) {
                console.error('Error guardando cotizaci√≥n:', error);
                showNotification('Error al guardar cotizaci√≥n', 'error');
            }
        }
        
        // ===========================================
        // FUNCIONES DE COTIZACIONES (CONTINUAR)
        // ===========================================
        
        async function verCotizacion(idCotizacion) {
            const cotizacion = offlineData.cotizaciones.find(c => c.id_cotizacion === idCotizacion);
            if (!cotizacion) return;
            
            // Cargar detalles
            let detalles = [];
            try {
                if (isOnline) {
                    const { data } = await supabase
                        .from('cotizacion_detalle')
                        .select('*')
                        .eq('id_cotizacion', idCotizacion);
                    detalles = data || [];
                } else {
                    // Cargar detalles desde offline (simplificado)
                    detalles = await getFromOfflineDB('cotizacion_detalle');
                    detalles = detalles.filter(d => d.id_cotizacion === idCotizacion);
                }
            } catch (error) {
                console.error('Error cargando detalles:', error);
            }
            
            const fecha = new Date(cotizacion