<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaciones - Tool Center</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiU2lzdGVtYSBkZSBDb3RpemFjaW9uZXMiLCJzaG9ydF9uYW1lIjoiQ290aXphY2lvbmVzIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmZmZmZmYiLCJ0aGVtZV9jb2xvciI6IiMyNTYzZWIiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXlOQ0F5TkNJK1BIQmhkR2dnWkQwaWJUTWdOQ0JqTXlBd0lEWXRNeUEwTFRNeUlEUklNVTVqTVMwd0lEWWdNeUEwV2cwM0lERXdZeTF3SURZZ015QTBMVEZpTURRek5VNXpNUzB3SURZZ015QTBXaTA0TVNBd0lERWlJR1pwYkdFOUlpTXlOVVl6WldJaUx6NDhMM04yWno0PSIsInNpemVzIjoiMjR4MjQiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- EmailJS para env√≠o de correos -->
    <script src="https://cdn.emailjs.com/sdk/2.6.4/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: #2563eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #374151;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-success {
            background: #059669;
        }

        .btn-success:hover {
            background: #047857;
        }

        .btn-danger {
            background: #dc2626;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        /* Main App */
        .app-container {
            display: none;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .connection-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .online {
            background: #dcfce7;
            color: #166534;
        }

        .offline {
            background: #fef2f2;
            color: #dc2626;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .menu-item {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #2563eb;
        }

        .menu-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        .menu-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .menu-description {
            color: #6b7280;
            font-size: 14px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        tr:hover {
            background: #f9fafb;
        }

        /* Search and filters */
        .search-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            max-width: 400px;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #059669;
        }

        .notification.error {
            background: #dc2626;
        }

        .notification.info {
            background: #2563eb;
        }

        .notification.warning {
            background: #d97706;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .menu-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .menu-item {
                padding: 20px;
            }

            .menu-icon {
                font-size: 36px;
            }

            .modal-content {
                margin: 10px;
                max-height: 95vh;
            }

            .search-bar {
                flex-direction: column;
            }

            .search-input {
                min-width: auto;
            }
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #2563eb;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        /* Product grid for quotations */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .product-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .product-card:hover {
            border-color: #2563eb;
            transform: translateY(-2px);
        }

        .product-card.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            margin: 0 auto 10px;
            display: block;
            background: #f3f4f6;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .qty-btn:hover {
            background: #f3f4f6;
        }

        .qty-input {
            width: 60px;
            text-align: center;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            padding: 5px;
        }

        /* Quotation summary */
        .quotation-summary {
            background: #f9fafb;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .quotation-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .quotation-item:last-child {
            border-bottom: none;
        }

        .item-info {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-details {
            font-size: 14px;
            color: #6b7280;
        }

        .item-total {
            font-weight: 600;
            color: #2563eb;
        }

        .delete-btn {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            margin-left: 10px;
        }

        .delete-btn:hover {
            background: #b91c1c;
        }

        .total-row {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            padding-top: 15px;
            margin-top: 15px;
            border-top: 2px solid #d1d5db;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo">TC</div>
            <h2>Sistema de Cotizaciones</h2>
            <p style="color: #6b7280; margin-bottom: 30px;">Tool Center - Ibagu√©</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" value="jhernandez" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="btn">Iniciar Sesi√≥n</button>
            </form>
            
            <div style="margin-top: 20px; font-size: 12px; color: #6b7280;">
                Versi√≥n 1.0 | <span id="connectionStatus">Verificando conexi√≥n...</span>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <div class="user-info">
                    <div class="logo" style="width: 50px; height: 50px; font-size: 16px;">TC</div>
                    <div>
                        <h2>Sistema de Cotizaciones</h2>
                        <p style="color: #6b7280;">Bienvenido, <span id="userName">Jorge Luis Hern√°ndez</span></p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="connectionStatusApp" class="connection-status online">üü¢ En l√≠nea</div>
                    <button class="btn btn-secondary" onclick="logout()">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- Main Menu -->
            <div id="mainMenu" class="menu-grid">
                <div class="menu-item" onclick="openModule('clientes')">
                    <span class="menu-icon">üë•</span>
                    <div class="menu-title">Clientes</div>
                    <div class="menu-description">Gestionar informaci√≥n de clientes</div>
                </div>

                <div class="menu-item" onclick="openModule('productos')">
                    <span class="menu-icon">üì¶</span>
                    <div class="menu-title">Productos</div>
                    <div class="menu-description">Cat√°logo y control de inventario</div>
                </div>

                <div class="menu-item" onclick="openModule('entradas')">
                    <span class="menu-icon">üì•</span>
                    <div class="menu-title">Entradas</div>
                    <div class="menu-description">Registrar entradas y devoluciones</div>
                </div>

                <div class="menu-item" onclick="openModule('cotizaciones')">
                    <span class="menu-icon">üí∞</span>
                    <div class="menu-title">Cotizaciones</div>
                    <div class="menu-description">Crear y gestionar cotizaciones</div>
                </div>

                <div class="menu-item" onclick="openModule('parametros')">
                    <span class="menu-icon">‚öôÔ∏è</span>
                    <div class="menu-title">Par√°metros</div>
                    <div class="menu-description">Configuraci√≥n del sistema</div>
                </div>

                <div class="menu-item" onclick="openModule('informes')">
                    <span class="menu-icon">üìä</span>
                    <div class="menu-title">Informes</div>
                    <div class="menu-description">Reportes y estad√≠sticas</div>
                </div>
            </div>

            <!-- Notifications area -->
            <div id="notificationsArea"></div>
        </div>
    </div>

    <!-- Universal Modal -->
    <div id="universalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">T√≠tulo</h3>
                <button class="close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <!-- Footer buttons will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // CONFIGURACI√ìN Y VARIABLES GLOBALES
        // ===========================================
        
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://nipwdvnhngdydpclvhco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pcHdkdm5obmdkeWRwY2x2aGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTcxNzcsImV4cCI6MjA3MDk3MzE3N30.nMkXseYCsdh_eCfWBXBYsvzObbXjq4Uj3_sBvq2pF0E';
        
        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Variables globales
        let currentUser = null;
        let isOnline = navigator.onLine;
        let offlineData = {
            clientes: [],
            productos: [],
            cotizaciones: [],
            zonas: [],
            entradas: [],
            pendingSync: []
        };
        
        // Configuraci√≥n EmailJS (necesitar√°s configurar tu cuenta)
        const EMAILJS_SERVICE_ID = 'your_service_id';
        const EMAILJS_TEMPLATE_ID = 'your_template_id';
        const EMAILJS_USER_ID = 'your_user_id';
        
        // Inicializar EmailJS si est√° disponible
        if (typeof emailjs !== 'undefined') {
            emailjs.init(EMAILJS_USER_ID);
        }
        
        // ===========================================
        // INICIALIZACI√ìN
        // ===========================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            checkConnectionStatus();
        });
        
        function initializeApp() {
            // Verificar si hay sesi√≥n guardada
            const savedSession = localStorage.getItem('userSession');
            if (savedSession) {
                currentUser = JSON.parse(savedSession);
                showApp();
            } else {
                showLogin();
            }
            
            // Inicializar IndexedDB para almacenamiento offline
            initializeOfflineStorage();
        }
        
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Connection status
            window.addEventListener('online', () => {
                isOnline = true;
                updateConnectionStatus();
                syncOfflineData();
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateConnectionStatus();
            });
            
            // Modal click outside to close
            document.getElementById('universalModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });
        }
        
        // ===========================================
        // AUTENTICACI√ìN
        // ===========================================
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            showNotification('Iniciando sesi√≥n...', 'info');
            
            try {
                if (isOnline) {
                    // Verificar credenciales en la base de datos
                    const { data, error } = await supabase
                        .from('usuarios')
                        .select('*')
                        .eq('username', username)
                        .eq('activo', true)
                        .single();
                    
                    if (error || !data) {
                        showNotification('Usuario o contrase√±a incorrectos', 'error');
                        return;
                    }
                    
                    // En un entorno real, aqu√≠ verificar√≠as el hash de la contrase√±a
                    // Por ahora, usamos comparaci√≥n simple para pruebas
                    if (password !== 'temporal123' && password !== 'Admin2025*') {
                        showNotification('Usuario o contrase√±a incorrectos', 'error');
                        return;
                    }
                    
                    // Actualizar √∫ltimo acceso
                    await supabase
                        .from('usuarios')
                        .update({ ultimo_acceso: new Date().toISOString() })
                        .eq('id', data.id);
                    
                    currentUser = data;
                    localStorage.setItem('userSession', JSON.stringify(data));
                    
                } else {
                    // Modo offline - verificar credenciales b√°sicas
                    if (username === 'jhernandez' && (password === 'temporal123' || password === 'Admin2025*')) {
                        currentUser = { 
                            username: 'jhernandez', 
                            nombre: 'Jorge Luis Hern√°ndez',
                            perfil: 'admin'
                        };
                        localStorage.setItem('userSession', JSON.stringify(currentUser));
                    } else {
                        showNotification('Credenciales incorrectas (modo offline)', 'error');
                        return;
                    }
                }
                
                showNotification('¬°Bienvenido!', 'success');
                showApp();
                
            } catch (error) {
                console.error('Error en login:', error);
                showNotification('Error al iniciar sesi√≥n', 'error');
            }
        }
        
        function logout() {
            currentUser = null;
            localStorage.removeItem('userSession');
            showLogin();
            showNotification('Sesi√≥n cerrada', 'info');
        }
        
        function showLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }
        
        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nombre;
            loadInitialData();
        }
        
        // ===========================================
        // GESTI√ìN DE CONEXI√ìN Y SINCRONIZACI√ìN
        // ===========================================
        
        function checkConnectionStatus() {
            updateConnectionStatus();
            
            // Verificar conexi√≥n cada 30 segundos
            setInterval(() => {
                fetch(SUPABASE_URL + '/rest/v1/', { method: 'HEAD' })
                    .then(() => {
                        if (!isOnline) {
                            isOnline = true;
                            updateConnectionStatus();
                            syncOfflineData();
                        }
                    })
                    .catch(() => {
                        if (isOnline) {
                            isOnline = false;
                            updateConnectionStatus();
                        }
                    });
            }, 30000);
        }
        
        function updateConnectionStatus() {
            const statusElements = [
                document.getElementById('connectionStatus'),
                document.getElementById('connectionStatusApp')
            ];
            
            statusElements.forEach(element => {
                if (element) {
                    if (isOnline) {
                        element.textContent = 'üü¢ En l√≠nea';
                        element.className = 'connection-status online';
                    } else {
                        element.textContent = 'üî¥ Sin conexi√≥n';
                        element.className = 'connection-status offline';
                    }
                }
            });
        }
        
        async function syncOfflineData() {
            if (!isOnline) return;
            
            const pendingItems = getPendingSyncItems();
            if (pendingItems.length === 0) return;
            
            showNotification('Sincronizando datos...', 'info');
            
            let syncSuccessCount = 0;
            let syncErrorCount = 0;
            
            for (const item of pendingItems) {
                try {
                    await syncSingleItem(item);
                    syncSuccessCount++;
                    removePendingSyncItem(item.id);
                } catch (error) {
                    console.error('Error sincronizando item:', error);
                    syncErrorCount++;
                }
            }
            
            if (syncSuccessCount > 0) {
                showNotification(`${syncSuccessCount} registros sincronizados exitosamente`, 'success');
            }
            
            if (syncErrorCount > 0) {
                showNotification(`Error al sincronizar ${syncErrorCount} registros`, 'error');
            }
        }
        
        // ===========================================
        // ALMACENAMIENTO OFFLINE (IndexedDB)
        // ===========================================
        
        function initializeOfflineStorage() {
            // Inicializar IndexedDB para almacenamiento offline
            const request = indexedDB.open('CotizacionesDB', 1);
            
            request.onerror = function(event) {
                console.error('Error abriendo IndexedDB:', event);
            };
            
            request.onsuccess = function(event) {
                const db = event.target.result;
                window.offlineDB = db;
                loadOfflineData();
            };
            
            request.onupgradeneeded = function(event) {
                const db = event.target.result;
                
                // Crear stores para cada tabla
                const tables = ['clientes', 'productos', 'cotizaciones', 'entradas', 'zonas', 'sync_queue'];
                
                tables.forEach(tableName => {
                    if (!db.objectStoreNames.contains(tableName)) {
                        const store = db.createObjectStore(tableName, { keyPath: 'id', autoIncrement: true });
                        if (tableName === 'clientes') store.createIndex('nit', 'nit', { unique: true });
                        if (tableName === 'productos') store.createIndex('codigo', 'codigo', { unique: true });
                    }
                });
            };
        }
        
        function saveToOfflineDB(tableName, data) {
            if (!window.offlineDB) return;
            
            const transaction = window.offlineDB.transaction([tableName], 'readwrite');
            const store = transaction.objectStore(tableName);
            
            if (Array.isArray(data)) {
                data.forEach(item => store.put(item));
            } else {
                store.put(data);
            }
        }
        
        function getFromOfflineDB(tableName) {
            return new Promise((resolve, reject) => {
                if (!window.offlineDB) {
                    resolve([]);
                    return;
                }
                
                const transaction = window.offlineDB.transaction([tableName], 'readonly');
                const store = transaction.objectStore(tableName);
                const request = store.getAll();
                
                request.onsuccess = function() {
                    resolve(request.result || []);
                };
                
                request.onerror = function() {
                    reject(request.error);
                };
            });
        }
        
        function addToSyncQueue(action, table, data) {
            const syncItem = {
                id: Date.now() + Math.random(),
                action: action, // 'create', 'update', 'delete'
                table: table,
                data: data,
                timestamp: new Date().toISOString()
            };
            
            saveToOfflineDB('sync_queue', syncItem);
        }
        
        function getPendingSyncItems() {
            return getFromOfflineDB('sync_queue');
        }
        
        function removePendingSyncItem(itemId) {
            if (!window.offlineDB) return;
            
            const transaction = window.offlineDB.transaction(['sync_queue'], 'readwrite');
            const store = transaction.objectStore('sync_queue');
            store.delete(itemId);
        }
        
        async function syncSingleItem(item) {
            const { action, table, data } = item;
            
            switch (action) {
                case 'create':
                    await supabase.from(table).insert(data);
                    break;
                case 'update':
                    await supabase.from(table).update(data).eq('id', data.id);
                    break;
                case 'delete':
                    await supabase.from(table).delete().eq('id', data.id);
                    break;
            }
        }
        
        // ===========================================
        // CARGA DE DATOS INICIALES
        // ===========================================
        
        async function loadInitialData() {
            try {
                if (isOnline) {
                    // Cargar datos desde Supabase
                    await loadOnlineData();
                } else {
                    // Cargar datos desde IndexedDB
                    await loadOfflineData();
                }
            } catch (error) {
                console.error('Error cargando datos iniciales:', error);
                showNotification('Error cargando datos', 'error');
            }
        }
        
        async function loadOnlineData() {
            try {
                // Cargar datos b√°sicos
                const [clientesData, productosData, zonasData] = await Promise.all([
                    supabase.from('clientes').select('*').eq('activo', true),
                    supabase.from('productos').select('*').eq('activo', true),
                    supabase.from('zonas').select('*').eq('activa', true)
                ]);
                
                offlineData.clientes = clientesData.data || [];
                offlineData.productos = productosData.data || [];
                offlineData.zonas = zonasData.data || [];
                
                // Guardar en IndexedDB para uso offline
                saveToOfflineDB('clientes', offlineData.clientes);
                saveToOfflineDB('productos', offlineData.productos);
                saveToOfflineDB('zonas', offlineData.zonas);
                
            } catch (error) {
                console.error('Error cargando datos online:', error);
                // Fallback a datos offline
                await loadOfflineData();
            }
        }
        
        async function loadOfflineData() {
            try {
                offlineData.clientes = await getFromOfflineDB('clientes');
                offlineData.productos = await getFromOfflineDB('productos');
                offlineData.zonas = await getFromOfflineDB('zonas');
                offlineData.cotizaciones = await getFromOfflineDB('cotizaciones');
            } catch (error) {
                console.error('Error cargando datos offline:', error);
            }
        }
        
        // ===========================================
        // GESTI√ìN DE M√ìDULOS
        // ===========================================
        
        function openModule(moduleName) {
            switch (moduleName) {
                case 'clientes':
                    openClientesModule();
                    break;
                case 'productos':
                    openProductosModule();
                    break;
                case 'entradas':
                    openEntradasModule();
                    break;
                case 'cotizaciones':
                    openCotizacionesModule();
                    break;
                case 'parametros':
                    openParametrosModule();
                    break;
                case 'informes':
                    openInformesModule();
                    break;
                default:
                    showNotification('M√≥dulo no implementado', 'warning');
            }
        }
        
        // ===========================================
        // M√ìDULO DE CLIENTES
        // ===========================================
        
        function openClientesModule() {
            const modalContent = `
                <div class="search-bar">
                    <input type="text" class="search-input" placeholder="Buscar por nombre o NIT..." onkeyup="filterClientes(this.value)">
                    <button class="btn" onclick="showClienteForm()">+ Nuevo Cliente</button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>NIT</th>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Tel√©fono</th>
                                <th>Zona</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="clientesTableBody">
                            ${renderClientesTable()}
                        </tbody>
                    </table>
                </div>
            `;
            
            showModal('Gesti√≥n de Clientes', modalContent, [
                '<button class="btn btn-secondary" onclick="closeModal()">Cerrar</button>'
            ]);
        }
        
        function renderClientesTable() {
            return offlineData.clientes.map(cliente => `
                <tr>
                    <td>${cliente.nit}</td>
                    <td>${cliente.nombre}</td>
                    <td>${cliente.correo || '-'}</td>
                    <td>${cliente.tel_celular || '-'}</td>
                    <td>${cliente.zona || '-'}</td>
                    <td>
                        <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="editCliente('${cliente.nit}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteCliente('${cliente.nit}')">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function filterClientes(searchTerm) {
            const filteredClientes = offlineData.clientes.filter(cliente => 
                cliente.nombre.toLowerCase().includes(searchTerm.toLowerCase()) ||
                cliente.nit.includes(searchTerm)
            );
            
            document.getElementById('clientesTableBody').innerHTML = 
                filteredClientes.map(cliente => `
                    <tr>
                        <td>${cliente.nit}</td>
                        <td>${cliente.nombre}</td>
                        <td>${cliente.correo || '-'}</td>
                        <td>${cliente.tel_celular || '-'}</td>
                        <td>${cliente.zona || '-'}</td>
                        <td>
                            <button class="btn btn-secondary" style="margin-right: 5px; padding: 5px 10px;" onclick="editCliente('${cliente.nit}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger" style="padding: 5px 10px;" onclick="deleteCliente('${cliente.nit}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
        }
        
        function showClienteForm(nit = null) {
            const isEdit = nit !== null;
            const cliente = isEdit ? offlineData.clientes.find(c => c.nit === nit) : {};
            
            const zonasOptions = offlineData.zonas.map(zona => 
                `<option value="${zona.id}" ${cliente.zona === zona.id ? 'selected' : ''}>${zona.nombre}</option>`
            ).join('');
            
            const formContent = `
                <form id="clienteForm">
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="clienteNit">NIT</label>
                            <input type="text" id="clienteNit" value="${cliente.nit || ''}" ${isEdit ? 'readonly' : ''} required>
                        </div>
                        <div class="form-group">
                            <label for="clienteNombre">Nombre</label>
                            <input type="text" id="clienteNombre" value="${cliente.nombre || ''}" required>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="clienteCorreo">Correo</label>
                            <input type="email" id="clienteCorreo" value="${cliente.correo || ''}">
                        </div>
                        <div class="form-group">
                            <label for="clienteZona">Zona</label>
                            <select id="clienteZona">
                                <option value="">Seleccionar zona</option>
                                ${zonasOptions}
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="clienteCelular">Tel√©fono Celular</label>
                            <input type="text" id="clienteCelular" value="${cliente.tel_celular || ''}">
                        </div>
                        <div class="form-group">
                            <label for="clienteFijo">Tel√©fono Fijo</label>
                            <input type="text" id="clienteFijo" value="${cliente.tel_fijo || ''}">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="clienteDireccion">Direcci√≥n</label>
                        <textarea id="clienteDireccion" rows="3">${cliente.direccion || ''}</textarea>
                    </div>
                </form>
            `;
            
            showModal(
                isEdit ? 'Editar Cliente' : 'Nuevo Cliente', 
                formContent,
                [
                    `<button class="btn" onclick="saveCliente(${isEdit})">${isEdit ? 'Actualizar' : 'Guardar'}</button>`,
                    '<button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>'
                ]
            );
        }
        
        async function saveCliente(isEdit) {
            const clienteData = {
                nit: document.getElementById('clienteNit').value,
                nombre: document.getElementById('clienteNombre').value,
                correo: document.getElementById('clienteCorreo').value,
                zona: document.getElementById('clienteZona').value,
                tel_celular: document.getElementById('clienteCelular').value,
                tel_fijo: document.getElementById('clienteFijo').value,
                direccion: document.getElementById('clienteDireccion').value,
                activo: true
            };
            
            // Validar datos
            if (!clienteData.nit || !clienteData.nombre) {
                showNotification('NIT y nombre son obligatorios', 'error');
                return;
            }
            
            // Verificar duplicados
            if (!isEdit && offlineData.clientes.find(c => c.nit === clienteData.nit)) {
                showNotification('Ya existe un cliente con ese NIT', 'error');
                return;
            }
            
            try {
                if (isOnline) {
                    if (isEdit) {
                        await supabase.from('clientes').update(clienteData).eq('nit', clienteData.nit);
                    } else {
                        await supabase.from('clientes').insert(clienteData);
                    }
                } else {
                    // Guardar para sincronizaci√≥n posterior
                    addToSyncQueue(isEdit ? 'update' : 'create', 'clientes', clienteData);
                }
                
                // Actualizar datos locales
                if (isEdit) {
                    const index = offlineData.clientes.findIndex(c => c.nit === clienteData.nit);
                    offlineData.clientes[index] = clienteData;
                } else {
                    offlineData.clientes.push(clienteData);
                }
                
                saveToOfflineDB('clientes', offlineData.clientes);
                
                showNotification(`Cliente ${isEdit ? 'actualizado' : 'creado'} exitosamente`, 'success');
                closeModal();
                openClientesModule(); // Refrescar la vista
                
            } catch (error) {
                console.error('Error guardando cliente:', error);
                showNotification('Error al guardar cliente', 'error');
            }
        }
        
        async function deleteCliente(nit) {
            if (!confirm('¬øEst√° seguro de eliminar este cliente?')) return;
            
            try {
                if (isOnline) {
                    await supabase.from('clientes').update({ activo: false }).eq('nit', nit);
                } else {
                    addToSyncQueue('update', 'clientes', { nit: nit, activo: false });
                }
                
                // Remover de datos locales
                offlineData.clientes = offlineData.clientes.filter(c => c.nit !== nit);
                saveToOfflineDB('clientes', offlineData.clientes);
                
                showNotification('Cliente eliminado exitosamente', 'success');
                openClientesModule(); // Refrescar la vista
                
            } catch (error) {
                console.error('Error eliminando cliente:', error);
                showNotification('Error al eliminar cliente', 'error');
            }
        }
        
        function editCliente(nit) {
            showClienteForm(nit);
        }
        
        // ===========================================
        // FUNCIONES AUXILIARES
        // ===========================================
        
        function formatNumber(number) {
            return new Intl.NumberFormat('es-CO').format(number);
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }
        
        function showModal(title, content, buttons = []) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('modalFooter').innerHTML = buttons.join('');
            document.getElementById('universalModal').style.display = 'flex';
        }
        
        function closeModal() {
            document.getElementById('universalModal').style.display = 'none';
        }
        
        // Placeholder functions for modules not fully implemented
        function openProductosModule() {
            showNotification('M√≥dulo de productos en desarrollo', 'info');
        }
        
        function openEntradasModule() {
            showNotification('M√≥dulo de entradas en desarrollo', 'info');
        }
        
        function openCotizacionesModule() {
            showNotification('M√≥dulo de cotizaciones en desarrollo', 'info');
        }
        
        function openParametrosModule() {
            showNotification('M√≥dulo de par√°metros en desarrollo', 'info');
        }
        
        function openInformesModule() {
            showNotification('M√≥dulo de informes en desarrollo', 'info');
        }
        
        // Service Worker para PWA (b√°sico)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                // Crear service worker inline para evitar problemas de archivos
                const swCode = `
                    self.addEventListener('install', function(event) {
                        console.log('Service Worker instalado');
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', function(event) {
                        console.log('Service Worker activado');
                        event.waitUntil(self.clients.claim());
                    });
                    
                    self.addEventListener('fetch', function(event) {
                        // Aqu√≠ puedes agregar l√≥gica de cache si es necesario
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(function(registration) {
                        console.log('ServiceWorker registrado exitosamente');
                    })
                    .catch(function(error) {
                        console.log('Error registrando ServiceWorker:', error);
                    });
            });
        }
    </script>
</body>
</html>