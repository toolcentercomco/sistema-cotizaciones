<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cotizaciones - Tool Center</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* LOGIN STYLES */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: #2563eb;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .login-title {
            color: #2563eb;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: #2563eb;
        }

        .btn {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
            font-weight: 500;
        }

        .btn:hover {
            background: #1d4ed8;
        }

        .btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        /* MENU STYLES */
        .menu-container {
            display: none;
            min-height: 100vh;
            background: white;
        }

        .header {
            background: #2563eb;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .subtitle {
            font-size: 14px;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .status-bar {
            background: #1e40af;
            color: white;
            padding: 8px 20px;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot.offline {
            background: #ef4444;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .menu-item {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.15);
            border-color: #2563eb;
        }

        .menu-item .icon {
            font-size: 48px;
            margin-bottom: 15px;
            color: #2563eb;
        }

        .menu-item .title {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .menu-item .description {
            font-size: 14px;
            color: #6b7280;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            position: absolute;
            top: 20px;
            left: 20px;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* NOTIFICATION STYLES */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #10b981;
        }

        .notification.error {
            background: #ef4444;
        }

        .notification.info {
            background: #3b82f6;
        }

        .notification.warning {
            background: #f59e0b;
        }

        /* CONTENT AREA */
        .content-area {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 120px);
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .content-title {
            font-size: 24px;
            color: #1f2937;
            font-weight: bold;
        }

        .back-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .back-btn:hover {
            background: #4b5563;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .login-card {
                padding: 30px 20px;
            }

            .menu-grid {
                grid-template-columns: 1fr;
                gap: 15px;
                padding: 20px 15px;
            }

            .menu-item {
                padding: 25px 15px;
            }

            .menu-item .icon {
                font-size: 40px;
            }

            .user-info {
                position: static;
                transform: none;
                margin-top: 10px;
            }

            .header {
                text-align: left;
            }

            .logout-btn {
                position: static;
                margin-top: 15px;
                width: 100%;
            }
        }

        /* LOADING STYLES */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* COTIZACIONES MODULE STYLES */
        .cotizaciones-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .cotizaciones-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .cotizaciones-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card-cotizaciones {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #2563eb;
            text-align: center;
        }

        .stat-card-cotizaciones.pendiente {
            border-left-color: #f59e0b;
        }

        .stat-card-cotizaciones.enviada {
            border-left-color: #3b82f6;
        }

        .stat-card-cotizaciones.vendida {
            border-left-color: #10b981;
        }

        .stat-card-cotizaciones.anulada {
            border-left-color: #ef4444;
        }

        .cotizaciones-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .cotizacion-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }

        .cotizacion-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .cotizacion-header {
            padding: 20px 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .cotizacion-consecutivo {
            font-size: 18px;
            font-weight: bold;
            color: #2563eb;
            font-family: monospace;
        }

        .cotizacion-estado {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .estado-pendiente {
            background: #fef3c7;
            color: #92400e;
        }

        .estado-enviada {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .estado-vendida {
            background: #d1fae5;
            color: #065f46;
        }

        .estado-anulada {
            background: #fee2e2;
            color: #991b1b;
        }

        .cotizacion-info {
            padding: 0 20px 20px;
        }

        .cotizacion-cliente {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .cotizacion-fecha {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .cotizacion-resumen {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .resumen-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .resumen-total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            font-size: 16px;
            color: #1f2937;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        }

        .cotizacion-productos {
            margin-bottom: 15px;
        }

        .productos-count {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .productos-preview {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .producto-tag {
            background: #eff6ff;
            color: #1d4ed8;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .cotizacion-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 15px;
        }

        .btn-cotizacion {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.3s;
            text-align: center;
        }

        .btn-cotizacion-edit {
            background: #f59e0b;
            color: white;
        }

        .btn-cotizacion-pdf {
            background: #ef4444;
            color: white;
        }

        .btn-cotizacion-confirmar {
            background: #10b981;
            color: white;
        }

        .btn-cotizacion-anular {
            background: #6b7280;
            color: white;
        }

        /* MODAL COTIZACION STYLES */
        .modal-cotizacion {
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .cotizacion-form-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .form-tab {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            cursor: pointer;
            color: #6b7280;
            font-weight: 500;
            border-bottom: 2px solid transparent;
        }

        .form-tab.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }

        .cliente-selector {
            margin-bottom: 20px;
        }

        .cliente-search {
            position: relative;
            margin-bottom: 15px;
        }

        .clientes-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .clientes-dropdown.show {
            display: block;
        }

        .cliente-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .cliente-option:hover {
            background: #f8fafc;
        }

        .cliente-option-nombre {
            font-weight: 500;
            color: #1f2937;
        }

        .cliente-option-nit {
            font-size: 12px;
            color: #6b7280;
        }

        .cliente-selected {
            background: #eff6ff;
            border: 2px solid #2563eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .productos-section {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .productos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .productos-search {
            position: relative;
            margin-bottom: 15px;
        }

        .productos-cotizacion-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .productos-cotizacion-dropdown.show {
            display: block;
        }

        .producto-cotizacion-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .producto-cotizacion-option:hover {
            background: #f8fafc;
        }

        .producto-option-image {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            overflow: hidden;
        }

        .producto-option-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .productos-lista {
            min-height: 200px;
        }

        .producto-cotizacion-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            background: white;
        }

        .producto-item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            overflow: hidden;
        }

        .producto-item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .producto-item-info {
            flex: 1;
        }

        .producto-item-nombre {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .producto-item-codigo {
            font-size: 12px;
            color: #6b7280;
            font-family: monospace;
        }

        .producto-item-precio {
            font-size: 14px;
            color: #059669;
            font-weight: 500;
        }

        .cantidad-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-cantidad {
            width: 32px;
            height: 32px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #374151;
        }

        .btn-cantidad:hover {
            background: #f3f4f6;
        }

        .cantidad-input {
            width: 60px;
            text-align: center;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-weight: 600;
        }

        .btn-eliminar-producto {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .cotizacion-totales {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .total-final {
            display: flex;
            justify-content: space-between;
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            padding-top: 12px;
            border-top: 2px solid #e5e7eb;
        }

        .empty-productos {
            text-align: center;
            padding: 40px;
            color: #6b7280;
            border: 2px dashed #e5e7eb;
            border-radius: 8px;
        }

        /* ENTRADAS MODULE STYLES */
        .entradas-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .entradas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .entradas-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .entradas-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card-entradas {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #2563eb;
            text-align: center;
        }

        .stat-card-entradas.entrada {
            border-left-color: #10b981;
        }

        .stat-card-entradas.devolucion {
            border-left-color: #f59e0b;
        }

        .stat-card-entradas.productos {
            border-left-color: #8b5cf6;
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .stat-description {
            font-size: 14px;
            color: #6b7280;
        }

        .entradas-list {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .entradas-table {
            width: 100%;
            border-collapse: collapse;
        }

        .entradas-table th {
            background: #f8fafc;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }

        .entradas-table td {
            padding: 15px 12px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }

        .entradas-table tr:hover {
            background: #f9fafb;
        }

        .motivo-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .motivo-entrada {
            background: #d1fae5;
            color: #065f46;
        }

        .motivo-devolucion {
            background: #fef3c7;
            color: #92400e;
        }

        .producto-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .producto-codigo {
            font-family: monospace;
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: #374151;
        }

        .precio-cell {
            text-align: right;
        }

        .precio-mayor {
            color: #059669;
            font-weight: 600;
        }

        .precio-menor {
            color: #d97706;
            font-weight: 600;
        }

        .cantidad-cell {
            text-align: center;
            font-weight: 600;
            color: #1f2937;
        }

        /* MODAL ENTRADA STYLES */
        .modal-entrada {
            max-width: 700px;
        }

        .producto-selector {
            margin-bottom: 20px;
        }

        .producto-search {
            position: relative;
            margin-bottom: 15px;
        }

        .producto-search input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .producto-search input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .productos-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .productos-dropdown.show {
            display: block;
        }

        .producto-option {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .producto-option:hover {
            background: #f8fafc;
        }

        .producto-option:last-child {
            border-bottom: none;
        }

        .producto-option-codigo {
            font-family: monospace;
            font-size: 12px;
            color: #6b7280;
        }

        .producto-option-nombre {
            font-weight: 500;
            color: #1f2937;
            margin: 2px 0;
        }

        .producto-option-stock {
            font-size: 12px;
            color: #9ca3af;
        }

        .producto-selected {
            background: #eff6ff;
            border: 2px solid #2563eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .selected-producto-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .selected-producto-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            overflow: hidden;
        }

        .selected-producto-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .selected-producto-details h4 {
            margin: 0 0 5px 0;
            color: #1f2937;
            font-size: 16px;
        }

        .selected-producto-details p {
            margin: 2px 0;
            font-size: 13px;
            color: #6b7280;
        }

        .btn-change-producto {
            background: #6b7280;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: auto;
        }

        .btn-change-producto:hover {
            background: #4b5563;
        }

        .precios-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
        }

        .precio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .precio-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .precio-input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 500;
        }

        .precio-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .precio-sugerencia {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }

        .precio-sugerencia .sugerido {
            color: #2563eb;
            font-weight: 500;
            cursor: pointer;
            text-decoration: underline;
        }

        .motivo-section {
            margin-bottom: 20px;
        }

        .motivo-options {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .motivo-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .motivo-option.selected {
            border-color: #2563eb;
            background: #eff6ff;
        }

        .motivo-option .icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .motivo-option .title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .motivo-option .description {
            font-size: 12px;
            color: #6b7280;
        }

        .cantidad-section {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .cantidad-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
            background: white;
        }

        .cantidad-input:focus {
            outline: none;
            border-color: #0284c7;
        }

        .stock-preview {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #bae6fd;
            font-size: 14px;
            text-align: center;
        }

        .stock-actual {
            color: #6b7280;
        }

        .stock-nuevo {
            color: #059669;
            font-weight: 600;
            font-size: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state .icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* PRODUCTOS MODULE STYLES */
        .productos-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .productos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .productos-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            min-width: 150px;
        }

        .productos-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.danger {
            border-left-color: #ef4444;
        }

        .stat-card.success {
            border-left-color: #10b981;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
        }

        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .producto-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
        }

        .producto-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .producto-image {
            width: 100%;
            height: 200px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #9ca3af;
            overflow: hidden;
            position: relative;
        }

        .producto-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .stock-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .stock-normal {
            background: #10b981;
        }

        .stock-bajo {
            background: #f59e0b;
        }

        .stock-agotado {
            background: #ef4444;
        }

        .producto-info {
            padding: 20px;
        }

        .producto-codigo {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
            font-family: monospace;
        }

        .producto-nombre {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .producto-stock {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
        }

        .stock-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .stock-actual {
            font-size: 16px;
            font-weight: bold;
            color: #1f2937;
        }

        .stock-minimo {
            font-size: 12px;
            color: #6b7280;
        }

        .stock-icon {
            font-size: 24px;
        }

        .producto-fecha {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 15px;
        }

        .producto-actions {
            display: flex;
            gap: 8px;
        }

        .btn-producto {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-producto-edit {
            background: #f59e0b;
            color: white;
        }

        .btn-producto-edit:hover {
            background: #d97706;
        }

        .btn-producto-delete {
            background: #ef4444;
            color: white;
        }

        .btn-producto-delete:hover {
            background: #dc2626;
        }

        /* MODAL PRODUCTO STYLES */
        .modal-producto {
            max-width: 600px;
        }

        .image-upload-section {
            margin-bottom: 20px;
        }

        .image-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        .image-upload:hover {
            border-color: #2563eb;
        }

        .image-upload.dragover {
            border-color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }

        .image-preview {
            width: 150px;
            height: 150px;
            border-radius: 8px;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #9ca3af;
            overflow: hidden;
            border: 2px solid #e5e7eb;
        }

        .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .upload-text {
            font-size: 14px;
            color: #6b7280;
        }

        .upload-text strong {
            color: #2563eb;
        }

        .stock-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .stock-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .stock-input-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .stock-input-group input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .stock-alert {
            grid-column: 1 / -1;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            text-align: center;
        }

        .alert-info {
            background: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .alert-warning {
            background: #fffbeb;
            color: #d97706;
            border: 1px solid #fed7aa;
        }

        /* PARAMETROS MODULE STYLES */
        .parametros-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .parametros-tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #2563eb;
            border-bottom-color: #2563eb;
            background: rgba(37, 99, 235, 0.05);
        }

        .tab-button:hover {
            background: rgba(37, 99, 235, 0.05);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .config-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            text-align: center;
        }

        .logo-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #6b7280;
            overflow: hidden;
        }

        .logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .btn-upload {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-upload:hover {
            background: #1d4ed8;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .config-item {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
        }

        .config-item h4 {
            margin: 0 0 10px 0;
            color: #1f2937;
            font-size: 16px;
        }

        .config-item .description {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 15px;
        }

        .config-item input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        /* ZONAS STYLES */
        .zonas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .zonas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .zona-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s;
        }

        .zona-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .zona-card.inactive {
            opacity: 0.6;
            background: #f9fafb;
        }

        .zona-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .zona-id {
            font-size: 18px;
            font-weight: bold;
            color: #2563eb;
        }

        .zona-nombre {
            font-size: 16px;
            color: #1f2937;
            margin: 5px 0;
        }

        .zona-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }

        .status-dot-zona {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .status-dot-zona.inactive {
            background: #ef4444;
        }

        .zona-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-zona {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-zona-edit {
            background: #f59e0b;
            color: white;
        }

        .btn-zona-toggle {
            background: #6b7280;
            color: white;
        }

        .btn-zona-edit:hover {
            background: #d97706;
        }

        .btn-zona-toggle:hover {
            background: #4b5563;
        }

        .zona-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .zona-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
        }

        .zona-form button {
            padding: 10px 20px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .zona-form button:hover {
            background: #1d4ed8;
        }

        .save-section {
            background: #f8fafc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-top: 30px;
        }

        .btn-save-parametros {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .btn-save-parametros:hover {
            background: #059669;
        }

        .btn-save-parametros:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        /* CLIENTES MODULE STYLES */
        .clientes-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .clientes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .clientes-header h2 {
            color: #1f2937;
            font-size: 24px;
            margin: 0;
        }

        .btn-nuevo {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .btn-nuevo:hover {
            background: #1d4ed8;
        }

        .search-container {
            margin-bottom: 20px;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .clientes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .cliente-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s;
        }

        .cliente-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .cliente-nombre {
            font-size: 18px;
            font-weight: bold;
            color: #1f2937;
            margin: 0 0 5px 0;
        }

        .cliente-nit {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }

        .cliente-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-activo {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactivo {
            background: #fee2e2;
            color: #991b1b;
        }

        .cliente-info {
            margin-bottom: 15px;
        }

        .cliente-info p {
            margin: 5px 0;
            font-size: 14px;
            color: #4b5563;
        }

        .cliente-zona {
            display: inline-block;
            background: #eff6ff;
            color: #1d4ed8;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .cliente-actions {
            display: flex;
            gap: 10px;
        }

        .btn-action {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-editar {
            background: #f59e0b;
            color: white;
        }

        .btn-editar:hover {
            background: #d97706;
        }

        .btn-eliminar {
            background: #ef4444;
            color: white;
        }

        .btn-eliminar:hover {
            background: #dc2626;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #1f2937;
            margin: 0;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            color: #374151;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .required {
            color: #ef4444;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-primary:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .no-results .icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .clientes-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .btn-nuevo {
                width: 100%;
            }

            .clientes-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 20px;
                margin: 20px;
            }

            .cliente-actions {
                flex-direction: column;
            }
        }

        /* VERSION INFO */
        .version-info {
            position: fixed;
            bottom: 10px;
            left: 10px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            background: rgba(0,0,0,0.3);
            padding: 5px 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="logo">TC</div>
            <h2 class="login-title">Tool Center</h2>
            <p style="color: #6b7280; margin-bottom: 30px;">Sistema de Cotizaciones</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" class="form-control" required autocomplete="username">
                </div>
                
                <div class="form-group">
                    <label for="password">Contrasea</label>
                    <input type="password" id="password" class="form-control" required autocomplete="current-password">
                </div>
                
                <button type="submit" id="loginBtn" class="btn">
                    <span class="btn-text">Iniciar Sesin</span>
                    <span class="loading" style="display: none;"></span>
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APPLICATION -->
    <div id="mainApp" class="menu-container">
        <!-- HEADER -->
        <div class="header">
            <button class="logout-btn" onclick="logout()"> Cerrar Sesin</button>
            <h1>Tool Center</h1>
            <p class="subtitle">Sistema de Cotizaciones</p>
            <div class="user-info">
                <div> <span id="currentUser">Jorge Luis Hernndez</span></div>
                <div style="font-size: 12px; margin-top: 2px;">Administrador</div>
            </div>
        </div>

        <!-- STATUS BAR -->
        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionStatus">En lnea</span>
            </div>
            <div>
                <span id="lastSync">ltima sincronizacin: --:--</span>
            </div>
        </div>

        <!-- MENU GRID -->
<div id="menuScreen">
    <div class="menu-grid">
        <div class="menu-item" onclick="showClientes()">
            <div class="icon"></div>
            <div class="title">Clientes</div>
            <div class="description">Gestionar informacin de clientes y zonas</div>
        </div>
        <div class="menu-item" onclick="showProductos()">
            <div class="icon"></div>
            <div class="title">Productos</div>
            <div class="description">Catlogo de productos y control de stock</div>
        </div>
        <div class="menu-item" onclick="showEntradas()">
            <div class="icon"></div>
            <div class="title">Entradas</div>
            <div class="description">Registro de entradas y devoluciones</div>
        </div>
        <div class="menu-item" onclick="showCotizaciones()">
            <div class="icon"></div>
            <div class="title">Cotizaciones</div>
            <div class="description">Crear y gestionar cotizaciones</div>
        </div>
        <div class="menu-item" onclick="showParametros()">
            <div class="icon"></div>
            <div class="title">Parmetros</div>
            <div class="description">Configuracin del sistema y empresa</div>
        </div>
        <div class="menu-item" onclick="showInformes()">
            <div class="icon"></div>
            <div class="title">Informes</div>
            <div class="description">Reportes y estadsticas</div>
        </div>
    </div>
</div>
        <!-- CONTENT AREA (for modules) -->
        <div id="contentArea" class="content-area">
            <div class="content-header">
                <h2 class="content-title" id="contentTitle">Mdulo</h2>
                <button class="back-btn" onclick="showMenu()">?Volver al Men</button>
            </div>
            <div id="contentBody">
                <!-- Module content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- NOTIFICATION CONTAINER -->
    <div id="notification" class="notification"></div>

    <!-- VERSION INFO -->
    <div class="version-info">v1.0 - Sistema de Cotizaciones</div>

    <!-- SUPABASE CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <script>
        // ============================================
        // CONFIGURACIN GLOBAL
        // ============================================
        
        // Configuracin de Supabase
        const SUPABASE_URL = 'https://nipwdvnhngdydpclvhco.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pcHdkdm5obmdkeWRwY2x2aGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUzOTcxNzcsImV4cCI6MjA3MDk3MzE3N30.nMkXseYCsdh_eCfWBXBYsvzObbXjq4Uj3_sBvq2pF0E';
        
        // Inicializar Supabase con verificacin
        let supabase = null;
        
        // Verificar que Supabase est disponible
        function initSupabase() {
            try {
                if (typeof window.supabase !== 'undefined') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('?Supabase inicializado correctamente');
                    return true;
                } else {
                    console.warn(' Supabase no disponible, modo offline');
                    return false;
                }
            } catch (error) {
                console.warn(' Error inicializando Supabase:', error);
                return false;
            }
        }
        
        // Variables globales
        let currentUser = null;
        let isOnlineStatus = navigator.onLine;
        let db = null; // IndexedDB instance
        
        // ============================================
        // INICIALIZACIN
        // ============================================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log(' Iniciando Sistema de Cotizaciones v1.0');
            
            // Inicializar Supabase
            const supabaseReady = initSupabase();
            
            // Inicializar base de datos local
            await initIndexedDB();
            
            // Configurar eventos de conectividad
            setupConnectivityEvents();
            
            // Configurar formulario de login
            setupLoginForm();
            
            // Verificar sesin existente
            checkExistingSession();
            
            updateConnectionStatus();
            
            if (supabaseReady) {
                showNotification('Sistema listo - Conectado a Supabase', 'success');
            } else {
                showNotification('Sistema listo - Solo modo offline', 'warning');
            }
        });

        // ============================================
        // FUNCIONES DE AUTENTICACIN
        // ============================================
        
        async function validateLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification('Por favor complete todos los campos', 'warning');
                return false;
            }
            
            showLoading(true);
            
            try {
                if (isOnlineStatus && supabase) {
                    // Validar contra Supabase
                    const { data, error } = await supabase
                        .from('usuarios')
                        .select('*')
                        .eq('username', username)
                        .eq('activo', true)
                        .single();
                    
                    if (error || !data) {
                        throw new Error('Usuario no encontrado o inactivo');
                    }
                    
                    // Validar contrasea (en produccin debera usar hash)
                    if (password !== 'Admin2025*') {
                        throw new Error('Contrasea incorrecta');
                    }
                    
                    // Actualizar ltimo acceso
                    await supabase
                        .from('usuarios')
                        .update({ ultimo_acceso: new Date().toISOString() })
                        .eq('id', data.id);
                    
                    // Registrar en historial
                    await registerAction('Login exitoso', 'usuarios', data.id, `Usuario: ${username}`);
                    
                    currentUser = data;
                } else {
                    // Validacin offline con credenciales hardcodeadas
                    if (username === 'jhernandez' && password === 'Admin2025*') {
                        currentUser = {
                            id: 1,
                            username: 'jhernandez',
                            nombre: 'Jorge Luis Hernndez',
                            perfil: 'admin'
                        };
                    } else {
                        throw new Error('Credenciales incorrectas (modo offline)');
                    }
                }
                
                // Guardar sesin
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                localStorage.setItem('loginTime', new Date().toISOString());
                
                showNotification('Login exitoso', 'success');
                showMenu();
                
                return true;
                
            } catch (error) {
                console.error('Error en login:', error);
                showNotification(error.message || 'Error al iniciar sesin', 'error');
                return false;
            } finally {
                showLoading(false);
            }
        }
        
        function showMenu() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('menuScreen').style.display = 'block';
            document.getElementById('contentArea').style.display = 'none';
            
            if (currentUser) {
                document.getElementById('currentUser').textContent = currentUser.nombre;
            }
            
            updateConnectionStatus();
        }
        
        function logout() {
            // Registrar logout antes de limpiar sesin
            if (isOnlineStatus && currentUser) {
                registerAction('Logout', 'usuarios', currentUser.id, 'Sesin cerrada');
            }
            
            // Limpiar sesin
            localStorage.removeItem('currentUser');
            localStorage.removeItem('loginTime');
            currentUser = null;
            
            // Mostrar pantalla de login
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            
            // Limpiar formulario
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            showNotification('Sesin cerrada correctamente', 'info');
        }

        // ============================================
        // FUNCIONES DE NAVEGACIN (MDULOS)
        // ============================================
        
        async function showClientes() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'Clientes';
            
            // Variables globales del mdulo
            let clientesList = [];
            let zonasList = [];
            let filteredClientes = [];
            let currentClienteEdit = null;
            
            // Crear interfaz
            document.getElementById('contentBody').innerHTML = `
                <div class="clientes-container">
                    <div class="clientes-header">
                        <h2>Gestin de Clientes</h2>
                        <button class="btn-nuevo" onclick="openClienteModal()">
                            <span>+ Nuevo Cliente</span>
                        </button>
                    </div>
                    
                    <div class="search-container">
                        <input type="text" id="searchClientes" class="search-input" 
                               placeholder=" Buscar por nombre o NIT..." 
                               oninput="filterClientes()">
                    </div>
                    
                    <div id="clientesList" class="clientes-grid">
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <p>Cargando clientes...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Cliente -->
                <div id="modalCliente" class="modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title" id="modalTitle">Nuevo Cliente</h3>
                            <button class="btn-close" onclick="closeClienteModal()">&times;</button>
                        </div>
                        
                        <form id="formCliente" onsubmit="saveCliente(event)">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clienteNit">NIT <span class="required">*</span></label>
                                    <input type="text" id="clienteNit" class="form-control" required 
                                           placeholder="12345678-9" maxlength="20">
                                </div>
                                <div class="form-group">
                                    <label for="clienteZona">Zona <span class="required">*</span></label>
                                    <select id="clienteZona" class="form-control" required>
                                        <option value="">Seleccionar zona</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="clienteNombre">Nombre <span class="required">*</span></label>
                                    <input type="text" id="clienteNombre" class="form-control" required 
                                           placeholder="Nombre completo o empresa" maxlength="100">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clienteCorreo">Correo</label>
                                    <input type="email" id="clienteCorreo" class="form-control" 
                                           placeholder="correo@empresa.com" maxlength="100">
                                </div>
                                <div class="form-group">
                                    <label for="clienteCelular">Telfono Celular</label>
                                    <input type="tel" id="clienteCelular" class="form-control" 
                                           placeholder="3001234567" maxlength="20">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="clienteFijo">Telfono Fijo</label>
                                    <input type="tel" id="clienteFijo" class="form-control" 
                                           placeholder="2601234" maxlength="20">
                                </div>
                                <div style="display: flex; align-items: end;">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0;">
                                        <input type="checkbox" id="clienteActivo" checked>
                                        <span>Cliente activo</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="clienteDireccion">Direccin</label>
                                    <textarea id="clienteDireccion" class="form-control" rows="2" 
                                              placeholder="Direccin completa" maxlength="200"></textarea>
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn-secondary" onclick="closeClienteModal()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn-primary" id="btnSaveCliente">
                                    <span class="btn-text">Guardar Cliente</span>
                                    <span class="loading" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Funciones del mdulo
            window.openClienteModal = function(cliente = null) {
                currentClienteEdit = cliente;
                const modal = document.getElementById('modalCliente');
                const title = document.getElementById('modalTitle');
                const form = document.getElementById('formCliente');
                const nitField = document.getElementById('clienteNit');
                
                if (cliente) {
                    title.textContent = 'Editar Cliente';
                    nitField.disabled = true;
                    fillForm(cliente);
                } else {
                    title.textContent = 'Nuevo Cliente';
                    nitField.disabled = false;
                    form.reset();
                    document.getElementById('clienteActivo').checked = true;
                }
                
                loadZonasInSelect();
                modal.classList.add('show');
            };
            
            window.closeClienteModal = function() {
                document.getElementById('modalCliente').classList.remove('show');
                currentClienteEdit = null;
            };
            
            window.filterClientes = function() {
                const search = document.getElementById('searchClientes').value.toLowerCase();
                filteredClientes = clientesList.filter(cliente => 
                    cliente.nombre.toLowerCase().includes(search) ||
                    cliente.nit.toLowerCase().includes(search)
                );
                renderClientes();
            };
            
            window.saveCliente = async function(event) {
                event.preventDefault();
                
                const formData = getFormData();
                const isEdit = currentClienteEdit !== null;
                
                // Validaciones
                const validation = await validateCliente(formData, isEdit);
                if (!validation.valid) {
                    showNotification(validation.message, 'error');
                    return;
                }
                
                showLoadingButton(true);
                
                try {
                    if (isEdit) {
                        await updateCliente(formData);
                        showNotification('Cliente actualizado correctamente', 'success');
                    } else {
                        await createCliente(formData);
                        showNotification('Cliente creado correctamente', 'success');
                    }
                    
                    await registerAction(
                        isEdit ? 'Actualizar cliente' : 'Crear cliente',
                        'clientes',
                        formData.nit,
                        `Cliente: ${formData.nombre}`
                    );
                    
                    closeClienteModal();
                    await loadClientes();
                    
                } catch (error) {
                    console.error('Error guardando cliente:', error);
                    showNotification('Error al guardar cliente: ' + error.message, 'error');
                } finally {
                    showLoadingButton(false);
                }
            };
            
            window.editCliente = function(nit) {
                const cliente = clientesList.find(c => c.nit === nit);
                if (cliente) {
                    openClienteModal(cliente);
                }
            };
            
            window.deleteCliente = async function(nit) {
                const cliente = clientesList.find(c => c.nit === nit);
                if (!cliente) return;
                
                const confirm = window.confirm(
                    `Est seguro de eliminar el cliente "${cliente.nombre}"?\n\n` +
                    'El cliente ser marcado como inactivo y no se eliminar permanentemente.'
                );
                
                if (!confirm) return;
                
                try {
                    await executeQuery('clientes', 'update', {
                        updates: { activo: false },
                        where: { column: 'nit', value: nit }
                    });
                    
                    await registerAction('Eliminar cliente', 'clientes', nit, `Cliente: ${cliente.nombre}`);
                    showNotification('Cliente eliminado correctamente', 'success');
                    await loadClientes();
                    
                } catch (error) {
                    console.error('Error eliminando cliente:', error);
                    showNotification('Error al eliminar cliente: ' + error.message, 'error');
                }
            };
            
            // Funciones auxiliares
            function getFormData() {
                return {
                    nit: document.getElementById('clienteNit').value.trim(),
                    nombre: document.getElementById('clienteNombre').value.trim(),
                    correo: document.getElementById('clienteCorreo').value.trim(),
                    direccion: document.getElementById('clienteDireccion').value.trim(),
                    tel_celular: document.getElementById('clienteCelular').value.trim(),
                    tel_fijo: document.getElementById('clienteFijo').value.trim(),
                    zona: document.getElementById('clienteZona').value,
                    activo: document.getElementById('clienteActivo').checked
                };
            }
            
            function fillForm(cliente) {
                document.getElementById('clienteNit').value = cliente.nit;
                document.getElementById('clienteNombre').value = cliente.nombre;
                document.getElementById('clienteCorreo').value = cliente.correo || '';
                document.getElementById('clienteDireccion').value = cliente.direccion || '';
                document.getElementById('clienteCelular').value = cliente.tel_celular || '';
                document.getElementById('clienteFijo').value = cliente.tel_fijo || '';
                document.getElementById('clienteZona').value = cliente.zona || '';
                document.getElementById('clienteActivo').checked = cliente.activo;
            }
            
            async function validateCliente(data, isEdit) {
                // Validar campos obligatorios
                if (!data.nit || !data.nombre || !data.zona) {
                    return { valid: false, message: 'Complete todos los campos obligatorios (*)' };
                }
                
                // Validar formato de email
                if (data.correo && !validateEmail(data.correo)) {
                    return { valid: false, message: 'El formato del correo no es vlido' };
                }
                
                // Validar telfonos
                if (data.tel_celular && !validatePhone(data.tel_celular)) {
                    return { valid: false, message: 'El telfono celular debe contener solo nmeros' };
                }
                
                if (data.tel_fijo && !validatePhone(data.tel_fijo)) {
                    return { valid: false, message: 'El telfono fijo debe contener solo nmeros' };
                }
                
                // Validar NIT nico (solo para nuevos clientes)
                if (!isEdit) {
                    const existingCliente = clientesList.find(c => c.nit === data.nit);
                    if (existingCliente) {
                        return { valid: false, message: 'Ya existe un cliente con ese NIT' };
                    }
                }
                
                return { valid: true };
            }
            
            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }
            
            function validatePhone(phone) {
                const phoneRegex = /^\d+$/;
                return phoneRegex.test(phone);
            }
            
            async function createCliente(data) {
                const clienteData = {
                    ...data,
                    fecha_creacion: new Date().toISOString()
                };
                
                await executeQuery('clientes', 'insert', [clienteData]);
            }
            
            async function updateCliente(data) {
                await executeQuery('clientes', 'update', {
                    updates: data,
                    where: { column: 'nit', value: data.nit }
                });
            }
            
            async function loadClientes() {
                try {
                    let clientes = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('clientes', 'select', {});
                        clientes = result.data || [];
                    } else {
                        clientes = await getOffline('clientes');
                    }
                    
                    clientesList = clientes.sort((a, b) => a.nombre.localeCompare(b.nombre));
                    filteredClientes = [...clientesList];
                    renderClientes();
                    
                } catch (error) {
                    console.error('Error cargando clientes:', error);
                    showNotification('Error al cargar clientes', 'error');
                }
            }
            
            async function loadZonas() {
                try {
                    let zonas = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('zonas', 'select', {
                            select: 'id, nombre, activa'
                        });
                        zonas = result.data || [];
                    } else {
                        zonas = await getOffline('zonas');
                    }
                    
                    zonasList = zonas.filter(z => z.activa).sort((a, b) => a.id.localeCompare(b.id));
                    
                    // Si no hay zonas, crear algunas por defecto
                    if (zonasList.length === 0) {
                        zonasList = [
                            { id: 'zona1', nombre: 'Centro', activa: true },
                            { id: 'zona2', nombre: 'Norte', activa: true },
                            { id: 'zona3', nombre: 'Sur', activa: true },
                            { id: 'zona4', nombre: 'Oriente', activa: true },
                            { id: 'zona5', nombre: 'Occidente', activa: true }
                        ];
                    }
                    
                } catch (error) {
                    console.error('Error cargando zonas:', error);
                    // Usar zonas por defecto en caso de error
                    zonasList = [
                        { id: 'zona1', nombre: 'Centro', activa: true },
                        { id: 'zona2', nombre: 'Norte', activa: true },
                        { id: 'zona3', nombre: 'Sur', activa: true }
                    ];
                }
            }
            
            function loadZonasInSelect() {
                const select = document.getElementById('clienteZona');
                select.innerHTML = '<option value="">Seleccionar zona</option>';
                
                zonasList.forEach(zona => {
                    const option = document.createElement('option');
                    option.value = zona.id;
                    option.textContent = `${zona.id} - ${zona.nombre}`;
                    select.appendChild(option);
                });
            }
            
            function renderClientes() {
                const container = document.getElementById('clientesList');
                
                if (filteredClientes.length === 0) {
                    container.innerHTML = `
                        <div class="no-results">
                            <div class="icon"></div>
                            <h3>No se encontraron clientes</h3>
                            <p>No hay clientes que coincidan con la bsqueda</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = filteredClientes.map(cliente => {
                    const zona = zonasList.find(z => z.id === cliente.zona);
                    const zonaNombre = zona ? zona.nombre : cliente.zona;
                    
                    return `
                        <div class="cliente-card">
                            <div class="cliente-header">
                                <div>
                                    <h3 class="cliente-nombre">${cliente.nombre}</h3>
                                    <p class="cliente-nit">NIT: ${cliente.nit}</p>
                                </div>
                                <span class="cliente-status ${cliente.activo ? 'status-activo' : 'status-inactivo'}">
                                    ${cliente.activo ? 'Activo' : 'Inactivo'}
                                </span>
                            </div>
                            
                            <div class="cliente-info">
                                ${cliente.correo ? `<p> ${cliente.correo}</p>` : ''}
                                ${cliente.tel_celular ? `<p> ${cliente.tel_celular}</p>` : ''}
                                ${cliente.tel_fijo ? `<p> ${cliente.tel_fijo}</p>` : ''}
                                ${cliente.direccion ? `<p> ${cliente.direccion}</p>` : ''}
                                ${cliente.zona ? `<p> <span class="cliente-zona">${cliente.zona} - ${zonaNombre}</span></p>` : ''}
                            </div>
                            
                            <div class="cliente-actions">
                                <button class="btn-action btn-editar" onclick="editCliente('${cliente.nit}')">
                                     Editar
                                </button>
                                <button class="btn-action btn-eliminar" onclick="deleteCliente('${cliente.nit}')">
                                    ?Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function showLoadingButton(show) {
                const btn = document.getElementById('btnSaveCliente');
                const text = btn.querySelector('.btn-text');
                const loading = btn.querySelector('.loading');
                
                if (show) {
                    text.style.display = 'none';
                    loading.style.display = 'inline-block';
                    btn.disabled = true;
                } else {
                    text.style.display = 'inline';
                    loading.style.display = 'none';
                    btn.disabled = false;
                }
            }
            
            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeClienteModal();
                }
            });
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('modalCliente').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeClienteModal();
                }
            });
            
            // Inicializar mdulo
            await loadZonas();
            await loadClientes();
            
            registerAction('Acceso mdulo clientes', 'sistema', 'clientes', 'Usuario accedi al mdulo de clientes');
        }
        
        async function showProductos() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'Productos';
            
            // Variables globales del mdulo
            let productosList = [];
            let filteredProductos = [];
            let currentProductoEdit = null;
            let stockMinimoDefault = 5;
            
            // Crear interfaz
            document.getElementById('contentBody').innerHTML = `
                <div class="productos-container">
                    <div class="productos-header">
                        <h2>Catlogo de Productos</h2>
                        <button class="btn-nuevo" onclick="openProductoModal()">
                            <span>+ Nuevo Producto</span>
                        </button>
                    </div>
                    
                    <!-- Estadsticas -->
                    <div class="productos-stats" id="productosStats">
                        <!-- Estadsticas dinmicas -->
                    </div>
                    
                    <!-- Filtros -->
                    <div class="productos-filters">
                        <div class="filter-group">
                            <input type="text" id="searchProductos" class="search-input" 
                                   placeholder=" Buscar por cdigo o nombre..." 
                                   oninput="filterProductos()">
                        </div>
                        
                        <div class="filter-group">
                            <label> Stock:</label>
                            <select id="filterStock" class="filter-select" onchange="filterProductos()">
                                <option value="">Todos los productos</option>
                                <option value="normal">Stock normal</option>
                                <option value="bajo">Stock bajo</option>
                                <option value="agotado">Agotado</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label> Estado:</label>
                            <select id="filterEstado" class="filter-select" onchange="filterProductos()">
                                <option value="">Todos</option>
                                <option value="activo">Activos</option>
                                <option value="inactivo">Inactivos</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de productos -->
                    <div id="productosList" class="productos-grid">
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <p>Cargando productos...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Producto -->
                <div id="modalProducto" class="modal">
                    <div class="modal-content modal-producto">
                        <div class="modal-header">
                            <h3 class="modal-title" id="modalProductoTitle">Nuevo Producto</h3>
                            <button class="btn-close" onclick="closeProductoModal()">&times;</button>
                        </div>
                        
                        <form id="formProducto" onsubmit="saveProducto(event)">
                            <!-- Seccin de imagen -->
                            <div class="image-upload-section">
                                <label> Foto del Producto</label>
                                <div class="image-upload" id="imageUploadArea" 
                                     onclick="triggerFileInput()"
                                     ondrop="handleDrop(event)" 
                                     ondragover="handleDragOver(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <div class="image-preview" id="imagePreview">
                                        
                                    </div>
                                    <div class="upload-text">
                                        <strong>Clic aqu</strong> o arrastra una imagen<br>
                                        <span style="font-size: 12px;">JPG, PNG ?Mximo 1MB</span>
                                    </div>
                                    <input type="file" id="productoImage" accept="image/*" 
                                           style="display: none;" onchange="handleImageSelect(event)">
                                </div>
                            </div>
                            
                            <!-- Informacin bsica -->
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="productoCodigo">Cdigo <span class="required">*</span></label>
                                    <input type="text" id="productoCodigo" class="form-control" required 
                                           placeholder="PROD001" maxlength="50" style="text-transform: uppercase;">
                                </div>
                                <div style="display: flex; align-items: end; padding-bottom: 8px;">
                                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 0;">
                                        <input type="checkbox" id="productoActivo" checked>
                                        <span>Producto activo</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-row full">
                                <div class="form-group">
                                    <label for="productoNombre">Nombre del Producto <span class="required">*</span></label>
                                    <input type="text" id="productoNombre" class="form-control" required 
                                           placeholder="Nombre descriptivo del producto" maxlength="100">
                                </div>
                            </div>
                            
                            <!-- Seccin de stock -->
                            <div class="stock-section">
                                <div class="stock-input-group">
                                    <label for="stockActual"> Stock Actual</label>
                                    <input type="number" id="stockActual" min="0" max="99999" value="0"
                                           oninput="updateStockAlert()">
                                </div>
                                <div class="stock-input-group">
                                    <label for="stockMinimo"> Stock Mnimo</label>
                                    <input type="number" id="stockMinimo" min="0" max="1000" value="5"
                                           oninput="updateStockAlert()">
                                </div>
                                <div class="stock-alert alert-info" id="stockAlert">
                                     El sistema alertar cuando el stock sea menor al mnimo configurado
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn-secondary" onclick="closeProductoModal()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn-primary" id="btnSaveProducto">
                                    <span class="btn-text">Guardar Producto</span>
                                    <span class="loading" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Funciones del mdulo
            window.openProductoModal = function(producto = null) {
                currentProductoEdit = producto;
                const modal = document.getElementById('modalProducto');
                const title = document.getElementById('modalProductoTitle');
                const form = document.getElementById('formProducto');
                const codigoField = document.getElementById('productoCodigo');
                
                if (producto) {
                    title.textContent = 'Editar Producto';
                    codigoField.disabled = true;
                    fillProductoForm(producto);
                } else {
                    title.textContent = 'Nuevo Producto';
                    codigoField.disabled = false;
                    form.reset();
                    document.getElementById('productoActivo').checked = true;
                    document.getElementById('stockActual').value = 0;
                    document.getElementById('stockMinimo').value = stockMinimoDefault;
                    document.getElementById('imagePreview').innerHTML = '';
                    updateStockAlert();
                }
                
                modal.classList.add('show');
            };
            
            window.closeProductoModal = function() {
                document.getElementById('modalProducto').classList.remove('show');
                currentProductoEdit = null;
            };
            
            window.triggerFileInput = function() {
                document.getElementById('productoImage').click();
            };
            
            window.handleImageSelect = function(event) {
                const file = event.target.files[0];
                if (file) {
                    processImageFile(file);
                }
            };
            
            window.handleDrop = function(event) {
                event.preventDefault();
                document.getElementById('imageUploadArea').classList.remove('dragover');
                
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    processImageFile(files[0]);
                }
            };
            
            window.handleDragOver = function(event) {
                event.preventDefault();
                document.getElementById('imageUploadArea').classList.add('dragover');
            };
            
            window.handleDragLeave = function(event) {
                event.preventDefault();
                document.getElementById('imageUploadArea').classList.remove('dragover');
            };
            
            window.updateStockAlert = function() {
                const stockActual = parseInt(document.getElementById('stockActual').value) || 0;
                const stockMinimo = parseInt(document.getElementById('stockMinimo').value) || 0;
                const alert = document.getElementById('stockAlert');
                
                if (stockActual === 0) {
                    alert.className = 'stock-alert alert-warning';
                    alert.innerHTML = ' Producto sin stock - Se mostrar como AGOTADO';
                } else if (stockActual <= stockMinimo) {
                    alert.className = 'stock-alert alert-warning';
                    alert.innerHTML = ' Stock por debajo del mnimo - Alerta de STOCK BAJO';
                } else {
                    alert.className = 'stock-alert alert-info';
                    alert.innerHTML = '?Stock normal - El producto se mostrar disponible';
                }
            };
            
            window.filterProductos = function() {
                const search = document.getElementById('searchProductos').value.toLowerCase();
                const stockFilter = document.getElementById('filterStock').value;
                const estadoFilter = document.getElementById('filterEstado').value;
                
                filteredProductos = productosList.filter(producto => {
                    // Filtro de bsqueda
                    const matchSearch = producto.nombre.toLowerCase().includes(search) ||
                                      producto.codigo.toLowerCase().includes(search);
                    
                    // Filtro de stock
                    let matchStock = true;
                    if (stockFilter) {
                        const stockStatus = getStockStatus(producto);
                        matchStock = stockStatus === stockFilter;
                    }
                    
                    // Filtro de estado
                    let matchEstado = true;
                    if (estadoFilter) {
                        matchEstado = estadoFilter === 'activo' ? producto.activo : !producto.activo;
                    }
                    
                    return matchSearch && matchStock && matchEstado;
                });
                
                renderProductos();
            };
            
            window.saveProducto = async function(event) {
                event.preventDefault();
                
                const formData = getProductoFormData();
                const isEdit = currentProductoEdit !== null;
                
                // Validaciones
                const validation = await validateProducto(formData, isEdit);
                if (!validation.valid) {
                    showNotification(validation.message, 'error');
                    return;
                }
                
                showProductoLoading(true);
                
                try {
                    if (isEdit) {
                        await updateProducto(formData);
                        showNotification('Producto actualizado correctamente', 'success');
                    } else {
                        await createProducto(formData);
                        showNotification('Producto creado correctamente', 'success');
                    }
                    
                    await registerAction(
                        isEdit ? 'Actualizar producto' : 'Crear producto',
                        'productos',
                        formData.codigo,
                        `Producto: ${formData.nombre}`
                    );
                    
                    closeProductoModal();
                    await loadProductos();
                    
                } catch (error) {
                    console.error('Error guardando producto:', error);
                    showNotification('Error al guardar producto: ' + error.message, 'error');
                } finally {
                    showProductoLoading(false);
                }
            };
            
            window.editProducto = function(codigo) {
                const producto = productosList.find(p => p.codigo === codigo);
                if (producto) {
                    openProductoModal(producto);
                }
            };
            
            window.deleteProducto = async function(codigo) {
                const producto = productosList.find(p => p.codigo === codigo);
                if (!producto) return;
                
                const confirm = window.confirm(
                    `Est seguro de eliminar el producto "${producto.nombre}"?\n\n` +
                    'El producto ser marcado como inactivo y no se eliminar permanentemente.'
                );
                
                if (!confirm) return;
                
                try {
                    await executeQuery('productos', 'update', {
                        updates: { activo: false },
                        where: { column: 'codigo', value: codigo }
                    });
                    
                    await registerAction('Eliminar producto', 'productos', codigo, `Producto: ${producto.nombre}`);
                    showNotification('Producto eliminado correctamente', 'success');
                    await loadProductos();
                    
                } catch (error) {
                    console.error('Error eliminando producto:', error);
                    showNotification('Error al eliminar producto: ' + error.message, 'error');
                }
            };
            
            // Funciones auxiliares
            function processImageFile(file) {
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    showNotification('Solo se permiten archivos de imagen', 'error');
                    return;
                }
                
                // Validar tamao (1MB mximo)
                if (file.size > 1024 * 1024) {
                    showNotification('La imagen es muy grande. Mximo 1MB', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    document.getElementById('imagePreview').innerHTML = 
                        `<img src="${base64}" alt="Preview del producto">`;
                };
                reader.readAsDataURL(file);
            }
            
            function getProductoFormData() {
                const imageImg = document.querySelector('#imagePreview img');
                
                return {
                    codigo: document.getElementById('productoCodigo').value.trim().toUpperCase(),
                    nombre: document.getElementById('productoNombre').value.trim(),
                    foto_base64: imageImg ? imageImg.src : null,
                    stock_actual: parseInt(document.getElementById('stockActual').value) || 0,
                    stock_minimo: parseInt(document.getElementById('stockMinimo').value) || stockMinimoDefault,
                    activo: document.getElementById('productoActivo').checked
                };
            }
            
            function fillProductoForm(producto) {
                document.getElementById('productoCodigo').value = producto.codigo;
                document.getElementById('productoNombre').value = producto.nombre;
                document.getElementById('stockActual').value = producto.stock_actual || 0;
                document.getElementById('stockMinimo').value = producto.stock_minimo || stockMinimoDefault;
                document.getElementById('productoActivo').checked = producto.activo;
                
                // Imagen
                const imagePreview = document.getElementById('imagePreview');
                if (producto.foto_base64) {
                    imagePreview.innerHTML = `<img src="${producto.foto_base64}" alt="Producto">`;
                } else {
                    imagePreview.innerHTML = '';
                }
                
                updateStockAlert();
            }
            
            async function validateProducto(data, isEdit) {
                // Validar campos obligatorios
                if (!data.codigo || !data.nombre) {
                    return { valid: false, message: 'Complete todos los campos obligatorios (*)' };
                }
                
                // Validar formato de cdigo
                if (!/^[A-Z0-9_-]+$/.test(data.codigo)) {
                    return { valid: false, message: 'El cdigo debe contener solo letras, nmeros, guiones y guiones bajos' };
                }
                
                // Validar cdigo nico (solo para nuevos productos)
                if (!isEdit) {
                    const existingProducto = productosList.find(p => p.codigo === data.codigo);
                    if (existingProducto) {
                        return { valid: false, message: 'Ya existe un producto con ese cdigo' };
                    }
                }
                
                // Validar stock
                if (data.stock_actual < 0 || data.stock_minimo < 0) {
                    return { valid: false, message: 'Las cantidades de stock no pueden ser negativas' };
                }
                
                return { valid: true };
            }
            
            async function createProducto(data) {
                const productoData = {
                    ...data,
                    fecha_hora_creacion: new Date().toISOString()
                };
                
                await executeQuery('productos', 'insert', [productoData]);
            }
            
            async function updateProducto(data) {
                await executeQuery('productos', 'update', {
                    updates: data,
                    where: { column: 'codigo', value: data.codigo }
                });
            }
            
            async function loadProductos() {
                try {
                    let productos = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('productos', 'select', {});
                        productos = result.data || [];
                    } else {
                        productos = await getOffline('productos');
                    }
                    
                    productosList = productos.sort((a, b) => a.nombre.localeCompare(b.nombre));
                    filteredProductos = [...productosList];
                    
                    renderProductos();
                    updateStats();
                    
                } catch (error) {
                    console.error('Error cargando productos:', error);
                    showNotification('Error al cargar productos', 'error');
                }
            }
            
            function getStockStatus(producto) {
                if (producto.stock_actual === 0) return 'agotado';
                if (producto.stock_actual <= producto.stock_minimo) return 'bajo';
                return 'normal';
            }
            
            function getStockBadge(producto) {
                const status = getStockStatus(producto);
                const badges = {
                    normal: { class: 'stock-normal', text: 'Stock OK' },
                    bajo: { class: 'stock-bajo', text: 'Stock Bajo' },
                    agotado: { class: 'stock-agotado', text: 'Agotado' }
                };
                
                const badge = badges[status];
                return `<span class="stock-badge ${badge.class}">${badge.text}</span>`;
            }
            
            function renderProductos() {
                const container = document.getElementById('productosList');
                
                if (filteredProductos.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 10px;"></div>
                            <h3>No se encontraron productos</h3>
                            <p>No hay productos que coincidan con los filtros seleccionados</p>
                        </div>
                    `;
                    return;
                }
                
               container.innerHTML = filteredProductos.map(producto => {
    const stockStatus = getStockStatus(producto);
    const stockIcon = {
        normal: '',
        bajo: '',
        agotado: ''
    }[stockStatus];
                    
                    return `
                        <div class="producto-card">
                            <div class="producto-image">
                                ${producto.foto_base64 ? 
                                    `<img src="${producto.foto_base64}" alt="${producto.nombre}">` : 
                                    ''
                                }
                                ${getStockBadge(producto)}
                            </div>
                            
                            <div class="producto-info">
                                <div class="producto-codigo">${producto.codigo}</div>
                                <h3 class="producto-nombre">${producto.nombre}</h3>
                                
                                <div class="producto-stock">
                                    <div class="stock-info">
                                        <div class="stock-actual">${producto.stock_actual} unidades</div>
                                        <div class="stock-minimo">Mnimo: ${producto.stock_minimo}</div>
                                    </div>
                                    <div class="stock-icon">${stockIcon}</div>
                                </div>
                                
                                <div class="producto-fecha">
                                     ${formatDate(producto.fecha_hora_creacion)}
                                </div>
                                
                                <div class="producto-actions">
                                    <button class="btn-producto btn-producto-edit" onclick="editProducto('${producto.codigo}')">
                                         Editar
                                    </button>
                                    <button class="btn-producto btn-producto-delete" onclick="deleteProducto('${producto.codigo}')">
                                        ?Eliminar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            function updateStats() {
                const stats = {
                    total: productosList.length,
                    activos: productosList.filter(p => p.activo).length,
                    stockBajo: productosList.filter(p => p.activo && getStockStatus(p) === 'bajo').length,
                    agotado: productosList.filter(p => p.activo && getStockStatus(p) === 'agotado').length
                };
                
                document.getElementById('productosStats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${stats.total}</div>
                        <div class="stat-label"> Total Productos</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-number">${stats.activos}</div>
                        <div class="stat-label">?Productos Activos</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-number">${stats.stockBajo}</div>
                        <div class="stat-label"> Stock Bajo</div>
                    </div>
                    <div class="stat-card danger">
                        <div class="stat-number">${stats.agotado}</div>
                        <div class="stat-label">?Agotados</div>
                    </div>
                `;
            }
            
            function showProductoLoading(show) {
                const btn = document.getElementById('btnSaveProducto');
                const text = btn.querySelector('.btn-text');
                const loading = btn.querySelector('.loading');
                
                if (show) {
                    text.style.display = 'none';
                    loading.style.display = 'inline-block';
                    btn.disabled = true;
                } else {
                    text.style.display = 'inline';
                    loading.style.display = 'none';
                    btn.disabled = false;
                }
            }
            
            async function loadStockMinimo() {
                try {
                    if (isOnline() && supabase) {
                        const result = await executeQuery('parametros', 'select', { select: 'stock_minimo_default' });
                        if (result.data && result.data.length > 0) {
                            stockMinimoDefault = result.data[0].stock_minimo_default || 5;
                        }
                    }
                } catch (error) {
                    console.log('Usando stock mnimo por defecto:', stockMinimoDefault);
                }
            }
            
            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeProductoModal();
                }
            });
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('modalProducto').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeProductoModal();
                }
            });
            
            // Inicializar mdulo
            await loadStockMinimo();
            await loadProductos();
            
            registerAction('Acceso mdulo productos', 'sistema', 'productos', 'Usuario accedi al mdulo de productos');
        }
        
        async function showEntradas() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'Entradas';
            
            // Variables globales del mdulo
            let entradasList = [];
            let productosList = [];
            let filteredEntradas = [];
            let selectedProducto = null;
            let ultimaEntradaProducto = null;
            
            // Crear interfaz
            document.getElementById('contentBody').innerHTML = `
                <div class="entradas-container">
                    <div class="entradas-header">
                        <h2>Control de Inventario</h2>
                        <button class="btn-nuevo" onclick="openEntradaModal()">
                            <span>+ Nueva Entrada</span>
                        </button>
                    </div>
                    
                    <!-- Estadsticas -->
                    <div class="entradas-stats" id="entradasStats">
                        <!-- Estadsticas dinmicas -->
                    </div>
                    
                    <!-- Filtros -->
                    <div class="entradas-filters">
                        <div class="filter-group">
                            <input type="text" id="searchEntradas" class="search-input" 
                                   placeholder=" Buscar por producto..." 
                                   oninput="filterEntradas()">
                        </div>
                        
                        <div class="filter-group">
                            <label> Producto:</label>
                            <select id="filterProducto" class="filter-select" onchange="filterEntradas()">
                                <option value="">Todos los productos</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label> Motivo:</label>
                            <select id="filterMotivo" class="filter-select" onchange="filterEntradas()">
                                <option value="">Todos los movimientos</option>
                                <option value="entrada">Solo entradas</option>
                                <option value="devolucion">Solo devoluciones</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label> Perodo:</label>
                            <select id="filterPeriodo" class="filter-select" onchange="filterEntradas()">
                                <option value="">Todo el tiempo</option>
                                <option value="hoy">Hoy</option>
                                <option value="semana">Esta semana</option>
                                <option value="mes">Este mes</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de entradas -->
                    <div class="entradas-list">
                        <table class="entradas-table" id="entradasTable">
                            <thead>
                                <tr>
                                    <th> Fecha</th>
                                    <th> Producto</th>
                                    <th> Motivo</th>
                                    <th> Cantidad</th>
                                    <th> Precio Mayor</th>
                                    <th> Precio Menor</th>
                                    <th> Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="entradasTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                        <div style="font-size: 24px; margin-bottom: 10px;"></div>
                                        <p>Cargando movimientos de inventario...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Modal Nueva Entrada -->
                <div id="modalEntrada" class="modal">
                    <div class="modal-content modal-entrada">
                        <div class="modal-header">
                            <h3 class="modal-title">Nueva Entrada de Inventario</h3>
                            <button class="btn-close" onclick="closeEntradaModal()">&times;</button>
                        </div>
                        
                        <form id="formEntrada" onsubmit="saveEntrada(event)">
                            <!-- Selector de producto -->
                            <div class="form-group">
                                <label> Seleccionar Producto <span class="required">*</span></label>
                                <div class="producto-selector">
                                    <div class="producto-search" id="productoSearchContainer">
                                        <input type="text" id="productoSearch" class="form-control" 
                                               placeholder="Buscar producto por cdigo o nombre..."
                                               oninput="searchProductos()" onfocus="showProductosDropdown()">
                                        <div class="productos-dropdown" id="productosDropdown">
                                            <!-- Productos dinmicos -->
                                        </div>
                                    </div>
                                    
                                    <div class="producto-selected" id="productoSelected" style="display: none;">
                                        <div class="selected-producto-info">
                                            <div class="selected-producto-image" id="selectedProductoImage"></div>
                                            <div class="selected-producto-details">
                                                <h4 id="selectedProductoNombre">Producto</h4>
                                                <p>Cdigo: <span id="selectedProductoCodigo">-</span></p>
                                                <p>Stock actual: <span id="selectedProductoStock">0</span> unidades</p>
                                            </div>
                                            <button type="button" class="btn-change-producto" onclick="changeProducto()">
                                                Cambiar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Motivo -->
                            <div class="form-group motivo-section">
                                <label> Motivo del Movimiento <span class="required">*</span></label>
                                <div class="motivo-options">
                                    <div class="motivo-option" data-motivo="entrada" onclick="selectMotivo('entrada')">
                                        <div class="icon"></div>
                                        <div class="title">Entrada</div>
                                        <div class="description">Nueva mercanca</div>
                                    </div>
                                    <div class="motivo-option" data-motivo="devolucion" onclick="selectMotivo('devolucion')">
                                        <div class="icon"></div>
                                        <div class="title">Devolucin</div>
                                        <div class="description">Mercanca devuelta</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Precios -->
                            <div class="precios-section">
                                <div class="precio-group">
                                    <label> Precio al por Mayor <span class="required">*</span></label>
                                    <input type="number" id="valorMayor" class="precio-input" 
                                           step="0.01" min="0" required placeholder="0.00">
                                    <div class="precio-sugerencia" id="sugerenciaMayor">
                                        <!-- Sugerencia dinmica -->
                                    </div>
                                </div>
                                <div class="precio-group">
                                    <label> Precio al por Menor <span class="required">*</span></label>
                                    <input type="number" id="valorMenor" class="precio-input" 
                                           step="0.01" min="0" required placeholder="0.00">
                                    <div class="precio-sugerencia" id="sugerenciaMenor">
                                        <!-- Sugerencia dinmica -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Cantidad -->
                            <div class="form-group">
                                <label for="cantidad"> Cantidad <span class="required">*</span></label>
                                <div class="cantidad-section">
                                    <input type="number" id="cantidad" class="cantidad-input" 
                                           min="1" required placeholder="0" oninput="updateStockPreview()">
                                    <div class="stock-preview" id="stockPreview" style="display: none;">
                                        <div class="stock-actual">Stock actual: <span id="stockActualPreview">0</span></div>
                                        <div class="stock-nuevo">Stock despus: <span id="stockNuevoPreview">0</span> unidades</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn-secondary" onclick="closeEntradaModal()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn-primary" id="btnSaveEntrada">
                                    <span class="btn-text">Registrar Entrada</span>
                                    <span class="loading" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Funciones del mdulo
            window.openEntradaModal = function() {
                const modal = document.getElementById('modalEntrada');
                resetEntradaForm();
                modal.classList.add('show');
            };
            
            window.closeEntradaModal = function() {
                document.getElementById('modalEntrada').classList.remove('show');
                resetEntradaForm();
            };
            
            window.showProductosDropdown = function() {
                document.getElementById('productosDropdown').classList.add('show');
                if (document.getElementById('productoSearch').value === '') {
                    renderProductosDropdown(productosList.filter(p => p.activo));
                }
            };
            
            window.searchProductos = function() {
                const search = document.getElementById('productoSearch').value.toLowerCase();
                const dropdown = document.getElementById('productosDropdown');
                
                if (search.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const filtered = productosList.filter(p => 
                    p.activo && (
                        p.nombre.toLowerCase().includes(search) ||
                        p.codigo.toLowerCase().includes(search)
                    )
                );
                
                renderProductosDropdown(filtered);
                dropdown.classList.add('show');
            };
            
            window.selectProducto = async function(codigo) {
                const producto = productosList.find(p => p.codigo === codigo);
                if (!producto) return;
                
                selectedProducto = producto;
                
                // Mostrar producto seleccionado
                document.getElementById('productoSearchContainer').style.display = 'none';
                document.getElementById('productoSelected').style.display = 'block';
                
                // Llenar informacin
                document.getElementById('selectedProductoNombre').textContent = producto.nombre;
                document.getElementById('selectedProductoCodigo').textContent = producto.codigo;
                document.getElementById('selectedProductoStock').textContent = producto.stock_actual || 0;
                
                // Imagen
                const imageContainer = document.getElementById('selectedProductoImage');
                if (producto.foto_base64) {
                    imageContainer.innerHTML = `<img src="${producto.foto_base64}" alt="${producto.nombre}">`;
                } else {
                    imageContainer.innerHTML = '';
                }
                
                // Cargar ltima entrada para sugerencias
                await loadUltimaEntrada(codigo);
                updatePreciosSugerencias();
                updateStockPreview();
                
                // Ocultar dropdown
                document.getElementById('productosDropdown').classList.remove('show');
            }; 
            
            window.changeProducto = function() {
                document.getElementById('productoSearchContainer').style.display = 'block';
                document.getElementById('productoSelected').style.display = 'none';
                document.getElementById('productoSearch').value = '';
                document.getElementById('productoSearch').focus();
                selectedProducto = null;
                ultimaEntradaProducto = null;
                updatePreciosSugerencias();
                updateStockPreview();
            };
            
            window.selectMotivo = function(motivo) {
                // Actualizar UI
                document.querySelectorAll('.motivo-option').forEach(opt => opt.classList.remove('selected'));
                document.querySelector(`[data-motivo="${motivo}"]`).classList.add('selected');
                
                // Si es devolucin y hay ltima entrada, usar esos precios
                if (motivo === 'devolucion' && ultimaEntradaProducto) {
                    document.getElementById('valorMayor').value = ultimaEntradaProducto.valor_mayor;
                    document.getElementById('valorMenor').value = ultimaEntradaProducto.valor_menor;
                    updatePreciosSugerencias();
                }
            };
            
            window.useSugerencia = function(tipo) {
                if (!ultimaEntradaProducto) return;
                
                const valor = tipo === 'mayor' ? ultimaEntradaProducto.valor_mayor : ultimaEntradaProducto.valor_menor;
                document.getElementById(tipo === 'mayor' ? 'valorMayor' : 'valorMenor').value = valor;
            };
            
            window.updateStockPreview = function() {
                if (!selectedProducto) return;
                
                const cantidad = parseInt(document.getElementById('cantidad').value) || 0;
                const stockActual = selectedProducto.stock_actual || 0;
                const stockNuevo = stockActual + cantidad;
                
                if (cantidad > 0) {
                    document.getElementById('stockPreview').style.display = 'block';
                    document.getElementById('stockActualPreview').textContent = stockActual;
                    document.getElementById('stockNuevoPreview').textContent = stockNuevo;
                } else {
                    document.getElementById('stockPreview').style.display = 'none';
                }
            };
            
            window.filterEntradas = function() {
                const search = document.getElementById('searchEntradas').value.toLowerCase();
                const productoFilter = document.getElementById('filterProducto').value;
                const motivoFilter = document.getElementById('filterMotivo').value;
                const periodoFilter = document.getElementById('filterPeriodo').value;
                
                filteredEntradas = entradasList.filter(entrada => {
                    // Filtro de bsqueda
                    const producto = productosList.find(p => p.codigo === entrada.codigo_producto);
                    const matchSearch = !search || 
                        (producto && (
                            producto.nombre.toLowerCase().includes(search) ||
                            producto.codigo.toLowerCase().includes(search)
                        ));
                    
                    // Filtro de producto
                    const matchProducto = !productoFilter || entrada.codigo_producto === productoFilter;
                    
                    // Filtro de motivo
                    const matchMotivo = !motivoFilter || entrada.motivo === motivoFilter;
                    
                    // Filtro de perodo
                    let matchPeriodo = true;
                    if (periodoFilter) {
                        const entradaDate = new Date(entrada.fecha_hora);
                        const now = new Date();
                        
                        switch (periodoFilter) {
                            case 'hoy':
                                matchPeriodo = entradaDate.toDateString() === now.toDateString();
                                break;
                            case 'semana':
                                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                                matchPeriodo = entradaDate >= weekAgo;
                                break;
                            case 'mes':
                                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                                matchPeriodo = entradaDate >= monthAgo;
                                break;
                        }
                    }
                    
                    return matchSearch && matchProducto && matchMotivo && matchPeriodo;
                });
                
                renderEntradas();
            };
            
            window.saveEntrada = async function(event) {
                event.preventDefault();
                
                const formData = getEntradaFormData();
                
                // Validaciones
                const validation = validateEntrada(formData);
                if (!validation.valid) {
                    showNotification(validation.message, 'error');
                    return;
                }
                
                showEntradaLoading(true);
                
                try {
                    // Crear entrada
                    await createEntrada(formData);
                    
                    // Actualizar stock del producto
                    await updateProductoStock(formData.codigo_producto, formData.cantidad);
                    
                    showNotification('Entrada registrada correctamente', 'success');
                    
                    await registerAction(
                        `Registrar ${formData.motivo}`,
                        'entradas',
                        formData.codigo_producto,
                        `${formData.motivo} - ${formData.cantidad} unidades`
                    );
                    
                    closeEntradaModal();
                    await loadEntradas();
                    await loadProductos(); // Actualizar productos para stock
                    
                } catch (error) {
                    console.error('Error guardando entrada:', error);
                    showNotification('Error al registrar entrada: ' + error.message, 'error');
                } finally {
                    showEntradaLoading(false);
                }
            };
            
            window.verDetalleEntrada = function(entradaId) {
                const entrada = entradasList.find(e => e.id === entradaId);
                const producto = productosList.find(p => p.codigo === entrada.codigo_producto);
                
                if (!entrada || !producto) return;
                
                alert(
                    `DETALLE DE ENTRADA\n\n` +
                    `Producto: ${producto.nombre}\n` +
                    `Cdigo: ${entrada.codigo_producto}\n` +
                    `Motivo: ${entrada.motivo.toUpperCase()}\n` +
                    `Cantidad: ${entrada.cantidad} unidades\n` +
                    `Precio Mayor: ${formatCurrency(entrada.valor_mayor)}\n` +
                    `Precio Menor: ${formatCurrency(entrada.valor_menor)}\n` +
                    `Fecha: ${formatDate(entrada.fecha_hora)}\n` +
                    `Hora: ${new Date(entrada.fecha_hora).toLocaleTimeString()}`
                );
            };
            
            // Funciones auxiliares
            function resetEntradaForm() {
                selectedProducto = null;
                ultimaEntradaProducto = null;
                
                document.getElementById('formEntrada').reset();
                document.getElementById('productoSearchContainer').style.display = 'block';
                document.getElementById('productoSelected').style.display = 'none';
                document.getElementById('productoSearch').value = '';
                document.getElementById('productosDropdown').classList.remove('show');
                document.getElementById('stockPreview').style.display = 'none';
                
                // Reset motivo
                document.querySelectorAll('.motivo-option').forEach(opt => opt.classList.remove('selected'));
                
                updatePreciosSugerencias();
            }
            
            function renderProductosDropdown(productos) {
                const dropdown = document.getElementById('productosDropdown');
                
                if (productos.length === 0) {
                    dropdown.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #6b7280;">
                            No se encontraron productos activos
                        </div>
                    `;
                    return;
                }
                
                dropdown.innerHTML = productos.map(producto => `
                    <div class="producto-option" onclick="selectProducto('${producto.codigo}')">
                        <div class="producto-option-codigo">${producto.codigo}</div>
                        <div class="producto-option-nombre">${producto.nombre}</div>
                        <div class="producto-option-stock">Stock: ${producto.stock_actual || 0} unidades</div>
                    </div>
                `).join('');
            }
            
            function getEntradaFormData() {
                const selectedMotivo = document.querySelector('.motivo-option.selected');
                
                return {
                    codigo_producto: selectedProducto?.codigo,
                    valor_mayor: parseFloat(document.getElementById('valorMayor').value) || 0,
                    valor_menor: parseFloat(document.getElementById('valorMenor').value) || 0,
                    cantidad: parseInt(document.getElementById('cantidad').value) || 0,
                    motivo: selectedMotivo?.dataset.motivo
                };
            }
            
            function validateEntrada(data) {
                if (!data.codigo_producto) {
                    return { valid: false, message: 'Debe seleccionar un producto' };
                }
                
                if (!data.motivo) {
                    return { valid: false, message: 'Debe seleccionar un motivo (Entrada o Devolucin)' };
                }
                
                if (data.valor_mayor <= 0 || data.valor_menor <= 0) {
                    return { valid: false, message: 'Los precios deben ser mayores a cero' };
                }
                
                if (data.cantidad <= 0) {
                    return { valid: false, message: 'La cantidad debe ser mayor a cero' };
                }
                
                if (data.valor_menor > data.valor_mayor) {
                    return { valid: false, message: 'El precio al por menor no puede ser mayor al precio al por mayor' };
                }
                
                return { valid: true };
            }
            
            async function createEntrada(data) {
                const entradaData = {
                    ...data,
                    fecha_hora: new Date().toISOString()
                };
                
                await executeQuery('entradas', 'insert', [entradaData]);
            }
            
            async function updateProductoStock(codigo, cantidad) {
                const producto = productosList.find(p => p.codigo === codigo);
                if (!producto) return;
                
                const nuevoStock = (producto.stock_actual || 0) + cantidad;
                
                await executeQuery('productos', 'update', {
                    updates: { stock_actual: nuevoStock },
                    where: { column: 'codigo', value: codigo }
                });
                
                // Actualizar en memoria
                producto.stock_actual = nuevoStock;
            }
            
            async function loadUltimaEntrada(codigoProducto) {
                try {
                    if (isOnline() && supabase) {
                        const { data } = await supabase
                            .from('entradas')
                            .select('*')
                            .eq('codigo_producto', codigoProducto)
                            .order('fecha_hora', { ascending: false })
                            .limit(1);
                        
                        ultimaEntradaProducto = data && data.length > 0 ? data[0] : null;
                    } else {
                        const entradas = await getOffline('entradas');
                        const productEntradas = entradas
                            .filter(e => e.codigo_producto === codigoProducto)
                            .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                        
                        ultimaEntradaProducto = productEntradas.length > 0 ? productEntradas[0] : null;
                    }
                } catch (error) {
                    console.error('Error cargando ltima entrada:', error);
                    ultimaEntradaProducto = null;
                }
            }
            
            function updatePreciosSugerencias() {
                const sugerenciaMayor = document.getElementById('sugerenciaMayor');
                const sugerenciaMenor = document.getElementById('sugerenciaMenor');
                
                if (ultimaEntradaProducto) {
                    sugerenciaMayor.innerHTML = `
                        ltima entrada: <span class="sugerido" onclick="useSugerencia('mayor')">
                            ${formatCurrency(ultimaEntradaProducto.valor_mayor)}
                        </span>
                    `;
                    sugerenciaMenor.innerHTML = `
                        ltima entrada: <span class="sugerido" onclick="useSugerencia('menor')">
                            ${formatCurrency(ultimaEntradaProducto.valor_menor)}
                        </span>
                    `;
                } else {
                    sugerenciaMayor.innerHTML = 'No hay entradas previas para este producto';
                    sugerenciaMenor.innerHTML = 'No hay entradas previas para este producto';
                }
            }
            
            async function loadEntradas() {
                try {
                    let entradas = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('entradas', 'select', {});
                        entradas = result.data || [];
                    } else {
                        entradas = await getOffline('entradas');
                    }
                    
                    entradasList = entradas.sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                    filteredEntradas = [...entradasList];
                    
                    renderEntradas();
                    updateEntradasStats();
                    loadProductosFilter();
                    
                } catch (error) {
                    console.error('Error cargando entradas:', error);
                    showNotification('Error al cargar entradas', 'error');
                }
            }
            
            async function loadProductos() {
                try {
                    let productos = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('productos', 'select', {});
                        productos = result.data || [];
                    } else {
                        productos = await getOffline('productos');
                    }
                    
                    productosList = productos.sort((a, b) => a.nombre.localeCompare(b.nombre));
                    
                } catch (error) {
                    console.error('Error cargando productos:', error);
                    showNotification('Error al cargar productos', 'error');
                }
            }
            
            function loadProductosFilter() {
                const select = document.getElementById('filterProducto');
                select.innerHTML = '<option value="">Todos los productos</option>';
                
                const productosConEntradas = [...new Set(entradasList.map(e => e.codigo_producto))];
                
                productosConEntradas.forEach(codigo => {
                    const producto = productosList.find(p => p.codigo === codigo);
                    if (producto) {
                        const option = document.createElement('option');
                        option.value = codigo;
                        option.textContent = `${codigo} - ${producto.nombre}`;
                        select.appendChild(option);
                    }
                });
            }
            
            function renderEntradas() {
                const tbody = document.getElementById('entradasTableBody');
                
                if (filteredEntradas.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <div class="icon"></div>
                                <h3>No hay movimientos registrados</h3>
                                <p>No se encontraron entradas que coincidan con los filtros</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                tbody.innerHTML = filteredEntradas.map(entrada => {
                    const producto = productosList.find(p => p.codigo === entrada.codigo_producto);
                    const fecha = new Date(entrada.fecha_hora);
                    
                    return `
                        <tr>
                            <td>
                                <div style="font-weight: 500;">${formatDate(entrada.fecha_hora)}</div>
                                <div style="font-size: 12px; color: #6b7280;">
                                    ${fecha.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' })}
                                </div>
                            </td>
                            <td>
                                <div class="producto-info">
                                    <div>
                                        <div style="font-weight: 500; color: #1f2937;">${producto?.nombre || 'Producto no encontrado'}</div>
                                        <div class="producto-codigo">${entrada.codigo_producto}</div>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="motivo-badge motivo-${entrada.motivo}">
                                    ${entrada.motivo === 'entrada' ? ' ENTRADA' : ' DEVOLUCIN'}
                                </span>
                            </td>
                            <td class="cantidad-cell">
                                <strong>+${entrada.cantidad}</strong>
                            </td>
                            <td class="precio-cell">
                                <div class="precio-mayor">${formatCurrency(entrada.valor_mayor)}</div>
                            </td>
                            <td class="precio-cell">
                                <div class="precio-menor">${formatCurrency(entrada.valor_menor)}</div>
                            </td>
                            <td style="text-align: center;">
                                <button class="btn-action btn-editar" onclick="verDetalleEntrada(${entrada.id})" 
                                        style="padding: 4px 8px; font-size: 12px;">
                                    ?Ver
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            function updateEntradasStats() {
                const entradas = entradasList.filter(e => e.motivo === 'entrada');
                const devoluciones = entradasList.filter(e => e.motivo === 'devolucion');
                const productosAfectados = new Set(entradasList.map(e => e.codigo_producto)).size;
                const totalMovimientos = entradasList.length;
                
                document.getElementById('entradasStats').innerHTML = `
                    <div class="stat-card-entradas">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${totalMovimientos}</div>
                        <div class="stat-description">Total Movimientos</div>
                    </div>
                    <div class="stat-card-entradas entrada">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${entradas.length}</div>
                        <div class="stat-description">Entradas</div>
                    </div>
                    <div class="stat-card-entradas devolucion">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${devoluciones.length}</div>
                        <div class="stat-description">Devoluciones</div>
                    </div>
                    <div class="stat-card-entradas productos">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${productosAfectados}</div>
                        <div class="stat-description">Productos Afectados</div>
                    </div>
                `;
            }
            
            function showEntradaLoading(show) {
                const btn = document.getElementById('btnSaveEntrada');
                const text = btn.querySelector('.btn-text');
                const loading = btn.querySelector('.loading');
                
                if (show) {
                    text.style.display = 'none';
                    loading.style.display = 'inline-block';
                    btn.disabled = true;
                } else {
                    text.style.display = 'inline';
                    loading.style.display = 'none';
                    btn.disabled = false;
                }
            }
            
            // Cerrar dropdown al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.producto-search')) {
                    document.getElementById('productosDropdown').classList.remove('show');
                }
            });
            
            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeEntradaModal();
                }
            });
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('modalEntrada').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEntradaModal();
                }
            });
            
            // Inicializar mdulo
            await loadProductos();
            await loadEntradas();
            
            registerAction('Acceso mdulo entradas', 'sistema', 'entradas', 'Usuario accedi al mdulo de entradas');
        }
        
        async function showCotizaciones() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'Cotizaciones';
            
            // Variables globales del mdulo
            let cotizacionesList = [];
            let clientesList = [];
            let productosList = [];
            let filteredCotizaciones = [];
            let selectedCliente = null;
            let productosEnCotizacion = [];
            let parametrosEmpresa = null;
            let cantidadMayorista = 6;
            
            // Crear interfaz
            document.getElementById('contentBody').innerHTML = `
                <div class="cotizaciones-container">
                    <div class="cotizaciones-header">
                        <h2>Gestin de Cotizaciones</h2>
                        <button class="btn-nuevo" onclick="openCotizacionModal()">
                            <span>+ Nueva Cotizacin</span>
                        </button>
                    </div>
                    
                    <!-- Estadsticas -->
                    <div class="cotizaciones-stats" id="cotizacionesStats">
                        <!-- Estadsticas dinmicas -->
                    </div>
                    
                    <!-- Filtros -->
                    <div class="entradas-filters">
                        <div class="filter-group">
                            <input type="text" id="searchCotizaciones" class="search-input" 
                                   placeholder=" Buscar por cliente o consecutivo..." 
                                   oninput="filterCotizaciones()">
                        </div>
                        
                        <div class="filter-group">
                            <label> Estado:</label>
                            <select id="filterEstado" class="filter-select" onchange="filterCotizaciones()">
                                <option value="">Todos los estados</option>
                                <option value="Pendiente">Pendientes</option>
                                <option value="Enviada">Enviadas</option>
                                <option value="Vendida">Vendidas</option>
                                <option value="Anulada">Anuladas</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label> Cliente:</label>
                            <select id="filterCliente" class="filter-select" onchange="filterCotizaciones()">
                                <option value="">Todos los clientes</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label> Perodo:</label>
                            <select id="filterPeriodo" class="filter-select" onchange="filterCotizaciones()">
                                <option value="">Todo el tiempo</option>
                                <option value="hoy">Hoy</option>
                                <option value="semana">Esta semana</option>
                                <option value="mes">Este mes</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Lista de cotizaciones -->
                    <div id="cotizacionesList" class="cotizaciones-grid">
                        <div style="text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 24px; margin-bottom: 10px;"></div>
                            <p>Cargando cotizaciones...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Nueva Cotizacin -->
                <div id="modalCotizacion" class="modal">
                    <div class="modal-content modal-cotizacion">
                        <div class="modal-header">
                            <h3 class="modal-title">Nueva Cotizacin</h3>
                            <button class="btn-close" onclick="closeCotizacionModal()">&times;</button>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="cotizacion-form-tabs">
                            <button class="form-tab active" onclick="switchCotizacionTab('cliente')">
                                1. Cliente
                            </button>
                            <button class="form-tab" onclick="switchCotizacionTab('productos')">
                                2. Productos
                            </button>
                            <button class="form-tab" onclick="switchCotizacionTab('resumen')">
                                3. Resumen
                            </button>
                        </div>
                        
                        <form id="formCotizacion" onsubmit="saveCotizacion(event)">
                            <!-- Tab 1: Cliente -->
                            <div id="tabCliente" class="tab-panel active">
                                <div class="form-group">
                                    <label> Seleccionar Cliente <span class="required">*</span></label>
                                    <div class="cliente-selector">
                                        <div class="cliente-search" id="clienteSearchContainer">
                                            <input type="text" id="clienteSearch" class="form-control" 
                                                   placeholder="Buscar cliente por nombre o NIT..."
                                                   oninput="searchClientes()" onfocus="showClientesDropdown()">
                                            <div class="clientes-dropdown" id="clientesDropdown">
                                                <!-- Clientes dinmicos -->
                                            </div>
                                        </div>
                                        
                                        <div class="cliente-selected" id="clienteSelected" style="display: none;">
                                            <div class="selected-producto-info">
                                                <div style="flex: 1;">
                                                    <h4 id="selectedClienteNombre">Cliente</h4>
                                                    <p>NIT: <span id="selectedClienteNit">-</span></p>
                                                    <p id="selectedClienteCorreo"></p>
                                                    <p id="selectedClienteZona"></p>
                                                </div>
                                                <button type="button" class="btn-change-producto" onclick="changeCliente()">
                                                    Cambiar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab 2: Productos -->
                            <div id="tabProductos" class="tab-panel">
                                <div class="productos-section">
                                    <div class="productos-header">
                                        <h4> Productos de la Cotizacin</h4>
                                        <span id="productosCount">0 productos</span>
                                    </div>
                                    
                                    <div class="productos-search">
                                        <input type="text" id="productosSearch" class="form-control" 
                                               placeholder=" Buscar producto para agregar..."
                                               oninput="searchProductosCotizacion()" onfocus="showProductosCotizacionDropdown()">
                                        <div class="productos-cotizacion-dropdown" id="productosCotizacionDropdown">
                                            <!-- Productos dinmicos -->
                                        </div>
                                    </div>
                                    
                                    <div class="productos-lista" id="productosLista">
                                        <div class="empty-productos">
                                            <div style="font-size: 48px; margin-bottom: 10px;"></div>
                                            <h4>No hay productos agregados</h4>
                                            <p>Busque y seleccione productos para agregar a la cotizacin</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Tab 3: Resumen -->
                            <div id="tabResumen" class="tab-panel">
                                <div id="resumenCotizacion">
                                    <!-- Resumen dinmico -->
                                </div>
                                
                                <div class="cotizacion-totales" id="cotizacionTotales">
                                    <!-- Totales dinmicos -->
                                </div>
                            </div>
                            
                            <div class="modal-actions">
                                <button type="button" class="btn-secondary" onclick="closeCotizacionModal()">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn-primary" id="btnSaveCotizacion">
                                    <span class="btn-text">Crear Cotizacin</span>
                                    <span class="loading" style="display: none;"></span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // Cargar jsPDF dinmicamente
            // Cargar jsPDF dinmicamente
if (!window.jsPDF) {
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
    script.onerror = () => console.error('Error cargando jsPDF');
    document.head.appendChild(script);
}
            function loadBase64Image(base64) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = base64;
    });
}
			
            // Funciones del mdulo
            window.openCotizacionModal = function() {
                const modal = document.getElementById('modalCotizacion');
                resetCotizacionForm();
                modal.classList.add('show');
            };
            
            window.closeCotizacionModal = function() {
                document.getElementById('modalCotizacion').classList.remove('show');
                resetCotizacionForm();
            };
            
            window.switchCotizacionTab = function(tabName) {
                // Actualizar botones
                document.querySelectorAll('.form-tab').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[onclick="switchCotizacionTab('${tabName}')"]`).classList.add('active');
                
                // Actualizar contenido
                document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
                document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
                
                // Actualizar resumen si vamos a esa tab
                if (tabName === 'resumen') {
                    updateResumenCotizacion();
                }
            };
            
            window.showClientesDropdown = function() {
                document.getElementById('clientesDropdown').classList.add('show');
                if (document.getElementById('clienteSearch').value === '') {
                    renderClientesDropdown(clientesList.filter(c => c.activo));
                }
            };
            
            window.searchClientes = function() {
                const search = document.getElementById('clienteSearch').value.toLowerCase();
                const dropdown = document.getElementById('clientesDropdown');
                
                if (search.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const filtered = clientesList.filter(c => 
                    c.activo && (
                        c.nombre.toLowerCase().includes(search) ||
                        c.nit.toLowerCase().includes(search)
                    )
                );
                
                renderClientesDropdown(filtered);
                dropdown.classList.add('show');
            };
            
            window.selectCliente = function(nit) {
                const cliente = clientesList.find(c => c.nit === nit);
                if (!cliente) return;
                
                selectedCliente = cliente;
                
                // Mostrar cliente seleccionado
                document.getElementById('clienteSearchContainer').style.display = 'none';
                document.getElementById('clienteSelected').style.display = 'block';
                
                // Llenar informacin
                document.getElementById('selectedClienteNombre').textContent = cliente.nombre;
                document.getElementById('selectedClienteNit').textContent = cliente.nit;
                document.getElementById('selectedClienteCorreo').textContent = cliente.correo ? ` ${cliente.correo}` : '';
                document.getElementById('selectedClienteZona').textContent = cliente.zona ? ` ${cliente.zona}` : '';
                
                // Ocultar dropdown
                document.getElementById('clientesDropdown').classList.remove('show');
            };
            
            window.changeCliente = function() {
                document.getElementById('clienteSearchContainer').style.display = 'block';
                document.getElementById('clienteSelected').style.display = 'none';
                document.getElementById('clienteSearch').value = '';
                document.getElementById('clienteSearch').focus();
                selectedCliente = null;
            };
            
            window.showProductosCotizacionDropdown = function() {
                document.getElementById('productosCotizacionDropdown').classList.add('show');
                if (document.getElementById('productosSearch').value === '') {
                    renderProductosCotizacionDropdown(productosList.filter(p => p.activo && p.stock_actual > 0));
                }
            };
            
            window.searchProductosCotizacion = function() {
                const search = document.getElementById('productosSearch').value.toLowerCase();
                const dropdown = document.getElementById('productosCotizacionDropdown');
                
                if (search.length === 0) {
                    dropdown.classList.remove('show');
                    return;
                }
                
                const filtered = productosList.filter(p => 
                    p.activo && p.stock_actual > 0 && (
                        p.nombre.toLowerCase().includes(search) ||
                        p.codigo.toLowerCase().includes(search)
                    )
                );
                
                renderProductosCotizacionDropdown(filtered);
                dropdown.classList.add('show');
            };
            
            window.addProductoToCotizacion = function(codigo) {
                const producto = productosList.find(p => p.codigo === codigo);
                if (!producto) return;
                
                // Verificar si ya est en la cotizacin
                const existing = productosEnCotizacion.find(p => p.codigo === codigo);
                if (existing) {
                    showNotification('El producto ya est en la cotizacin', 'warning');
                    return;
                }
                
                // Agregar producto con cantidad inicial 1
                const productoEnCotizacion = {
                    codigo: producto.codigo,
                    nombre: producto.nombre,
                    foto_base64: producto.foto_base64,
                    stock_actual: producto.stock_actual,
                    cantidad: 1,
                    valor_unitario: 0, // Se calcular automticamente
                    subtotal: 0,
                    tipo_precio: 'menor' // Por defecto menor
                };
                
                productosEnCotizacion.push(productoEnCotizacion);
                updateProductoPrecio(productoEnCotizacion);
                renderProductosEnCotizacion();
                updateProductosCount();
                
                // Limpiar bsqueda
                document.getElementById('productosSearch').value = '';
                document.getElementById('productosCotizacionDropdown').classList.remove('show');
                
                showNotification('Producto agregado a la cotizacin', 'success');
            };
            
            window.updateCantidadProducto = function(codigo, nuevaCantidad) {
                const producto = productosEnCotizacion.find(p => p.codigo === codigo);
                if (!producto) return;
                
                if (nuevaCantidad <= 0) {
                    removeProductoFromCotizacion(codigo);
                    return;
                }
                
                if (nuevaCantidad > producto.stock_actual) {
                    showNotification(`Stock insuficiente. Disponible: ${producto.stock_actual}`, 'error');
                    return;
                }
                
                producto.cantidad = nuevaCantidad;
                updateProductoPrecio(producto);
                renderProductosEnCotizacion();
            };
            
            window.removeProductoFromCotizacion = function(codigo) {
                productosEnCotizacion = productosEnCotizacion.filter(p => p.codigo !== codigo);
                renderProductosEnCotizacion();
                updateProductosCount();
            };
            
            window.filterCotizaciones = function() {
                const search = document.getElementById('searchCotizaciones').value.toLowerCase();
                const estadoFilter = document.getElementById('filterEstado').value;
                const clienteFilter = document.getElementById('filterCliente').value;
                const periodoFilter = document.getElementById('filterPeriodo').value;
                
                filteredCotizaciones = cotizacionesList.filter(cotizacion => {
                    // Filtro de bsqueda
                    const matchSearch = !search || 
                        cotizacion.nombre_cliente.toLowerCase().includes(search) ||
                        cotizacion.consecutivo.toLowerCase().includes(search);
                    
                    // Filtro de estado
                    const matchEstado = !estadoFilter || cotizacion.estado === estadoFilter;
                    
                    // Filtro de cliente
                    const matchCliente = !clienteFilter || cotizacion.nit_cliente === clienteFilter;
                    
                    // Filtro de perodo
                    let matchPeriodo = true;
                    if (periodoFilter) {
                        const cotizacionDate = new Date(cotizacion.fecha_hora);
                        const now = new Date();
                        
                        switch (periodoFilter) {
                            case 'hoy':
                                matchPeriodo = cotizacionDate.toDateString() === now.toDateString();
                                break;
                            case 'semana':
                                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                                matchPeriodo = cotizacionDate >= weekAgo;
                                break;
                            case 'mes':
                                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                                matchPeriodo = cotizacionDate >= monthAgo;
                                break;
                        }
                    }
                    
                    return matchSearch && matchEstado && matchCliente && matchPeriodo;
                });
                
                renderCotizaciones();
            };
            
            window.saveCotizacion = async function(event) {
                event.preventDefault();
                
                // Validaciones
                if (!selectedCliente) {
                    showNotification('Debe seleccionar un cliente', 'error');
                    switchCotizacionTab('cliente');
                    return;
                }
                
                if (productosEnCotizacion.length === 0) {
                    showNotification('Debe agregar al menos un producto', 'error');
                    switchCotizacionTab('productos');
                    return;
                }
                
                showCotizacionLoading(true);
                
                try {
                    // Generar consecutivo
                    const consecutivo = await generateConsecutivo();
                    
                    // Calcular totales
                    const subtotal = productosEnCotizacion.reduce((sum, p) => sum + p.subtotal, 0);
                    const total = subtotal; // Sin impuestos por ahora
                    
                    // Crear cotizacin
                    const cotizacionData = {
                        consecutivo: consecutivo,
                        nit_cliente: selectedCliente.nit,
                        nombre_cliente: selectedCliente.nombre,
                        zona_cliente: selectedCliente.zona,
                        fecha_hora: new Date().toISOString(),
                        fecha_vencimiento: new Date(Date.now() + (parametrosEmpresa?.validez_cotizacion_dias || 30) * 24 * 60 * 60 * 1000).toISOString(),
                        subtotal: subtotal,
                        total: total,
                        estado: 'Pendiente',
                        usuario_creacion: currentUser?.username || 'sistema'
                    };
                    
                    // Guardar cotizacin
                    const result = await executeQuery('cotizaciones', 'insert', [cotizacionData]);
                    
                    // Obtener ID de la cotizacin
                    let cotizacionId;
                    if (isOnline() && supabase) {
                        const { data } = await supabase
                            .from('cotizaciones')
                            .select('id_cotizacion')
                            .eq('consecutivo', consecutivo)
                            .single();
                        cotizacionId = data?.id_cotizacion;
                    } else {
                        cotizacionId = Date.now(); // ID temporal para offline
                    }
                    
                    // Guardar detalles
                    for (const producto of productosEnCotizacion) {
                        const detalleData = {
                            id_cotizacion: cotizacionId,
                            codigo_producto: producto.codigo,
                            nombre_producto: producto.nombre,
                            cantidad: producto.cantidad,
                            valor_unitario: producto.valor_unitario,
                            subtotal: producto.subtotal,
                            tipo_precio: producto.tipo_precio
                        };
                        
                        await executeQuery('cotizacion_detalle', 'insert', [detalleData]);
                    }
                    
                    showNotification('Cotizacin creada correctamente', 'success');
                    
                    await registerAction(
                        'Crear cotizacin',
                        'cotizaciones',
                        consecutivo,
                        `Cliente: ${selectedCliente.nombre}, Total: ${formatCurrency(total)}`
                    );
                    
                    closeCotizacionModal();
                    await loadCotizaciones();
                    
                } catch (error) {
                    console.error('Error guardando cotizacin:', error);
                    showNotification('Error al crear cotizacin: ' + error.message, 'error');
                } finally {
                    showCotizacionLoading(false);
                }
            };
            
            window.editCotizacion = function(consecutivo) {
                showNotification('Funcin de edicin en desarrollo', 'info');
            };
            
            window.generatePDF = async function(consecutivo) {
    try {
        // Verificar jsPDF
        if (!window.jsPDF) {
            showNotification('Cargando generador de PDF...', 'info');
            return;
        }

        const { jsPDF } = window.jspdf;
        
        const cotizacion = cotizacionesList.find(c => c.consecutivo === consecutivo);
        if (!cotizacion) return;
        
        // Cargar detalles de la cotizacin
        const detalles = await loadCotizacionDetalles(cotizacion.id_cotizacion);
        
        // Generar PDF
        const doc = new jsPDF();
        
        // Agregar logo si existe
        if (parametrosEmpresa?.logo_empresa) {
            try {
                const logoImg = await loadBase64Image(parametrosEmpresa.logo_empresa);
                const canvas = document.createElement('canvas');
                canvas.width = logoImg.width;
                canvas.height = logoImg.height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(logoImg, 0, 0);
                const resizedLogo = canvas.toDataURL('image/jpeg', 0.5);
                
                doc.addImage(resizedLogo, 'JPEG', 10, 10, 40, 40);
            } catch (logoError) {
                console.warn('Error procesando logo:', logoError);
            }
        }
        
        // Configurar fuente
        doc.setFont('helvetica');
        
        // Ttulo
        doc.setFontSize(20);
        doc.setTextColor(40, 40, 40);
        doc.text('COTIZACI"N', 105, 60, { align: 'center' });
        
        // Informacin de empresa
        doc.setFontSize(12);
        doc.text(parametrosEmpresa?.nombre_empresa || 'Tool Center', 20, 80);
        doc.text(`Ibagu, ${formatDate(cotizacion.fecha_hora)}`, 20, 90);
        
        // Nmero de cotizacin
        doc.setFontSize(14);
        doc.setTextColor(0, 100, 200);
        doc.text(`${consecutivo}`, 150, 80);
        
        // Informacin del cliente
        doc.setFontSize(12);
        doc.setTextColor(40, 40, 40);
        doc.text(`Seor(a): ${cotizacion.nombre_cliente}`, 20, 110);
        doc.text('Cordial saludo', 20, 125);
        doc.text('Anexo cotizacin segn lista:', 20, 140);
        
        // Tabla de productos
        let yPosition = 160;
        
        // Headers
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text('PRODUCTO', 20, yPosition);
        doc.text('CANT.', 120, yPosition);
        doc.text('VALOR UNIT.', 140, yPosition);
        doc.text('SUBTOTAL', 170, yPosition);
        
        yPosition += 10;
        
        // Productos
        doc.setFontSize(9);
        doc.setTextColor(40, 40, 40);
        
        for (const detalle of detalles) {
            if (yPosition > 250) {
                doc.addPage();
                yPosition = 30;
            }
            
            doc.text(detalle.nombre_producto, 20, yPosition);
            doc.text(detalle.cantidad.toString(), 120, yPosition);
            doc.text(formatCurrency(detalle.valor_unitario), 140, yPosition);
            doc.text(formatCurrency(detalle.subtotal), 170, yPosition);
            
            yPosition += 10;
        }
        
        // Total
        yPosition += 10;
        doc.setFontSize(12);
        doc.setTextColor(40, 40, 40);
        doc.text(`TOTAL: ${formatCurrency(cotizacion.total)}`, 140, yPosition);
        
        // Footer
        yPosition += 30;
        doc.setFontSize(10);
        doc.text('Cordialmente,', 20, yPosition);
        doc.text('Jorge Luis Hernndez', 20, yPosition + 15);
        doc.text('Celular: 314 345 2032', 20, yPosition + 25);
        
        // Descargar PDF
        doc.save(`cotizacion_${cotizacion.nombre_cliente}_${formatDate(cotizacion.fecha_hora).replace(/\//g, '-')}.pdf`);
        
        showNotification('PDF generado correctamente', 'success');
        
    } catch (error) {
        console.error('Error generando PDF:', error);
        showNotification('Error al generar PDF: ' + error.message, 'error');
    }
};
            
            window.confirmarVenta = async function(consecutivo) {
                const cotizacion = cotizacionesList.find(c => c.consecutivo === consecutivo);
                if (!cotizacion) return;
                
                if (cotizacion.estado === 'Vendida') {
                    showNotification('Esta cotizacin ya fue confirmada como venta', 'warning');
                    return;
                }
                
                const confirm = window.confirm(
                    `Confirmar cotizacin ${consecutivo} como VENTA?\n\n` +
                    'Esto actualizar el estado y descontar el stock de los productos.'
                );
                
                if (!confirm) return;
                
                try {
                    // Cargar detalles para descontar stock
                    const detalles = await loadCotizacionDetalles(cotizacion.id_cotizacion);
                    
                    // Verificar stock disponible
                    for (const detalle of detalles) {
                        const producto = productosList.find(p => p.codigo === detalle.codigo_producto);
                        if (!producto || producto.stock_actual < detalle.cantidad) {
                            showNotification(`Stock insuficiente para ${detalle.nombre_producto}`, 'error');
                            return;
                        }
                    }
                    
                    // Actualizar estado de cotizacin
                    await executeQuery('cotizaciones', 'update', {
                        updates: { estado: 'Vendida' },
                        where: { column: 'consecutivo', value: consecutivo }
                    });
                    
                    // Descontar stock
                    for (const detalle of detalles) {
                        const producto = productosList.find(p => p.codigo === detalle.codigo_producto);
                        const nuevoStock = producto.stock_actual - detalle.cantidad;
                        
                        await executeQuery('productos', 'update', {
                            updates: { stock_actual: nuevoStock },
                            where: { column: 'codigo', value: detalle.codigo_producto }
                        });
                        
                        // Actualizar en memoria
                        producto.stock_actual = nuevoStock;
                    }
                    
                    showNotification('Venta confirmada correctamente', 'success');
                    
                    await registerAction(
                        'Confirmar venta',
                        'cotizaciones',
                        consecutivo,
                        `Venta confirmada - Stock actualizado`
                    );
                    
                    await loadCotizaciones();
                    
                } catch (error) {
                    console.error('Error confirmando venta:', error);
                    showNotification('Error al confirmar venta: ' + error.message, 'error');
                }
            };
            
            window.anularCotizacion = async function(consecutivo) {
                const cotizacion = cotizacionesList.find(c => c.consecutivo === consecutivo);
                if (!cotizacion) return;
                
                if (cotizacion.estado === 'Vendida') {
                    showNotification('No se puede anular una cotizacin vendida', 'error');
                    return;
                }
                
                const motivo = prompt('Motivo de anulacin:');
                if (!motivo) return;
                
                try {
                    await executeQuery('cotizaciones', 'update', {
                        updates: { 
                            estado: 'Anulada',
                            motivo_anulacion: motivo 
                        },
                        where: { column: 'consecutivo', value: consecutivo }
                    });
                    
                    showNotification('Cotizacin anulada correctamente', 'success');
                    
                    await registerAction(
                        'Anular cotizacin',
                        'cotizaciones',
                        consecutivo,
                        `Motivo: ${motivo}`
                    );
                    
                    await loadCotizaciones();
                    
                } catch (error) {
                    console.error('Error anulando cotizacin:', error);
                    showNotification('Error al anular cotizacin: ' + error.message, 'error');
                }
            };
            
            // Funciones auxiliares
            function resetCotizacionForm() {
                selectedCliente = null;
                productosEnCotizacion = [];
                
                document.getElementById('formCotizacion').reset();
                document.getElementById('clienteSearchContainer').style.display = 'block';
                document.getElementById('clienteSelected').style.display = 'none';
                document.getElementById('clienteSearch').value = '';
                document.getElementById('clientesDropdown').classList.remove('show');
                document.getElementById('productosSearch').value = '';
                document.getElementById('productosCotizacionDropdown').classList.remove('show');
                
                // Reset tabs
                switchCotizacionTab('cliente');
                
                renderProductosEnCotizacion();
                updateProductosCount();
            }
            
            function updateProductoPrecio(producto) {
                // Obtener ltima entrada del producto
                const ultimasEntradas = entradasList?.filter(e => e.codigo_producto === producto.codigo)
                    .sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora)) || [];
                
                const ultimaEntrada = ultimasEntradas[0];
                
                if (ultimaEntrada) {
                    // Usar precios de ltima entrada
                    if (producto.cantidad >= cantidadMayorista) {
                        producto.valor_unitario = ultimaEntrada.valor_mayor;
                        producto.tipo_precio = 'mayor';
                    } else {
                        producto.valor_unitario = ultimaEntrada.valor_menor;
                        producto.tipo_precio = 'menor';
                    }
                } else {
                    // Precios por defecto si no hay entradas
                    producto.valor_unitario = 1000; // Precio por defecto
                    producto.tipo_precio = producto.cantidad >= cantidadMayorista ? 'mayor' : 'menor';
                }
                
                producto.subtotal = producto.cantidad * producto.valor_unitario;
            }
            
            function renderClientesDropdown(clientes) {
                const dropdown = document.getElementById('clientesDropdown');
                
                if (clientes.length === 0) {
                    dropdown.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #6b7280;">
                            No se encontraron clientes activos
                        </div>
                    `;
                    return;
                }
                
                dropdown.innerHTML = clientes.map(cliente => `
                    <div class="cliente-option" onclick="selectCliente('${cliente.nit}')">
                        <div class="cliente-option-nombre">${cliente.nombre}</div>
                        <div class="cliente-option-nit">NIT: ${cliente.nit} ${cliente.zona ? `?${cliente.zona}` : ''}</div>
                    </div>
                `).join('');
            }
            
            function renderProductosCotizacionDropdown(productos) {
                const dropdown = document.getElementById('productosCotizacionDropdown');
                
                if (productos.length === 0) {
                    dropdown.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: #6b7280;">
                            No se encontraron productos con stock
                        </div>
                    `;
                    return;
                }
                
                dropdown.innerHTML = productos.map(producto => `
                    <div class="producto-cotizacion-option" onclick="addProductoToCotizacion('${producto.codigo}')">
                        <div class="producto-option-image">
                            ${producto.foto_base64 ? 
                                `<img src="${producto.foto_base64}" alt="${producto.nombre}">` : 
                                ''
                            }
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; color: #1f2937;">${producto.nombre}</div>
                            <div style="font-size: 12px; color: #6b7280;">
                                ${producto.codigo} ?Stock: ${producto.stock_actual}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            function renderProductosEnCotizacion() {
                const container = document.getElementById('productosLista');
                
                if (productosEnCotizacion.length === 0) {
                    container.innerHTML = `
                        <div class="empty-productos">
                            <div style="font-size: 48px; margin-bottom: 10px;"></div>
                            <h4>No hay productos agregados</h4>
                            <p>Busque y seleccione productos para agregar a la cotizacin</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = productosEnCotizacion.map(producto => `
                    <div class="producto-cotizacion-item">
                        <div class="producto-item-image">
                            ${producto.foto_base64 ? 
                                `<img src="${producto.foto_base64}" alt="${producto.nombre}">` : 
                                ''
                            }
                        </div>
                        <div class="producto-item-info">
                            <div class="producto-item-nombre">${producto.nombre}</div>
                            <div class="producto-item-codigo">${producto.codigo}</div>
                            <div class="producto-item-precio">
                                ${formatCurrency(producto.valor_unitario)} 
                                <span style="font-size: 12px; color: #6b7280;">
                                    (${producto.tipo_precio === 'mayor' ? 'Por mayor' : 'Por menor'})
                                </span>
                            </div>
                        </div>
                        <div class="cantidad-controls">
                            <button class="btn-cantidad" onclick="updateCantidadProducto('${producto.codigo}', ${producto.cantidad - 1})">
                                ?
                            </button>
                            <input type="number" class="cantidad-input" value="${producto.cantidad}" min="1" 
                                   onchange="updateCantidadProducto('${producto.codigo}', parseInt(this.value))">
                            <button class="btn-cantidad" onclick="updateCantidadProducto('${producto.codigo}', ${producto.cantidad + 1})">
                                +
                            </button>
                        </div>
                        <div style="text-align: right; margin-left: 15px;">
                            <div style="font-weight: 600; color: #1f2937;">
                                ${formatCurrency(producto.subtotal)}
                            </div>
                            <button class="btn-eliminar-producto" onclick="removeProductoFromCotizacion('${producto.codigo}')">
                                ?
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            function updateProductosCount() {
                const count = productosEnCotizacion.length;
                document.getElementById('productosCount').textContent = `${count} producto${count !== 1 ? 's' : ''}`;
            }
            
            function updateResumenCotizacion() {
                const resumenContainer = document.getElementById('resumenCotizacion');
                const totalesContainer = document.getElementById('cotizacionTotales');
                
                if (!selectedCliente) {
                    resumenContainer.innerHTML = '<p style="color: #6b7280;">Seleccione un cliente para continuar</p>';
                    return;
                }
                
                if (productosEnCotizacion.length === 0) {
                    resumenContainer.innerHTML = '<p style="color: #6b7280;">Agregue productos para continuar</p>';
                    return;
                }
                
                // Informacin del cliente
                resumenContainer.innerHTML = `
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0;"> Cliente</h4>
                        <p style="margin: 0;"><strong>${selectedCliente.nombre}</strong></p>
                        <p style="margin: 0; font-size: 14px; color: #6b7280;">NIT: ${selectedCliente.nit}</p>
                        ${selectedCliente.correo ? `<p style="margin: 0; font-size: 14px; color: #6b7280;"> ${selectedCliente.correo}</p>` : ''}
                    </div>
                    
                    <div style="background: #f8fafc; padding: 20px; border-radius: 8px;">
                        <h4 style="margin: 0 0 15px 0;"> Productos (${productosEnCotizacion.length})</h4>
                        ${productosEnCotizacion.map(p => `
                            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                                <div style="flex: 1;">
                                    <strong>${p.nombre}</strong><br>
                                    <span style="font-size: 12px; color: #6b7280;">${p.codigo} ?${p.cantidad} unidades</span>
                                </div>
                                <div style="text-align: right;">
                                    <div>${formatCurrency(p.subtotal)}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                // Calcular totales
                const subtotal = productosEnCotizacion.reduce((sum, p) => sum + p.subtotal, 0);
                const total = subtotal;
                
                totalesContainer.innerHTML = `
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>${formatCurrency(subtotal)}</span>
                    </div>
                    <div class="total-final">
                        <span>TOTAL:</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                `;
            }
            
            async function loadCotizacionDetalles(idCotizacion) {
                try {
                    if (isOnline() && supabase) {
                        const { data } = await supabase
                            .from('cotizacion_detalle')
                            .select('*')
                            .eq('id_cotizacion', idCotizacion);
                        return data || [];
                    } else {
                        const detalles = await getOffline('cotizacion_detalle');
                        return detalles.filter(d => d.id_cotizacion === idCotizacion);
                    }
                } catch (error) {
                    console.error('Error cargando detalles:', error);
                    return [];
                }
            }
            
            async function loadCotizaciones() {
                try {
                    let cotizaciones = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('cotizaciones', 'select', {});
                        cotizaciones = result.data || [];
                    } else {
                        cotizaciones = await getOffline('cotizaciones');
                    }
                    
                    cotizacionesList = cotizaciones.sort((a, b) => new Date(b.fecha_hora) - new Date(a.fecha_hora));
                    filteredCotizaciones = [...cotizacionesList];
                    
                    renderCotizaciones();
                    updateCotizacionesStats();
                    loadClientesFilter();
                    
                } catch (error) {
                    console.error('Error cargando cotizaciones:', error);
                    showNotification('Error al cargar cotizaciones', 'error');
                }
            }
            
            async function loadClientes() {
                try {
                    let clientes = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('clientes', 'select', {});
                        clientes = result.data || [];
                    } else {
                        clientes = await getOffline('clientes');
                    }
                    
                    clientesList = clientes.filter(c => c.activo).sort((a, b) => a.nombre.localeCompare(b.nombre));
                    
                } catch (error) {
                    console.error('Error cargando clientes:', error);
                }
            }
            
            async function loadProductos() {
                try {
                    let productos = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('productos', 'select', {});
                        productos = result.data || [];
                    } else {
                        productos = await getOffline('productos');
                    }
                    
                    productosList = productos.filter(p => p.activo).sort((a, b) => a.nombre.localeCompare(b.nombre));
                    
                } catch (error) {
                    console.error('Error cargando productos:', error);
                }
            }
            
            async function loadParametros() {
                try {
                    if (isOnline() && supabase) {
                        const result = await executeQuery('parametros', 'select', { select: '*' });
                        parametrosEmpresa = result.data && result.data.length > 0 ? result.data[0] : null;
                    } else {
                        const stored = await getOffline('parametros');
                        parametrosEmpresa = stored.length > 0 ? stored[0] : null;
                    }
                    
                    if (parametrosEmpresa) {
                        cantidadMayorista = parametrosEmpresa.cantidad_mayorista || 6;
                    }
                    
                } catch (error) {
                    console.error('Error cargando parmetros:', error);
                }
            }
            
            function loadClientesFilter() {
                const select = document.getElementById('filterCliente');
                select.innerHTML = '<option value="">Todos los clientes</option>';
                
                const clientesConCotizaciones = [...new Set(cotizacionesList.map(c => c.nit_cliente))];
                
                clientesConCotizaciones.forEach(nit => {
                    const cliente = clientesList.find(c => c.nit === nit);
                    if (cliente) {
                        const option = document.createElement('option');
                        option.value = nit;
                        option.textContent = cliente.nombre;
                        select.appendChild(option);
                    }
                });
            }
            
            function renderCotizaciones() {
                const container = document.getElementById('cotizacionesList');
                
                if (filteredCotizaciones.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 10px;"></div>
                            <h3>No hay cotizaciones registradas</h3>
                            <p>Cree la primera cotizacin usando el botn "Nueva Cotizacin"</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = filteredCotizaciones.map(cotizacion => `
                    <div class="cotizacion-card">
                        <div class="cotizacion-header">
                            <div class="cotizacion-consecutivo">${cotizacion.consecutivo}</div>
                            <span class="cotizacion-estado estado-${cotizacion.estado.toLowerCase()}">${cotizacion.estado}</span>
                        </div>
                        <div class="cotizacion-info">
                            <div class="cotizacion-cliente">${cotizacion.nombre_cliente}</div>
                            <div class="cotizacion-fecha"> ${formatDate(cotizacion.fecha_hora)}</div>
                            
                            <div class="cotizacion-resumen">
                                <div class="resumen-total">
                                    <span>Total:</span>
                                    <span>${formatCurrency(cotizacion.total)}</span>
                                </div>
                            </div>
                            
                            <div class="cotizacion-actions">
                                ${getActionsForEstado(cotizacion)}
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            function getActionsForEstado(cotizacion) {
                const baseActions = `
                    <button class="btn-cotizacion btn-cotizacion-pdf" onclick="generatePDF('${cotizacion.consecutivo}')">
                         PDF
                    </button>
                `;
                
                switch (cotizacion.estado) {
                    case 'Pendiente':
                        return baseActions + `
                            <button class="btn-cotizacion btn-cotizacion-confirmar" onclick="confirmarVenta('${cotizacion.consecutivo}')">
                                ?Confirmar Venta
                            </button>
                            <button class="btn-cotizacion btn-cotizacion-anular" onclick="anularCotizacion('${cotizacion.consecutivo}')">
                                ?Anular
                            </button>
                        `;
                    case 'Enviada':
                        return baseActions + `
                            <button class="btn-cotizacion btn-cotizacion-confirmar" onclick="confirmarVenta('${cotizacion.consecutivo}')">
                                ?Confirmar Venta
                            </button>
                        `;
                    case 'Vendida':
                        return baseActions + `
                            <div style="color: #059669; font-size: 12px; text-align: center; padding: 8px;">
                                ?Venta confirmada
                            </div>
                        `;
                    case 'Anulada':
                        return baseActions + `
                            <div style="color: #dc2626; font-size: 12px; text-align: center; padding: 8px;">
                                ?Cotizacin anulada
                            </div>
                        `;
                    default:
                        return baseActions;
                }
            }
            
            function updateCotizacionesStats() {
                const pendientes = cotizacionesList.filter(c => c.estado === 'Pendiente').length;
                const enviadas = cotizacionesList.filter(c => c.estado === 'Enviada').length;
                const vendidas = cotizacionesList.filter(c => c.estado === 'Vendida').length;
                const anuladas = cotizacionesList.filter(c => c.estado === 'Anulada').length;
                
                document.getElementById('cotizacionesStats').innerHTML = `
                    <div class="stat-card-cotizaciones pendiente">
                        <div class="stat-icon">?/div>
                        <div class="stat-value">${pendientes}</div>
                        <div class="stat-description">Pendientes</div>
                    </div>
                    <div class="stat-card-cotizaciones enviada">
                        <div class="stat-icon"></div>
                        <div class="stat-value">${enviadas}</div>
                        <div class="stat-description">Enviadas</div>
                    </div>
                    <div class="stat-card-cotizaciones vendida">
                        <div class="stat-icon">?/div>
                        <div class="stat-value">${vendidas}</div>
                        <div class="stat-description">Vendidas</div>
                    </div>
                    <div class="stat-card-cotizaciones anulada">
                        <div class="stat-icon">?/div>
                        <div class="stat-value">${anuladas}</div>
                        <div class="stat-description">Anuladas</div>
                    </div>
                `;
            }
            
            function showCotizacionLoading(show) {
                const btn = document.getElementById('btnSaveCotizacion');
                const text = btn.querySelector('.btn-text');
                const loading = btn.querySelector('.loading');
                
                if (show) {
                    text.style.display = 'none';
                    loading.style.display = 'inline-block';
                    btn.disabled = true;
                } else {
                    text.style.display = 'inline';
                    loading.style.display = 'none';
                    btn.disabled = false;
                }
            }
            
            // Cerrar dropdowns al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.cliente-search')) {
                    document.getElementById('clientesDropdown').classList.remove('show');
                }
                if (!e.target.closest('.productos-search')) {
                    document.getElementById('productosCotizacionDropdown').classList.remove('show');
                }
            });
            
            // Cerrar modal con ESC
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeCotizacionModal();
                }
            });
            
            // Cerrar modal al hacer clic fuera
            document.getElementById('modalCotizacion').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCotizacionModal();
                }
            });
            
            // Cargar entradas para precios
            let entradasList = [];
            try {
                if (isOnline() && supabase) {
                    const result = await executeQuery('entradas', 'select', {});
                    entradasList = result.data || [];
                } else {
                    entradasList = await getOffline('entradas');
                }
            } catch (error) {
                console.log('No se pudieron cargar entradas para precios');
            }
            
            // Inicializar mdulo
            await loadParametros();
            await loadClientes();
            await loadProductos();
            await loadCotizaciones();
            
            registerAction('Acceso mdulo cotizaciones', 'sistema', 'cotizaciones', 'Usuario accedi al mdulo de cotizaciones');
        }
        
        async function showParametros() {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('contentTitle').textContent = 'Parmetros';
            
            // Variables globales del mdulo
            let parametrosData = null;
            let zonasList = [];
            let hasChanges = false;
            
            // Crear interfaz
            document.getElementById('contentBody').innerHTML = `
                <div class="parametros-container">
                    <!-- Tabs Navigation -->
                    <div class="parametros-tabs">
                        <button class="tab-button active" onclick="switchTab('empresa')">
                             Empresa
                        </button>
                        <button class="tab-button" onclick="switchTab('zonas')">
                             Zonas
                        </button>
                        <button class="tab-button" onclick="switchTab('configuracion')">
                             Configuracin
                        </button>
                    </div>
                    
                    <!-- Tab: Empresa -->
                    <div id="tabEmpresa" class="tab-content active">
                        <div class="config-section">
                            <h3 class="section-title">
                                 Informacin de la Empresa
                            </h3>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="nombreEmpresa">Nombre de la Empresa</label>
                                    <input type="text" id="nombreEmpresa" class="form-control" 
                                           placeholder="Tool Center" maxlength="100">
                                </div>
                                <div class="form-group">
                                    <label for="correoEmpresa">Correo Electrnico</label>
                                    <input type="email" id="correoEmpresa" class="form-control" 
                                           placeholder="toolcenter.com.co@gmail.com" maxlength="100">
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="telefonoEmpresa">Telfono</label>
                                    <input type="tel" id="telefonoEmpresa" class="form-control" 
                                           placeholder="314 345 2032" maxlength="20">
                                </div>
                                <div class="form-group">
                                    <label for="direccionEmpresa">Direccin</label>
                                    <input type="text" id="direccionEmpresa" class="form-control" 
                                           placeholder="Ibagu, Tolima" maxlength="200">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Logo de la Empresa</label>
                                <div class="logo-upload">
                                    <div class="logo-preview" id="logoPreview">
                                        
                                    </div>
                                    <input type="file" id="logoFile" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                                    <button type="button" class="btn-upload" onclick="document.getElementById('logoFile').click()">
                                         Subir Logo
                                    </button>
                                    <p style="font-size: 12px; color: #6b7280; margin: 0;">
                                        Formatos: JPG, PNG. Mximo 500KB
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Zonas -->
                    <div id="tabZonas" class="tab-content">
                        <div class="config-section">
                            <div class="zonas-header">
                                <h3 class="section-title">
                                     Gestin de Zonas
                                </h3>
                            </div>
                            
                            <div class="zona-form">
                                <input type="text" id="nuevaZonaId" placeholder="ID (ej: zona6)" maxlength="10">
                                <input type="text" id="nuevaZonaNombre" placeholder="Nombre de la zona" maxlength="100">
                                <button onclick="addZona()">?Agregar Zona</button>
                            </div>
                            
                            <div id="zonasGrid" class="zonas-grid">
                                <!-- Zonas dinmicas -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab: Configuracin -->
                    <div id="tabConfiguracion" class="tab-content">
                        <div class="config-section">
                            <h3 class="section-title">
                                 Configuracin del Sistema
                            </h3>
                            
                            <div class="config-grid">
                                <div class="config-item">
                                    <h4> Cantidad Mayorista</h4>
                                    <p class="description">Cantidad mnima para aplicar precios al por mayor</p>
                                    <input type="number" id="cantidadMayorista" min="1" max="100" value="6">
                                </div>
                                
                                <div class="config-item">
                                    <h4> Validez Cotizacin</h4>
                                    <p class="description">Das de validez por defecto para cotizaciones</p>
                                    <input type="number" id="validezCotizacion" min="1" max="365" value="30">
                                </div>
                                
                                <div class="config-item">
                                    <h4> Stock Mnimo</h4>
                                    <p class="description">Cantidad mnima de stock por defecto para productos</p>
                                    <input type="number" id="stockMinimo" min="0" max="1000" value="5">
                                </div>
                                
                                <div class="config-item">
                                    <h4> Versin Sistema</h4>
                                    <p class="description">Versin actual del sistema</p>
                                    <input type="text" id="versionSistema" value="1.0" readonly style="background: #f3f4f6;">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Save Section -->
                    <div class="save-section">
                        <button class="btn-save-parametros" id="btnSaveParametros" onclick="saveParametros()">
                            <span class="btn-text"> Guardar Configuracin</span>
                            <span class="loading" style="display: none;"></span>
                        </button>
                        <p style="margin-top: 10px; font-size: 14px; color: #6b7280;">
                            Los cambios se aplicarn inmediatamente en todo el sistema
                        </p>
                    </div>
                </div>
            `;
            
            // Funciones del mdulo
            window.switchTab = function(tabName) {
                // Actualizar botones
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
                
                // Actualizar contenido
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
            };
            
            window.handleLogoUpload = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                // Validar tamao (500KB mximo)
                if (file.size > 500 * 1024) {
                    showNotification('El archivo es muy grande. Mximo 500KB', 'error');
                    return;
                }
                
                // Validar tipo
                if (!file.type.startsWith('image/')) {
                    showNotification('Solo se permiten archivos de imagen', 'error');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    document.getElementById('logoPreview').innerHTML = 
                        `<img src="${base64}" alt="Logo de la empresa">`;
                    hasChanges = true;
                };
                reader.readAsDataURL(file);
            };
            
            window.addZona = async function() {
                const id = document.getElementById('nuevaZonaId').value.trim();
                const nombre = document.getElementById('nuevaZonaNombre').value.trim();
                
                if (!id || !nombre) {
                    showNotification('Complete el ID y nombre de la zona', 'warning');
                    return;
                }
                
                // Validar formato de ID
                if (!/^zona\d+$/.test(id)) {
                    showNotification('El ID debe tener el formato "zona1", "zona2", etc.', 'error');
                    return;
                }
                
                // Validar que no exista
                if (zonasList.find(z => z.id === id)) {
                    showNotification('Ya existe una zona con ese ID', 'error');
                    return;
                }
                
                try {
                    const nuevaZona = {
                        id: id,
                        nombre: nombre,
                        activa: true,
                        fecha_creacion: new Date().toISOString()
                    };
                    
                    await executeQuery('zonas', 'insert', [nuevaZona]);
                    
                    zonasList.push(nuevaZona);
                    renderZonas();
                    
                    // Limpiar formulario
                    document.getElementById('nuevaZonaId').value = '';
                    document.getElementById('nuevaZonaNombre').value = '';
                    
                    showNotification('Zona agregada correctamente', 'success');
                    await registerAction('Crear zona', 'zonas', id, `Zona: ${nombre}`);
                    
                } catch (error) {
                    console.error('Error agregando zona:', error);
                    showNotification('Error al agregar zona: ' + error.message, 'error');
                }
            };
            
            window.editZona = function(zonaId) {
                const zona = zonasList.find(z => z.id === zonaId);
                if (!zona) return;
                
                const nuevoNombre = prompt('Nuevo nombre para la zona:', zona.nombre);
                if (nuevoNombre && nuevoNombre.trim() && nuevoNombre !== zona.nombre) {
                    updateZona(zonaId, { nombre: nuevoNombre.trim() });
                }
            };
            
            window.toggleZona = async function(zonaId) {
                const zona = zonasList.find(z => z.id === zonaId);
                if (!zona) return;
                
                const newStatus = !zona.activa;
                const action = newStatus ? 'activar' : 'desactivar';
                
                if (!confirm(`Est seguro de ${action} la zona "${zona.nombre}"?`)) {
                    return;
                }
                
                await updateZona(zonaId, { activa: newStatus });
            };
            
            async function updateZona(zonaId, updates) {
                try {
                    await executeQuery('zonas', 'update', {
                        updates: updates,
                        where: { column: 'id', value: zonaId }
                    });
                    
                    // Actualizar en memoria
                    const zona = zonasList.find(z => z.id === zonaId);
                    if (zona) {
                        Object.assign(zona, updates);
                    }
                    
                    renderZonas();
                    showNotification('Zona actualizada correctamente', 'success');
                    await registerAction('Actualizar zona', 'zonas', zonaId, `Cambios: ${JSON.stringify(updates)}`);
                    
                } catch (error) {
                    console.error('Error actualizando zona:', error);
                    showNotification('Error al actualizar zona: ' + error.message, 'error');
                }
            }
            
            window.saveParametros = async function() {
                const formData = getParametrosFormData();
                
                showSaveLoading(true);
                
                try {
                    if (parametrosData && parametrosData.id) {
                        // Actualizar parmetros existentes
                        await executeQuery('parametros', 'update', {
                            updates: formData,
                            where: { column: 'id', value: parametrosData.id }
                        });
                    } else {
                        // Crear nuevos parmetros
                        await executeQuery('parametros', 'insert', [{ ...formData, id: 1 }]);
                    }
                    
                    showNotification('Configuracin guardada correctamente', 'success');
                    await registerAction('Actualizar parmetros', 'parametros', '1', 'Configuracin del sistema actualizada');
                    hasChanges = false;
                    
                    // Recargar datos
                    await loadParametros();
                    
                } catch (error) {
                    console.error('Error guardando parmetros:', error);
                    showNotification('Error al guardar configuracin: ' + error.message, 'error');
                } finally {
                    showSaveLoading(false);
                }
            };
            
            // Funciones auxiliares
            function getParametrosFormData() {
                const logoImg = document.querySelector('#logoPreview img');
                
                return {
                    nombre_empresa: document.getElementById('nombreEmpresa').value.trim(),
                    correo_empresa: document.getElementById('correoEmpresa').value.trim(),
                    telefono_empresa: document.getElementById('telefonoEmpresa').value.trim(),
                    direccion_empresa: document.getElementById('direccionEmpresa').value.trim(),
                    logo_empresa: logoImg ? logoImg.src : null,
                    cantidad_mayorista: parseInt(document.getElementById('cantidadMayorista').value) || 6,
                    validez_cotizacion_dias: parseInt(document.getElementById('validezCotizacion').value) || 30,
                    stock_minimo_default: parseInt(document.getElementById('stockMinimo').value) || 5,
                    version: document.getElementById('versionSistema').value
                };
            }
            
            function fillParametrosForm(data) {
                if (!data) return;
                
                document.getElementById('nombreEmpresa').value = data.nombre_empresa || 'Tool Center';
                document.getElementById('correoEmpresa').value = data.correo_empresa || 'toolcenter.com.co@gmail.com';
                document.getElementById('telefonoEmpresa').value = data.telefono_empresa || '314 345 2032';
                document.getElementById('direccionEmpresa').value = data.direccion_empresa || 'Ibagu, Tolima';
                document.getElementById('cantidadMayorista').value = data.cantidad_mayorista || 6;
                document.getElementById('validezCotizacion').value = data.validez_cotizacion_dias || 30;
                document.getElementById('stockMinimo').value = data.stock_minimo_default || 5;
                document.getElementById('versionSistema').value = data.version || '1.0';
                
                // Logo
                const logoPreview = document.getElementById('logoPreview');
                if (data.logo_empresa) {
                    logoPreview.innerHTML = `<img src="${data.logo_empresa}" alt="Logo de la empresa">`;
                } else {
                    logoPreview.innerHTML = '';
                }
            }
            
            async function loadParametros() {
                try {
                    let parametros = null;
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('parametros', 'select', { select: '*' });
                        parametros = result.data && result.data.length > 0 ? result.data[0] : null;
                    } else {
                        const stored = await getOffline('parametros');
                        parametros = stored.length > 0 ? stored[0] : null;
                    }
                    
                    parametrosData = parametros;
                    fillParametrosForm(parametros);
                    
                } catch (error) {
                    console.error('Error cargando parmetros:', error);
                    // Usar valores por defecto
                    fillParametrosForm(null);
                }
            }
            
            async function loadZonas() {
                try {
                    let zonas = [];
                    
                    if (isOnline() && supabase) {
                        const result = await executeQuery('zonas', 'select', { select: '*' });
                        zonas = result.data || [];
                    } else {
                        zonas = await getOffline('zonas');
                    }
                    
                    // Si no hay zonas, crear zonas por defecto
                    if (zonas.length === 0) {
                        const zonasDefault = [
                            { id: 'zona1', nombre: 'Centro', activa: true },
                            { id: 'zona2', nombre: 'Norte', activa: true },
                            { id: 'zona3', nombre: 'Sur', activa: true },
                            { id: 'zona4', nombre: 'Oriente', activa: true },
                            { id: 'zona5', nombre: 'Occidente', activa: true }
                        ];
                        
                        for (const zona of zonasDefault) {
                            try {
                                await executeQuery('zonas', 'insert', [{ 
                                    ...zona, 
                                    fecha_creacion: new Date().toISOString() 
                                }]);
                            } catch (err) {
                                console.log('Zona ya existe:', zona.id);
                            }
                        }
                        
                        zonas = zonasDefault;
                    }
                    
                    zonasList = zonas.sort((a, b) => a.id.localeCompare(b.id));
                    renderZonas();
                    
                } catch (error) {
                    console.error('Error cargando zonas:', error);
                    showNotification('Error al cargar zonas', 'error');
                }
            }
            
            function renderZonas() {
                const container = document.getElementById('zonasGrid');
                
                if (zonasList.length === 0) {
                    container.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #6b7280;">
                            <div style="font-size: 48px; margin-bottom: 10px;"></div>
                            <h3>No hay zonas configuradas</h3>
                            <p>Agregue la primera zona usando el formulario de arriba</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = zonasList.map(zona => `
                    <div class="zona-card ${zona.activa ? '' : 'inactive'}">
                        <div class="zona-header">
                            <div>
                                <div class="zona-id">${zona.id}</div>
                                <div class="zona-nombre">${zona.nombre}</div>
                                <div class="zona-status">
                                    <div class="status-dot-zona ${zona.activa ? '' : 'inactive'}"></div>
                                    <span>${zona.activa ? 'Activa' : 'Inactiva'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="zona-actions">
                            <button class="btn-zona btn-zona-edit" onclick="editZona('${zona.id}')">
                                 Editar
                            </button>
                            <button class="btn-zona btn-zona-toggle" onclick="toggleZona('${zona.id}')">
                                ${zona.activa ? ' Desactivar' : ' Activar'}
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            function showSaveLoading(show) {
                const btn = document.getElementById('btnSaveParametros');
                const text = btn.querySelector('.btn-text');
                const loading = btn.querySelector('.loading');
                
                if (show) {
                    text.style.display = 'none';
                    loading.style.display = 'inline-block';
                    btn.disabled = true;
                } else {
                    text.style.display = 'inline';
                    loading.style.display = 'none';
                    btn.disabled = false;
                }
            }
            
            // Detectar cambios en formularios
            function detectChanges() {
                const inputs = document.querySelectorAll('#tabEmpresa input, #tabConfiguracion input');
                inputs.forEach(input => {
                    input.addEventListener('change', () => {
                        hasChanges = true;
                    });
                });
            }
            
            // Advertir sobre cambios no guardados
            window.addEventListener('beforeunload', function(e) {
                if (hasChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
            
            // Sugerir prximo ID de zona
            function suggestNextZonaId() {
                const existingNumbers = zonasList
                    .map(z => parseInt(z.id.replace('zona', '')))
                    .filter(n => !isNaN(n))
                    .sort((a, b) => a - b);
                
                let nextNumber = 1;
                for (const num of existingNumbers) {
                    if (num === nextNumber) {
                        nextNumber++;
                    } else {
                        break;
                    }
                }
                
                document.getElementById('nuevaZonaId').placeholder = `ID (ej: zona${nextNumber})`;
            }
            
            // Inicializar mdulo
            await loadParametros();
            await loadZonas();
            detectChanges();
            suggestNextZonaId();
            
            registerAction('Acceso mdulo parmetros', 'sistema', 'parametros', 'Usuario accedi al mdulo de parmetros');
        }
        
        async function showInformes() {
            showContentArea('Informes', 'Funcin en desarrollo - Reportes y estadsticas');
        }

        // ============================================
        // FUNCIONES DE UTILIDAD SUPABASE
        // ============================================
        
        async function executeQuery(table, action, data) {
            try {
                if (!isOnlineStatus || !supabase) {
                    // Guardar para sincronizacin posterior
                    await saveOffline(table, { action, data, timestamp: new Date().toISOString() });
                    return { success: true, offline: true };
                }
                
                let result;
                
                switch (action) {
                    case 'select':
                        result = await supabase.from(table).select(data.select || '*');
                        break;
                    case 'insert':
                        result = await supabase.from(table).insert(data);
                        break;
                    case 'update':
                        result = await supabase.from(table).update(data.updates).eq(data.where.column, data.where.value);
                        break;
                    case 'delete':
                        result = await supabase.from(table).delete().eq(data.column, data.value);
                        break;
                    default:
                        throw new Error('Accin no vlida');
                }
                
                if (result.error) throw result.error;
                
                return { success: true, data: result.data };
                
            } catch (error) {
                console.error('Error en executeQuery:', error);
                throw error;
            }
        }
        
        async function syncToCloud() {
            if (!isOnlineStatus || !supabase) return false;
            
            try {
                const pendingSync = await getOffline('sync_pending');
                let syncCount = 0;
                
                for (const item of pendingSync) {
                    try {
                        await executeQuery(item.table, item.action, item.data);
                        await removeFromOfflineSync(item.id);
                        syncCount++;
                    } catch (error) {
                        console.error('Error sincronizando item:', error);
                    }
                }
                
                if (syncCount > 0) {
                    showNotification(`${syncCount} registros sincronizados exitosamente`, 'success');
                    updateLastSync();
                }
                
                return true;
                
            } catch (error) {
                console.error('Error en sincronizacin:', error);
                showNotification('Error al sincronizar datos', 'error');
                return false;
            }
        }
        
        async function syncFromCloud() {
            if (!isOnlineStatus || !supabase) return false;
            
            try {
                // Sincronizar tablas principales
                const tables = ['parametros', 'zonas', 'clientes', 'productos'];
                
                for (const table of tables) {
                    const { data } = await supabase.from(table).select('*');
                    if (data) {
                        await saveOffline(table, data);
                    }
                }
                
                updateLastSync();
                return true;
                
            } catch (error) {
                console.error('Error descargando datos:', error);
                return false;
            }
        }

        // ============================================
        // FUNCIONES DE UTILIDAD GENERALES
        // ============================================
        
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }
        
        function formatCurrency(amount) {
            if (typeof amount !== 'number') amount = parseFloat(amount) || 0;
            return new Intl.NumberFormat('es-CO', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        
        function formatDate(date) {
            if (!date) return '--/--/----';
            const d = new Date(date);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        async function generateConsecutivo() {
            const year = new Date().getFullYear();
            
            try {
                if (isOnlineStatus && supabase) {
                    // Usar funcin PostgreSQL
                    const { data, error } = await supabase
                        .rpc('generar_consecutivo_cotizacion', { ao_param: year });
                    
                    if (error) throw error;
                    return data;
                } else {
                    // Generar consecutivo offline
                    const lastConsec = localStorage.getItem(`consecutivo_${year}`) || '0';
                    const newConsec = parseInt(lastConsec) + 1;
                    localStorage.setItem(`consecutivo_${year}`, newConsec.toString());
                    return `COT-${year}-${String(newConsec).padStart(3, '0')}`;
                }
                
            } catch (error) {
                console.error('Error generando consecutivo:', error);
                return `COT-${year}-ERR`;
            }
        }
        
        function isOnline() {
            return isOnlineStatus;
        }

        // ============================================
        // FUNCIONES INDEXEDDB (OFFLINE)
        // ============================================
        
        async function initIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('CotizacionesDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    // Crear stores para cada tabla
                    const stores = ['clientes', 'productos', 'entradas', 'cotizaciones', 'parametros', 'zonas', 'sync_pending'];
                    
                    stores.forEach(storeName => {
                        if (!db.objectStoreNames.contains(storeName)) {
                            const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                            store.createIndex('timestamp', 'timestamp', { unique: false });
                        }
                    });
                };
            });
        }
        
        async function saveOffline(table, data) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([table], 'readwrite');
                const store = transaction.objectStore(table);
                
                const dataWithTimestamp = {
                    ...data,
                    timestamp: new Date().toISOString(),
                    synced: false
                };
                
                const request = store.add(dataWithTimestamp);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function getOffline(table) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([table], 'readonly');
                const store = transaction.objectStore(table);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function removeFromOfflineSync(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['sync_pending'], 'readwrite');
                const store = transaction.objectStore('sync_pending');
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // ============================================
        // FUNCIONES DE CONECTIVIDAD
        // ============================================
        
        function setupConnectivityEvents() {
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
        }
        
        async function handleOnline() {
            isOnlineStatus = true;
            updateConnectionStatus();
            showNotification('Conexin restablecida', 'success');
            
            // Intentar sincronizacin automtica
            await syncToCloud();
            await syncFromCloud();
        }
        
        function handleOffline() {
            isOnlineStatus = false;
            updateConnectionStatus();
            showNotification('Modo offline activado', 'warning');
        }
        
        function updateConnectionStatus() {
            const dot = document.getElementById('connectionDot');
            const status = document.getElementById('connectionStatus');
            
            if (isOnlineStatus) {
                dot.classList.remove('offline');
                status.textContent = 'En lnea';
            } else {
                dot.classList.add('offline');
                status.textContent = 'Sin conexin';
            }
        }
        
        function updateLastSync() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-CO', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            document.getElementById('lastSync').textContent = `ltima sincronizacin: ${timeString}`;
            localStorage.setItem('lastSync', now.toISOString());
        }

        // ============================================
        // FUNCIONES DE SOPORTE
        // ============================================
        
        async function registerAction(action, table, id, detail) {
            try {
                const logEntry = {
                    usuario: currentUser?.username || 'system',
                    accion: action,
                    tabla: table,
                    registro_id: id?.toString() || '',
                    detalle: detail || '',
                    fecha_hora: new Date().toISOString()
                };
                
                if (isOnlineStatus && supabase) {
                    await supabase.from('historial').insert([logEntry]);
                } else {
                    await saveOffline('historial', logEntry);
                }
                
            } catch (error) {
                console.error('Error registrando accin:', error);
            }
        }
        
        function showContentArea(title, content) {
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('contentArea').style.display = 'block';
            document.getElementById('contentTitle').textContent = title;
            document.getElementById('contentBody').innerHTML = `
                <div style="text-align: center; padding: 50px; color: #6b7280;">
                    <div style="font-size: 48px; margin-bottom: 20px;"></div>
                    <h3 style="margin-bottom: 10px; color: #374151;">Mdulo en Desarrollo</h3>
                    <p>${content}</p>
                    <p style="margin-top: 20px; font-size: 14px;">
                        Para continuar el desarrollo, use el comando:<br>
                        <code style="background: #f3f4f6; padding: 4px 8px; border-radius: 4px; color: #2563eb;">
                            "Desarrollar funcin show${title}()"
                        </code>
                    </p>
                </div>
            `;
        }
        
        function setupLoginForm() {
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await validateLogin();
            });
        }
        
        function showLoading(show) {
            const btn = document.getElementById('loginBtn');
            const text = btn.querySelector('.btn-text');
            const loading = btn.querySelector('.loading');
            
            if (show) {
                text.style.display = 'none';
                loading.style.display = 'inline-block';
                btn.disabled = true;
            } else {
                text.style.display = 'inline';
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }
        
        function checkExistingSession() {
            const savedUser = localStorage.getItem('currentUser');
            const loginTime = localStorage.getItem('loginTime');
            
            if (savedUser && loginTime) {
                const sessionAge = Date.now() - new Date(loginTime).getTime();
                const maxAge = 60 * 60 * 1000; // 60 minutos
                
                if (sessionAge < maxAge) {
                    currentUser = JSON.parse(savedUser);
                    showMenu();
                } else {
                    logout();
                }
            }
        }
        
        // ============================================
        // FUNCIONES EXPORTADAS PARA PRXIMOS CHATS
        // ============================================
        
        /*
        LISTA DE FUNCIONES CREADAS PARA CONTINUAR EN PRXIMOS CHATS:

        AUTENTICACIN:
        - validateLogin()
        - showMenu()
        - logout()
        - registerAction()

        NAVEGACIN (MDULOS A DESARROLLAR):
        - showClientes()      ?Desarrollar primero
        - showProductos()     ?Segundo
        - showEntradas()      ?Tercero
        - showCotizaciones()  ?Cuarto
        - showParametros()    ?Quinto
        - showInformes()      ?Sexto

        UTILIDADES SUPABASE:
        - executeQuery()
        - syncToCloud()
        - syncFromCloud()

        UTILIDADES GENERALES:
        - showNotification()
        - formatCurrency()
        - formatDate()
        - generateConsecutivo()
        - isOnline()

        INDEXEDDB OFFLINE:
        - initIndexedDB()
        - saveOffline()
        - getOffline()

        Para continuar en prximos chats, usar:
        "Desarrollar funcin showClientes()" (o cualquier funcin de la lista)
        */
        
    </script>
</body>
</html>